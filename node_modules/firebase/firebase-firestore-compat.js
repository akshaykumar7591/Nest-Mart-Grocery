!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("@firebase/app-compat"),require("@firebase/app")):"function"==typeof define&&define.amd?define(["@firebase/app-compat","@firebase/app"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).firebase,e.firebase.INTERNAL.modularAPIs)}(this,function(em,tm){"use strict";try{!(function(){function e(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var l,t=e(em);function n(t){const n=[];let r=0;for(let i=0;i<t.length;i++){let e=t.charCodeAt(i);e<128?n[r++]=e:(e<2048?n[r++]=e>>6|192:(55296==(64512&e)&&i+1<t.length&&56320==(64512&t.charCodeAt(i+1))?(e=65536+((1023&e)<<10)+(1023&t.charCodeAt(++i)),n[r++]=e>>18|240,n[r++]=e>>12&63|128):n[r++]=e>>12|224,n[r++]=e>>6&63|128),n[r++]=63&e|128)}return n}const r={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(n,e){if(!Array.isArray(n))throw Error("encodeByteArray takes an array as a parameter");this.init_();var r=e?this.byteToCharMapWebSafe_:this.byteToCharMap_;const i=[];for(let h=0;h<n.length;h+=3){var s=n[h],a=h+1<n.length,o=a?n[h+1]:0,u=h+2<n.length,c=u?n[h+2]:0;let e=(15&o)<<2|c>>6,t=63&c;u||(t=64,a||(e=64)),i.push(r[s>>2],r[(3&s)<<4|o>>4],r[e],r[t])}return i.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(n(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):function(e){const t=[];let n=0,r=0;for(;n<e.length;){var i,s,a=e[n++];a<128?t[r++]=String.fromCharCode(a):191<a&&a<224?(i=e[n++],t[r++]=String.fromCharCode((31&a)<<6|63&i)):239<a&&a<365?(s=((7&a)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536,t[r++]=String.fromCharCode(55296+(s>>10)),t[r++]=String.fromCharCode(56320+(1023&s))):(i=e[n++],s=e[n++],t[r++]=String.fromCharCode((15&a)<<12|(63&i)<<6|63&s))}return t.join("")}(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();var n=t?this.charToByteMapWebSafe_:this.charToByteMap_;const r=[];for(let u=0;u<e.length;){var i=n[e.charAt(u++)],s=u<e.length?n[e.charAt(u)]:0;++u;var a=u<e.length?n[e.charAt(u)]:64;++u;var o=u<e.length?n[e.charAt(u)]:64;if(++u,null==i||null==s||null==a||null==o)throw new c;r.push(i<<2|s>>4),64!==a&&(r.push(s<<4&240|a>>2),64!==o&&r.push(a<<6&192|o))}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}};class c extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const o=function(e){return e=e,t=n(e),r.encodeByteArray(t,!0).replace(/\./g,"");var t};const i=()=>function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("Unable to locate global object.")}().__FIREBASE_DEFAULTS__,s=()=>{if("undefined"!=typeof document){let e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(e){return}var t=e&&function(e){try{return r.decodeString(e,!0)}catch(e){console.error("base64Decode failed: ",e)}return null}(e[1]);return t&&JSON.parse(t)}},a=()=>{try{return i()||(()=>{if("undefined"!=typeof process&&void 0!==process.env){var e=process.env.__FIREBASE_DEFAULTS__;return e?JSON.parse(e):void 0}})()||s()}catch(e){return void console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${e}`)}};function u(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function h(){return!function(){var e=null===(e=a())||void 0===e?void 0:e.forceEnvironment;if("node"===e)return 1;if("browser"!==e)try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(e){return}}()&&navigator.userAgent&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}class d extends Error{constructor(e,t,n){super(t),this.code=e,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,d.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,f.prototype.create)}}class f{constructor(e,t,n){this.service=e,this.serviceName=t,this.errors=n}create(e,...t){var r,n=t[0]||{},i=`${this.service}/${e}`,s=this.errors[e],s=s?(r=n,s.replace(g,(e,t)=>{var n=r[t];return null!=n?String(n):`<${t}?>`})):"Error",s=`${this.serviceName}: ${s} (${i}).`;return new d(i,s,n)}}const g=/\{\$([^}]+)}/g;function m(e,t){if(e===t)return!0;const n=Object.keys(e),r=Object.keys(t);for(const a of n){if(!r.includes(a))return!1;var i=e[a],s=t[a];if(p(i)&&p(s)){if(!m(i,s))return!1}else if(i!==s)return!1}for(const o of r)if(!n.includes(o))return!1;return!0}function p(e){return null!==e&&"object"==typeof e}function y(e){return e&&e._delegate?e._delegate:e}class v{constructor(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}(tf=l=l||{})[tf.DEBUG=0]="DEBUG",tf[tf.VERBOSE=1]="VERBOSE",tf[tf.INFO=2]="INFO",tf[tf.WARN=3]="WARN",tf[tf.ERROR=4]="ERROR",tf[tf.SILENT=5]="SILENT";const w={debug:l.DEBUG,verbose:l.VERBOSE,info:l.INFO,warn:l.WARN,error:l.ERROR,silent:l.SILENT},_=l.INFO,b={[l.DEBUG]:"log",[l.VERBOSE]:"log",[l.INFO]:"info",[l.WARN]:"warn",[l.ERROR]:"error"},I=(e,t,...n)=>{if(!(t<e.logLevel)){var r=(new Date).toISOString(),i=b[t];if(!i)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[i](`[${r}]  ${e.name}:`,...n)}};var E,T="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},S={},x=T||self;function D(e){var t=typeof e;return"array"==(t="object"!=t?t:e?Array.isArray(e)?"array":t:"null")||"object"==t&&"number"==typeof e.length}function C(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}var A="closure_uid_"+(1e9*Math.random()>>>0),N=0;function k(e,t,n){return e.call.apply(e.bind,arguments)}function R(t,n,e){if(!t)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var e=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(e,r),t.apply(n,e)}}return function(){return t.apply(n,arguments)}}function M(e,t,n){return(M=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?k:R).apply(null,arguments)}function L(t){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function F(e,s){function t(){}t.prototype=s.prototype,e.$=s.prototype,e.prototype=new t,(e.prototype.constructor=e).ac=function(e,t,n){for(var r=Array(arguments.length-2),i=2;i<arguments.length;i++)r[i-2]=arguments[i];return s.prototype[t].apply(e,r)}}function O(){this.s=this.s,this.o=this.o}O.prototype.s=!1,O.prototype.sa=function(){var e;!this.s&&(this.s=!0,this.N(),0)&&(e=this,Object.prototype.hasOwnProperty.call(e,A)&&e[A]||(e[A]=++N))},O.prototype.N=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const P=Array.prototype.indexOf?function(e,t){return Array.prototype.indexOf.call(e,t,void 0)}:function(e,t){if("string"==typeof e)return"string"!=typeof t||1!=t.length?-1:e.indexOf(t,0);for(let n=0;n<e.length;n++)if(n in e&&e[n]===t)return n;return-1};function V(t){var n=t.length;if(0<n){const r=Array(n);for(let e=0;e<n;e++)r[e]=t[e];return r}return[]}function B(t){for(let e=1;e<arguments.length;e++){var n=arguments[e];if(D(n)){var r=t.length||0,i=n.length||0;t.length=r+i;for(let e=0;e<i;e++)t[r+e]=n[e]}else t.push(n)}}function q(e,t){this.type=e,this.g=this.target=t,this.defaultPrevented=!1}q.prototype.h=function(){this.defaultPrevented=!0};var U=function(){if(!x.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});try{var n=()=>{};x.addEventListener("test",n,t),x.removeEventListener("test",n,t)}catch(e){}return e}();function j(e){return/^[\s\xa0]*$/.test(e)}function z(){var e=x.navigator;return(e=e&&e.userAgent)?e:""}function G(e){return-1!=z().indexOf(e)}function K(e){return K[" "](e),e}K[" "]=function(){};var $,Q=G("Opera"),H=G("Trident")||G("MSIE"),W=G("Edge"),J=W||H,Y=G("Gecko")&&!(-1!=z().toLowerCase().indexOf("webkit")&&!G("Edge"))&&!(G("Trident")||G("MSIE"))&&!G("Edge"),X=-1!=z().toLowerCase().indexOf("webkit")&&!G("Edge");function Z(){var e=x.document;return e?e.documentMode:void 0}e:{var ee="",te=(te=z(),Y?/rv:([^\);]+)(\)|;)/.exec(te):W?/Edge\/([\d\.]+)/.exec(te):H?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(te):X?/WebKit\/(\S+)/.exec(te):Q?/(?:Version)[ \/]?(\S+)/.exec(te):void 0);if(te&&(ee=te?te[1]:""),H){te=Z();if(null!=te&&te>parseFloat(ee)){$=String(te);break e}}$=ee}var ne=x.document&&H&&(Z()||parseInt($,10))||void 0;function re(e,t){if(q.call(this,e?e.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,e){var n=this.type=e.type,r=e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:null;if(this.target=e.target||e.srcElement,this.g=t,t=e.relatedTarget){if(Y){e:{try{K(t.nodeName);var i=!0;break e}catch(e){}i=!1}i||(t=null)}}else"mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement);this.relatedTarget=t,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0),this.button=e.button,this.key=e.key||"",this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType="string"==typeof e.pointerType?e.pointerType:ie[e.pointerType]||"",this.state=e.state,(this.i=e).defaultPrevented&&re.$.h.call(this)}}F(re,q);var ie={2:"touch",3:"pen",4:"mouse"};re.prototype.h=function(){re.$.h.call(this);var e=this.i;e.preventDefault?e.preventDefault():e.returnValue=!1};var se="closure_listenable_"+(1e6*Math.random()|0),ae=0;function oe(e,t,n,r,i){this.listener=e,this.proxy=null,this.src=t,this.type=n,this.capture=!!r,this.la=i,this.key=++ae,this.fa=this.ia=!1}function ue(e){e.fa=!0,e.listener=null,e.proxy=null,e.src=null,e.la=null}function ce(e,t,n){for(const r in e)t.call(n,e[r],r,e)}function he(e){const t={};for(const n in e)t[n]=e[n];return t}const le="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function de(t){let n,r;for(let i=1;i<arguments.length;i++){for(n in r=arguments[i])t[n]=r[n];for(let e=0;e<le.length;e++)n=le[e],Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}}function fe(e){this.src=e,this.g={},this.h=0}function ge(e,t){var n,r,i,s=t.type;s in e.g&&(n=e.g[s],(i=0<=(r=P(n,t)))&&Array.prototype.splice.call(n,r,1),i&&(ue(t),0==e.g[s].length&&(delete e.g[s],e.h--)))}function me(e,t,n,r){for(var i=0;i<e.length;++i){var s=e[i];if(!s.fa&&s.listener==t&&s.capture==!!n&&s.la==r)return i}return-1}fe.prototype.add=function(e,t,n,r,i){var s=e.toString();(e=this.g[s])||(e=this.g[s]=[],this.h++);var a=me(e,t,r,i);return-1<a?(t=e[a],n||(t.ia=!1)):((t=new oe(t,this.src,s,!!r,i)).ia=n,e.push(t)),t};var pe="closure_lm_"+(1e6*Math.random()|0),ye={};function ve(e,t,n,r,i){if(r&&r.once)return function e(t,n,r,i,s){if(Array.isArray(n)){for(var a=0;a<n.length;a++)e(t,n[a],r,i,s);return null}r=Se(r);return t&&t[se]?t.P(n,r,C(i)?!!i.capture:!!i,s):we(t,n,r,!0,i,s)}(e,t,n,r,i);if(Array.isArray(t)){for(var s=0;s<t.length;s++)ve(e,t[s],n,r,i);return null}return n=Se(n),e&&e[se]?e.O(t,n,C(r)?!!r.capture:!!r,i):we(e,t,n,!1,r,i)}function we(e,t,n,r,i,s){if(!t)throw Error("Invalid event type");var a=C(i)?!!i.capture:!!i,o=Ee(e);if(o||(e[pe]=o=new fe(e)),(n=o.add(t,n,r,a,s)).proxy)return n;if(r=function(){const n=Ie;return function e(t){return n.call(e.src,e.listener,t)}}(),(n.proxy=r).src=e,r.listener=n,e.addEventListener)void 0===(i=!U?a:i)&&(i=!1),e.addEventListener(t.toString(),r,i);else if(e.attachEvent)e.attachEvent(be(t.toString()),r);else{if(!e.addListener||!e.removeListener)throw Error("addEventListener and attachEvent are unavailable.");e.addListener(r)}return n}function _e(e){var t,n,r;"number"!=typeof e&&e&&!e.fa&&((t=e.src)&&t[se]?ge(t.i,e):(n=e.type,r=e.proxy,t.removeEventListener?t.removeEventListener(n,r,e.capture):t.detachEvent?t.detachEvent(be(n),r):t.addListener&&t.removeListener&&t.removeListener(r),(n=Ee(t))?(ge(n,e),0==n.h&&(n.src=null,t[pe]=null)):ue(e)))}function be(e){return e in ye?ye[e]:ye[e]="on"+e}function Ie(e,t){var n,r;return e=!!e.fa||(t=new re(t,this),n=e.listener,r=e.la||e.src,e.ia&&_e(e),n.call(r,t))}function Ee(e){return(e=e[pe])instanceof fe?e:null}var Te="__closure_events_fn_"+(1e9*Math.random()>>>0);function Se(t){return"function"==typeof t?t:(t[Te]||(t[Te]=function(e){return t.handleEvent(e)}),t[Te])}function xe(){O.call(this),this.i=new fe(this),(this.S=this).J=null}function De(e,t){var n,r=e.J;if(r)for(n=[];r;r=r.J)n.push(r);if(e=e.S,r=t.type||t,"string"==typeof t?t=new q(t,e):t instanceof q?t.target=t.target||e:(a=t,de(t=new q(r,e),a)),a=!0,n)for(var i=n.length-1;0<=i;i--)var s=t.g=n[i],a=Ce(s,r,!0,t)&&a;if(a=Ce(s=t.g=e,r,!0,t)&&a,a=Ce(s,r,!1,t)&&a,n)for(i=0;i<n.length;i++)a=Ce(s=t.g=n[i],r,!1,t)&&a}function Ce(e,t,n,r){if(!(t=e.i.g[String(t)]))return!0;t=t.concat();for(var i=!0,s=0;s<t.length;++s){var a,o,u=t[s];u&&!u.fa&&u.capture==n&&(a=u.listener,o=u.la||u.src,u.ia&&ge(e.i,u),i=!1!==a.call(o,r)&&i)}return i&&!r.defaultPrevented}F(xe,O),xe.prototype[se]=!0,xe.prototype.removeEventListener=function(e,t,n,r){!function e(t,n,r,i,s){if(Array.isArray(n))for(var a=0;a<n.length;a++)e(t,n[a],r,i,s);else i=C(i)?!!i.capture:!!i,r=Se(r),t&&t[se]?(t=t.i,(n=String(n).toString())in t.g&&-1<(r=me(a=t.g[n],r,i,s))&&(ue(a[r]),Array.prototype.splice.call(a,r,1),0==a.length&&(delete t.g[n],t.h--))):(t=t&&Ee(t))&&(n=t.g[n.toString()],(r=(t=-1)<(t=n?me(n,r,i,s):t)?n[t]:null)&&_e(r))}(this,e,t,n,r)},xe.prototype.N=function(){if(xe.$.N.call(this),this.i){var e,t=this.i;for(e in t.g){for(var n=t.g[e],r=0;r<n.length;r++)ue(n[r]);delete t.g[e],t.h--}}this.J=null},xe.prototype.O=function(e,t,n,r){return this.i.add(String(e),t,!1,n,r)},xe.prototype.P=function(e,t,n,r){return this.i.add(String(e),t,!0,n,r)};var Ae=x.JSON.stringify;var Ne=new class{constructor(e,t){this.i=e,this.j=t,this.h=0,this.g=null}get(){let e;return 0<this.h?(this.h--,e=this.g,this.g=e.next,e.next=null):e=this.i(),e}}(()=>new ke,e=>e.reset());class ke{constructor(){this.next=this.g=this.h=null}set(e,t){this.h=e,this.g=t,this.next=null}reset(){this.next=this.g=this.h=null}}let Re,Me=!1,Le=new class{constructor(){this.h=this.g=null}add(e,t){const n=Ne.get();n.set(e,t),this.h?this.h.next=n:this.g=n,this.h=n}},Fe=()=>{const e=x.Promise.resolve(void 0);Re=()=>{e.then(Oe)}};var Oe=()=>{for(var e;e=function(){var e=Le;let t=null;return e.g&&(t=e.g,e.g=e.g.next,e.g||(e.h=null),t.next=null),t}();){try{e.h.call(e.g)}catch(e){!function(e){x.setTimeout(()=>{throw e},0)}(e)}var t=Ne;t.j(e),t.h<100&&(t.h++,e.next=t.g,t.g=e)}Me=!1};function Pe(e,t){xe.call(this),this.h=e||1,this.g=t||x,this.j=M(this.qb,this),this.l=Date.now()}function Ve(e){e.ga=!1,e.T&&(e.g.clearTimeout(e.T),e.T=null)}function Be(e,t,n){if("function"==typeof e)n&&(e=M(e,n));else{if(!e||"function"!=typeof e.handleEvent)throw Error("Invalid listener argument");e=M(e.handleEvent,e)}return 2147483647<Number(t)?-1:x.setTimeout(e,t||0)}F(Pe,xe),(E=Pe.prototype).ga=!1,E.T=null,E.qb=function(){var e;this.ga&&(0<(e=Date.now()-this.l)&&e<.8*this.h?this.T=this.g.setTimeout(this.j,this.h-e):(this.T&&(this.g.clearTimeout(this.T),this.T=null),De(this,"tick"),this.ga&&(Ve(this),this.start())))},E.start=function(){this.ga=!0,this.T||(this.T=this.g.setTimeout(this.j,this.h),this.l=Date.now())},E.N=function(){Pe.$.N.call(this),Ve(this),delete this.g};class qe extends O{constructor(e,t){super(),this.m=e,this.j=t,this.h=null,this.i=!1,this.g=null}l(e){this.h=arguments,this.g?this.i=!0:function e(t){t.g=Be(()=>{t.g=null,t.i&&(t.i=!1,e(t))},t.j);var n=t.h;t.h=null,t.m.apply(null,n)}(this)}N(){super.N(),this.g&&(x.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function Ue(e){O.call(this),this.h=e,this.g={}}F(Ue,O);var je=[];function ze(e,t,n,r){Array.isArray(n)||(n&&(je[0]=n.toString()),n=je);for(var i=0;i<n.length;i++){var s=ve(t,n[i],r||e.handleEvent,!1,e.h||e);if(!s)break;e.g[s.key]=s}}function Ge(e){ce(e.g,function(e,t){this.g.hasOwnProperty(t)&&_e(e)},e),e.g={}}function Ke(){this.g=!0}function $e(e,t,n,r){e.info(function(){return"XMLHTTP TEXT ("+t+"): "+function(e,t){if(!e.g)return t;if(!t)return null;try{var n=JSON.parse(t);if(n)for(e=0;e<n.length;e++)if(Array.isArray(n[e])){var r=n[e];if(!(r.length<2)){var i=r[1];if(Array.isArray(i)&&!(i.length<1)){var s=i[0];if("noop"!=s&&"stop"!=s&&"close"!=s)for(var a=1;a<i.length;a++)i[a]=""}}}return Ae(n)}catch(e){return t}}(e,n)+(r?" "+r:"")})}Ue.prototype.N=function(){Ue.$.N.call(this),Ge(this)},Ue.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},Ke.prototype.Ea=function(){this.g=!1},Ke.prototype.info=function(){};var Qe={},He=null;function We(){return He=He||new xe}function Je(e){q.call(this,Qe.Ta,e)}function Ye(){var e=We();De(e,new Je(e))}function Xe(e,t){q.call(this,Qe.STAT_EVENT,e),this.stat=t}function Ze(e){var t=We();De(t,new Xe(t,e))}function et(e,t){q.call(this,Qe.Ua,e),this.size=t}function tt(e,t){if("function"!=typeof e)throw Error("Fn must not be null and must be a function");return x.setTimeout(function(){e()},t)}Qe.Ta="serverreachability",F(Je,q),Qe.STAT_EVENT="statevent",F(Xe,q),Qe.Ua="timingevent",F(et,q);var nt={NO_ERROR:0,rb:1,Eb:2,Db:3,yb:4,Cb:5,Fb:6,Qa:7,TIMEOUT:8,Ib:9},rt={wb:"complete",Sb:"success",Ra:"error",Qa:"abort",Kb:"ready",Lb:"readystatechange",TIMEOUT:"timeout",Gb:"incrementaldata",Jb:"progress",zb:"downloadprogress",$b:"uploadprogress"};function it(){}function st(e){return e.h||(e.h=e.i())}function at(){}it.prototype.h=null;T={OPEN:"a",vb:"b",Ra:"c",Hb:"d"};function ot(){q.call(this,"d")}function ut(){q.call(this,"c")}function ct(){}function ht(e,t,n,r){this.l=e,this.j=t,this.m=n,this.W=r||1,this.U=new Ue(this),this.P=ft,this.V=new Pe(e=J?125:void 0),this.I=null,this.i=!1,this.u=this.B=this.A=this.L=this.G=this.Y=this.C=null,this.F=[],this.g=null,this.o=0,this.s=this.v=null,this.ca=-1,this.J=!1,this.O=0,this.M=null,this.ba=this.K=this.aa=this.S=!1,this.h=new lt}function lt(){this.i=null,this.g="",this.h=!1}F(ot,q),F(ut,q),F(ct,it),ct.prototype.g=function(){return new XMLHttpRequest},ct.prototype.i=function(){return{}};var dt=new ct,ft=45e3,gt={},mt={};function pt(e,t,n){e.L=1,e.A=Lt(At(t)),e.u=n,e.S=!0,yt(e,null)}function yt(e,t){e.G=Date.now(),_t(e),e.B=At(e.A);var a,o,u,c,h,l,n=e.B,r=e.W;Array.isArray(r)||(r=[String(r)]),Qt(n.i,"t",r),e.o=0,n=e.l.J,e.h=new lt,e.g=Qn(e.l,n?t:null,!e.u),0<e.O&&(e.M=new qe(M(e.Pa,e,e.g),e.O)),ze(e.U,e.g,"readystatechange",e.nb),t=e.I?he(e.I):{},e.u?(e.v||(e.v="POST"),t["Content-Type"]="application/x-www-form-urlencoded",e.g.ha(e.B,e.v,e.u,t)):(e.v="GET",e.g.ha(e.B,e.v,null,t)),Ye(),a=e.j,o=e.v,u=e.B,c=e.m,h=e.W,l=e.u,a.info(function(){if(a.g)if(l)for(var e="",t=l.split("&"),n=0;n<t.length;n++){var r,i,s=t[n].split("=");1<s.length&&(r=s[0],s=s[1],e=2<=(i=r.split("_")).length&&"type"==i[1]?e+(r+"=")+s+"&":e+(r+"=redacted&"))}else e=null;else e=l;return"XMLHTTP REQ ("+c+") [attempt "+h+"]: "+o+"\n"+u+"\n"+e})}function vt(e){return e.g&&("GET"==e.v&&2!=e.L&&e.l.Ha)}function wt(e,t,n){let r=!0,i;for(;!e.J&&e.o<n.length;){if(a=n,u=o=void 0,o=(s=e).o,(i=-1==(u=a.indexOf("\n",o))?mt:(o=Number(a.substring(o,u)),isNaN(o)?gt:(u+=1)+o>a.length?mt:(a=a.slice(u,u+o),s.o=u+o,a)))==mt){4==t&&(e.s=4,Ze(14),r=!1),$e(e.j,e.m,null,"[Incomplete Response]");break}if(i==gt){e.s=4,Ze(15),$e(e.j,e.m,n,"[Invalid Chunk]"),r=!1;break}$e(e.j,e.m,i,null),St(e,i)}var s,a,o,u;vt(e)&&0!=e.o&&(e.h.g=e.h.g.slice(e.o),e.o=0),4!=t||0!=n.length||e.h.h||(e.s=1,Ze(16),r=!1),e.i=e.i&&r,r?0<n.length&&!e.ba&&(e.ba=!0,(t=e.l).g==e&&t.ca&&!t.M&&(t.l.info("Great, no buffering proxy detected. Bytes received: "+n.length),Bn(t),t.M=!0,Ze(11))):($e(e.j,e.m,n,"[Invalid Chunked Response]"),Tt(e),Et(e))}function _t(e){e.Y=Date.now()+e.P,bt(e,e.P)}function bt(e,t){if(null!=e.C)throw Error("WatchDog timer not null");e.C=tt(M(e.lb,e),t)}function It(e){e.C&&(x.clearTimeout(e.C),e.C=null)}function Et(e){0==e.l.H||e.J||jn(e.l,e)}function Tt(e){It(e);var t=e.M;t&&"function"==typeof t.sa&&t.sa(),e.M=null,Ve(e.V),Ge(e.U),e.g&&(t=e.g,e.g=null,t.abort(),t.sa())}function St(e,t){try{var n=e.l;if(0!=n.H&&(n.g==e||Zt(n.i,e)))if(!e.K&&Zt(n.i,e)&&3==n.H){try{var r=n.Ja.g.parse(t)}catch(e){r=null}if(Array.isArray(r)&&3==r.length){var i=r;if(0==i[0]){e:if(!n.u){if(n.g){if(!(n.g.G+3e3<e.G))break e;Un(n),kn(n)}Vn(n),Ze(18)}}else n.Fa=i[1],0<n.Fa-n.V&&i[2]<37500&&n.G&&0==n.A&&!n.v&&(n.v=tt(M(n.ib,n),6e3));if(Xt(n.i)<=1&&n.oa){try{n.oa()}catch(e){}n.oa=void 0}}else Gn(n,11)}else if(!e.K&&n.g!=e||Un(n),!j(t))for(i=n.Ja.g.parse(t),t=0;t<i.length;t++){var s=i[t];if(n.V=s[0],s=s[1],2==n.H)if("c"==s[0]){n.K=s[1],n.pa=s[2];var a=s[3];null!=a&&(n.ra=a,n.l.info("VER="+n.ra));var o=s[4];null!=o&&(n.Ga=o,n.l.info("SVER="+n.Ga));var u,c,h=s[5];null!=h&&"number"==typeof h&&0<h&&(r=1.5*h,n.L=r,n.l.info("backChannelRequestTimeoutMs_="+r)),r=n;const g=e.g;if(g){const m=g.g?g.g.getResponseHeader("X-Client-Wire-Protocol"):null;m&&((u=r.i).g||-1==m.indexOf("spdy")&&-1==m.indexOf("quic")&&-1==m.indexOf("h2")||(u.j=u.l,u.g=new Set,u.h&&(en(u,u.h),u.h=null))),!r.F||(c=g.g?g.g.getResponseHeader("X-HTTP-Session-Id"):null)&&(r.Da=c,Mt(r.I,r.F,c))}n.H=3,n.h&&n.h.Ba(),n.ca&&(n.S=Date.now()-e.G,n.l.info("Handshake RTT: "+n.S+"ms"));var l,d,f=e;(r=n).wa=$n(r,r.J?r.pa:null,r.Y),f.K?(tn(r.i,f),l=f,(d=r.L)&&l.setTimeout(d),l.C&&(It(l),_t(l)),r.g=f):Pn(r),0<n.j.length&&Mn(n)}else"stop"!=s[0]&&"close"!=s[0]||Gn(n,7);else 3==n.H&&("stop"==s[0]||"close"==s[0]?"stop"==s[0]?Gn(n,7):Nn(n):"noop"!=s[0]&&n.h&&n.h.Aa(s),n.A=0)}Ye()}catch(e){}}function xt(e,t){if(e.forEach&&"function"==typeof e.forEach)e.forEach(t,void 0);else if(D(e)||"string"==typeof e)Array.prototype.forEach.call(e,t,void 0);else for(var n=function(e){if(e.ta&&"function"==typeof e.ta)return e.ta();if(!e.Z||"function"!=typeof e.Z){if("undefined"!=typeof Map&&e instanceof Map)return Array.from(e.keys());if(!("undefined"!=typeof Set&&e instanceof Set)){if(D(e)||"string"==typeof e){var t=[];e=e.length;for(var n=0;n<e;n++)t.push(n);return t}t=[],n=0;for(const r in e)t[n++]=r;return t}}}(e),r=function(e){if(e.Z&&"function"==typeof e.Z)return e.Z();if("undefined"!=typeof Map&&e instanceof Map||"undefined"!=typeof Set&&e instanceof Set)return Array.from(e.values());if("string"==typeof e)return e.split("");if(D(e)){for(var t=[],n=e.length,r=0;r<n;r++)t.push(e[r]);return t}for(r in t=[],n=0,e)t[n++]=e[r];return t}(e),i=r.length,s=0;s<i;s++)t.call(void 0,r[s],n&&n[s],e)}(E=ht.prototype).setTimeout=function(e){this.P=e},E.nb=function(e){e=e.target;const t=this.M;t&&3==Tn(e)?t.l():this.Pa(e)},E.Pa=function(e){try{if(e==this.g)e:{var t=Tn(this.g),n=this.g.Ia();this.g.da();if(!(t<3)&&(3!=t||J||this.g&&(this.h.h||this.g.ja()||Sn(this.g)))){this.J||4!=t||7==n||Ye(),It(this);var r=this.g.da();this.ca=r;t:if(vt(this)){var i=Sn(this.g);e="";var s=i.length,a=4==Tn(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){Tt(this),Et(this);var o="";break t}this.h.i=new x.TextDecoder}for(n=0;n<s;n++)this.h.h=!0,e+=this.h.i.decode(i[n],{stream:a&&n==s-1});i.length=0,this.h.g+=e,this.o=0,o=this.h.g}else o=this.g.ja();if(this.i=200==r,l=this.j,d=this.v,f=this.B,g=this.m,m=this.W,p=t,y=r,l.info(function(){return"XMLHTTP RESP ("+g+") [ attempt "+m+"]: "+d+"\n"+f+"\n"+p+" "+y}),this.i){if(this.aa&&!this.K){t:{if(this.g){var u,c=this.g;if((u=c.g?c.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!j(u)){var h=u;break t}}h=null}if(!(r=h)){this.i=!1,this.s=3,Ze(12),Tt(this),Et(this);break e}$e(this.j,this.m,r,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,St(this,r)}this.S?(wt(this,t,o),J&&this.i&&3==t&&(ze(this.U,this.V,"tick",this.mb),this.V.start())):($e(this.j,this.m,o,null),St(this,o)),4==t&&Tt(this),this.i&&!this.J&&(4==t?jn(this.l,this):(this.i=!1,_t(this)))}else(function(e){const t={};e=(e.g&&2<=Tn(e)&&e.g.getAllResponseHeaders()||"").split("\r\n");for(let i=0;i<e.length;i++)if(!j(e[i])){var n=function(e){var t=1;e=e.split(":");const n=[];for(;0<t&&e.length;)n.push(e.shift()),t--;return e.length&&n.push(e.join(":")),n}(e[i]),r=n[0];if("string"==typeof(n=n[1])){n=n.trim();const s=t[r]||[];t[r]=s,s.push(n)}}!function(e,t){for(const n in e)t.call(void 0,e[n],n,e)}(t,function(e){return e.join(", ")})})(this.g),400==r&&0<o.indexOf("Unknown SID")?(this.s=3,Ze(12)):(this.s=0,Ze(13)),Tt(this),Et(this)}}}catch(e){}var l,d,f,g,m,p,y},E.mb=function(){var e,t;this.g&&(e=Tn(this.g),t=this.g.ja(),this.o<t.length&&(It(this),wt(this,e,t),this.i&&4!=e&&_t(this)))},E.cancel=function(){this.J=!0,Tt(this)},E.lb=function(){this.C=null;var e,t,n=Date.now();0<=n-this.Y?(e=this.j,t=this.B,e.info(function(){return"TIMEOUT: "+t}),2!=this.L&&(Ye(),Ze(17)),Tt(this),this.s=2,Et(this)):bt(this,this.Y-n)};var Dt=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function Ct(e){var t,n;this.g=this.s=this.j="",this.m=null,this.o=this.l="",this.h=!1,e instanceof Ct?(this.h=e.h,Nt(this,e.j),this.s=e.s,this.g=e.g,kt(this,e.m),this.l=e.l,t=e.i,(n=new zt).i=t.i,t.g&&(n.g=new Map(t.g),n.h=t.h),Rt(this,n),this.o=e.o):e&&(t=String(e).match(Dt))?(this.h=!1,Nt(this,t[1]||"",!0),this.s=Ft(t[2]||""),this.g=Ft(t[3]||"",!0),kt(this,t[4]),this.l=Ft(t[5]||"",!0),Rt(this,t[6]||"",!0),this.o=Ft(t[7]||"")):(this.h=!1,this.i=new zt(null,this.h))}function At(e){return new Ct(e)}function Nt(e,t,n){e.j=n?Ft(t,!0):t,e.j&&(e.j=e.j.replace(/:$/,""))}function kt(e,t){if(t){if(t=Number(t),isNaN(t)||t<0)throw Error("Bad port number "+t);e.m=t}else e.m=null}function Rt(e,t,n){var r,i;t instanceof zt?(e.i=t,r=e.i,(i=e.h)&&!r.j&&(Gt(r),r.i=null,r.g.forEach(function(e,t){var n=t.toLowerCase();t!=n&&(Kt(this,t),Qt(this,n,e))},r)),r.j=i):(n||(t=Ot(t,Ut)),e.i=new zt(t,e.h))}function Mt(e,t,n){e.i.set(t,n)}function Lt(e){return Mt(e,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),e}function Ft(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function Ot(e,t,n){return"string"==typeof e?(e=encodeURI(e).replace(t,Pt),e=n?e.replace(/%25([0-9a-fA-F]{2})/g,"%$1"):e):null}function Pt(e){return"%"+((e=e.charCodeAt(0))>>4&15).toString(16)+(15&e).toString(16)}Ct.prototype.toString=function(){var e=[],t=this.j;t&&e.push(Ot(t,Vt,!0),":");var n=this.g;return!n&&"file"!=t||(e.push("//"),(t=this.s)&&e.push(Ot(t,Vt,!0),"@"),e.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&e.push(":",String(n))),(n=this.l)&&(this.g&&"/"!=n.charAt(0)&&e.push("/"),e.push(Ot(n,"/"==n.charAt(0)?qt:Bt,!0))),(n=this.i.toString())&&e.push("?",n),(n=this.o)&&e.push("#",Ot(n,jt)),e.join("")};var Vt=/[#\/\?@]/g,Bt=/[#\?:]/g,qt=/[#\?]/g,Ut=/[#\?@]/g,jt=/#/g;function zt(e,t){this.h=this.g=null,this.i=e||null,this.j=!!t}function Gt(n){n.g||(n.g=new Map,n.h=0,n.i&&function(e,t){if(e){e=e.split("&");for(var n=0;n<e.length;n++){var r,i=e[n].indexOf("="),s=null;0<=i?(r=e[n].substring(0,i),s=e[n].substring(i+1)):r=e[n],t(r,s?decodeURIComponent(s.replace(/\+/g," ")):"")}}}(n.i,function(e,t){n.add(decodeURIComponent(e.replace(/\+/g," ")),t)}))}function Kt(e,t){Gt(e),t=Ht(e,t),e.g.has(t)&&(e.i=null,e.h-=e.g.get(t).length,e.g.delete(t))}function $t(e,t){return Gt(e),t=Ht(e,t),e.g.has(t)}function Qt(e,t,n){Kt(e,t),0<n.length&&(e.i=null,e.g.set(Ht(e,t),V(n)),e.h+=n.length)}function Ht(e,t){return t=String(t),t=e.j?t.toLowerCase():t}(E=zt.prototype).add=function(e,t){Gt(this),this.i=null,e=Ht(this,e);var n=this.g.get(e);return n||this.g.set(e,n=[]),n.push(t),this.h+=1,this},E.forEach=function(n,r){Gt(this),this.g.forEach(function(e,t){e.forEach(function(e){n.call(r,e,t,this)},this)},this)},E.ta=function(){Gt(this);const t=Array.from(this.g.values()),n=Array.from(this.g.keys()),r=[];for(let s=0;s<n.length;s++){var i=t[s];for(let e=0;e<i.length;e++)r.push(n[s])}return r},E.Z=function(t){Gt(this);let n=[];if("string"==typeof t)$t(this,t)&&(n=n.concat(this.g.get(Ht(this,t))));else{t=Array.from(this.g.values());for(let e=0;e<t.length;e++)n=n.concat(t[e])}return n},E.set=function(e,t){return Gt(this),this.i=null,$t(this,e=Ht(this,e))&&(this.h-=this.g.get(e).length),this.g.set(e,[t]),this.h+=1,this},E.get=function(e,t){return e&&0<(e=this.Z(e)).length?String(e[0]):t},E.toString=function(){if(this.i)return this.i;if(!this.g)return"";const e=[],t=Array.from(this.g.keys());for(var n=0;n<t.length;n++)for(var r=t[n],i=encodeURIComponent(String(r)),s=this.Z(r),r=0;r<s.length;r++){var a=i;""!==s[r]&&(a+="="+encodeURIComponent(String(s[r]))),e.push(a)}return this.i=e.join("&")};var Wt=class{constructor(e,t){this.g=e,this.map=t}};function Jt(e){this.l=e||10,e=x.PerformanceNavigationTiming?0<(e=x.performance.getEntriesByType("navigation")).length&&("hq"==e[0].nextHopProtocol||"h2"==e[0].nextHopProtocol):!!(x.g&&x.g.Ka&&x.g.Ka()&&x.g.Ka().dc),this.j=e?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function Yt(e){return e.h||e.g&&e.g.size>=e.j}function Xt(e){return e.h?1:e.g?e.g.size:0}function Zt(e,t){return e.h?e.h==t:e.g&&e.g.has(t)}function en(e,t){e.g?e.g.add(t):e.h=t}function tn(e,t){e.h&&e.h==t?e.h=null:e.g&&e.g.has(t)&&e.g.delete(t)}function nn(t){if(null!=t.h)return t.i.concat(t.h.F);if(null==t.g||0===t.g.size)return V(t.i);{let e=t.i;for(const n of t.g.values())e=e.concat(n.F);return e}}Jt.prototype.cancel=function(){if(this.i=nn(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const e of this.g.values())e.cancel();this.g.clear()}};var rn,sn=class{stringify(e){return x.JSON.stringify(e,void 0)}parse(e){return x.JSON.parse(e,void 0)}};function an(){this.g=new sn}function on(e,t,n,r,i){try{t.onload=null,t.onerror=null,t.onabort=null,t.ontimeout=null,i(r)}catch(e){}}function un(e){this.l=e.ec||null,this.j=e.ob||!1}function cn(e,t){xe.call(this),this.F=e,this.u=t,this.m=void 0,this.readyState=hn,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}F(un,it),un.prototype.g=function(){return new cn(this.l,this.j)},un.prototype.i=(rn={},function(){return rn}),F(cn,xe);var hn=0;function ln(e){e.j.read().then(e.Xa.bind(e)).catch(e.ka.bind(e))}function dn(e){e.readyState=4,e.l=null,e.j=null,e.A=null,fn(e)}function fn(e){e.onreadystatechange&&e.onreadystatechange.call(e)}(E=cn.prototype).open=function(e,t){if(this.readyState!=hn)throw this.abort(),Error("Error reopening a connection");this.C=e,this.B=t,this.readyState=1,fn(this)},E.send=function(e){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const t={headers:this.v,method:this.C,credentials:this.m,cache:void 0};e&&(t.body=e),(this.F||x).fetch(new Request(this.B,t)).then(this.$a.bind(this),this.ka.bind(this))},E.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,dn(this)),this.readyState=hn},E.$a=function(e){if(this.g&&(this.l=e,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=e.headers,this.readyState=2,fn(this)),this.g&&(this.readyState=3,fn(this),this.g)))if("arraybuffer"===this.responseType)e.arrayBuffer().then(this.Ya.bind(this),this.ka.bind(this));else if(void 0!==x.ReadableStream&&"body"in e){if(this.j=e.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;ln(this)}else e.text().then(this.Za.bind(this),this.ka.bind(this))},E.Xa=function(e){var t;this.g&&(this.u&&e.value?this.response.push(e.value):this.u||(t=e.value||new Uint8Array(0),(t=this.A.decode(t,{stream:!e.done}))&&(this.response=this.responseText+=t)),(e.done?dn:fn)(this),3==this.readyState&&ln(this))},E.Za=function(e){this.g&&(this.response=this.responseText=e,dn(this))},E.Ya=function(e){this.g&&(this.response=e,dn(this))},E.ka=function(){this.g&&dn(this)},E.setRequestHeader=function(e,t){this.v.append(e,t)},E.getResponseHeader=function(e){return this.h&&this.h.get(e.toLowerCase())||""},E.getAllResponseHeaders=function(){if(!this.h)return"";const e=[],t=this.h.entries();for(var n=t.next();!n.done;)n=n.value,e.push(n[0]+": "+n[1]),n=t.next();return e.join("\r\n")},Object.defineProperty(cn.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(e){this.m=e?"include":"same-origin"}});var gn=x.JSON.parse;function mn(e){xe.call(this),this.headers=new Map,this.u=e||null,this.h=!1,this.C=this.g=null,this.I="",this.m=0,this.j="",this.l=this.G=this.v=this.F=!1,this.B=0,this.A=null,this.K=pn,this.L=this.M=!1}F(mn,xe);var pn="",yn=/^https?$/i,vn=["POST","PUT"];function wn(e,t){e.h=!1,e.g&&(e.l=!0,e.g.abort(),e.l=!1),e.j=t,e.m=5,_n(e),In(e)}function _n(e){e.F||(e.F=!0,De(e,"complete"),De(e,"error"))}function bn(e){if(e.h&&void 0!==S&&(!e.C[1]||4!=Tn(e)||2!=e.da()))if(e.v&&4==Tn(e))Be(e.La,0,e);else if(De(e,"readystatechange"),4==Tn(e)){e.h=!1;try{var t,n,r,i=e.da();e:switch(i){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var s=!0;break e;default:s=!1}if((t=s)||((n=0===i)&&(!(r=String(e.I).match(Dt)[1]||null)&&x.self&&x.self.location&&(r=x.self.location.protocol.slice(0,-1)),n=!yn.test(r?r.toLowerCase():"")),t=n),t)De(e,"complete"),De(e,"success");else{e.m=6;try{var a=2<Tn(e)?e.g.statusText:""}catch(e){a=""}e.j=a+" ["+e.da()+"]",_n(e)}}finally{In(e)}}}function In(e,t){if(e.g){En(e);const n=e.g,r=e.C[0]?()=>{}:null;e.g=null,e.C=null,t||De(e,"ready");try{n.onreadystatechange=r}catch(e){}}}function En(e){e.g&&e.L&&(e.g.ontimeout=null),e.A&&(x.clearTimeout(e.A),e.A=null)}function Tn(e){return e.g?e.g.readyState:0}function Sn(e){try{if(!e.g)return null;if("response"in e.g)return e.g.response;switch(e.K){case pn:case"text":return e.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in e.g)return e.g.mozResponseArrayBuffer}return null}catch(e){return null}}function xn(e){let n="";return ce(e,function(e,t){n+=t,n+=":",n+=e,n+="\r\n"}),n}function Dn(e,t,n){e:{for(r in n){var r=!1;break e}r=!0}r||(n=xn(n),"string"==typeof e?null!=n&&encodeURIComponent(String(n)):Mt(e,t,n))}function Cn(e,t,n){return n&&n.internalChannelParams&&n.internalChannelParams[e]||t}function An(e){this.Ga=0,this.j=[],this.l=new Ke,this.pa=this.wa=this.I=this.Y=this.g=this.Da=this.F=this.na=this.o=this.U=this.s=null,this.fb=this.W=0,this.cb=Cn("failFast",!1,e),this.G=this.v=this.u=this.m=this.h=null,this.aa=!0,this.Fa=this.V=-1,this.ba=this.A=this.C=0,this.ab=Cn("baseRetryDelayMs",5e3,e),this.hb=Cn("retryDelaySeedMs",1e4,e),this.eb=Cn("forwardChannelMaxRetries",2,e),this.xa=Cn("forwardChannelRequestTimeoutMs",2e4,e),this.va=e&&e.xmlHttpFactory||void 0,this.Ha=e&&e.useFetchStreams||!1,this.L=void 0,this.J=e&&e.supportsCrossDomainXhr||!1,this.K="",this.i=new Jt(e&&e.concurrentRequestLimit),this.Ja=new an,this.P=e&&e.fastHandshake||!1,this.O=e&&e.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.bb=e&&e.bc||!1,e&&e.Ea&&this.l.Ea(),e&&e.forceLongPolling&&(this.aa=!1),this.ca=!this.P&&this.aa&&e&&e.detectBufferingProxy||!1,this.qa=void 0,e&&e.longPollingTimeout&&0<e.longPollingTimeout&&(this.qa=e.longPollingTimeout),this.oa=void 0,this.S=0,this.M=!1,this.ma=this.B=null}function Nn(e){if(Rn(e),3==e.H){var t=e.W++,n=At(e.I);if(Mt(n,"SID",e.K),Mt(n,"RID",t),Mt(n,"TYPE","terminate"),Fn(e,n),(t=new ht(e,e.l,t)).L=2,t.A=Lt(At(n)),n=!1,x.navigator&&x.navigator.sendBeacon)try{n=x.navigator.sendBeacon(t.A.toString(),"")}catch(e){}!n&&x.Image&&((new Image).src=t.A,n=!0),n||(t.g=Qn(t.l,null),t.g.ha(t.A)),t.G=Date.now(),_t(t)}Kn(e)}function kn(e){e.g&&(Bn(e),e.g.cancel(),e.g=null)}function Rn(e){kn(e),e.u&&(x.clearTimeout(e.u),e.u=null),Un(e),e.i.cancel(),e.m&&("number"==typeof e.m&&x.clearTimeout(e.m),e.m=null)}function Mn(e){var t;Yt(e.i)||e.m||(e.m=!0,t=e.Na,Re||Fe(),Me||(Re(),Me=!0),Le.add(t,e),e.C=0)}function Ln(e,t){var n=t?t.m:e.W++,r=At(e.I);Mt(r,"SID",e.K),Mt(r,"RID",n),Mt(r,"AID",e.V),Fn(e,r),e.o&&e.s&&Dn(r,e.o,e.s),n=new ht(e,e.l,n,e.C+1),null===e.o&&(n.I=e.s),t&&(e.j=t.F.concat(e.j)),t=On(e,n,1e3),n.setTimeout(Math.round(.5*e.xa)+Math.round(.5*e.xa*Math.random())),en(e.i,n),pt(n,r,t)}function Fn(e,n){e.na&&ce(e.na,function(e,t){Mt(n,t,e)}),e.h&&xt({},function(e,t){Mt(n,t,e)})}function On(e,t,r){r=Math.min(e.j.length,r);var i=e.h?M(e.h.Va,e.h,e):null;e:{var s=e.j;let n=-1;for(;;){const u=["count="+r];-1==n?0<r?(n=s[0].g,u.push("ofs="+n)):n=0:u.push("ofs="+n);let e=!0;for(let t=0;t<r;t++){var a=s[t].g,o=s[t].map;if((a-=n)<0)n=Math.max(0,s[t].g-100),e=!1;else try{!function(e,r,t){const i=t||"";try{xt(e,function(e,t){let n=e;C(e)&&(n=Ae(e)),r.push(i+t+"="+encodeURIComponent(n))})}catch(e){throw r.push(i+"type="+encodeURIComponent("_badmap")),e}}(o,u,"req"+a+"_")}catch(e){i&&i(o)}}if(e){i=u.join("&");break e}}}return e=e.j.splice(0,r),t.F=e,i}function Pn(e){var t;e.g||e.u||(e.ba=1,t=e.Ma,Re||Fe(),Me||(Re(),Me=!0),Le.add(t,e),e.A=0)}function Vn(e){return!(e.g||e.u||3<=e.A)&&(e.ba++,e.u=tt(M(e.Ma,e),zn(e,e.A)),e.A++,1)}function Bn(e){null!=e.B&&(x.clearTimeout(e.B),e.B=null)}function qn(e){e.g=new ht(e,e.l,"rpc",e.ba),null===e.o&&(e.g.I=e.s),e.g.O=0;var t=At(e.wa);Mt(t,"RID","rpc"),Mt(t,"SID",e.K),Mt(t,"AID",e.V),Mt(t,"CI",e.G?"0":"1"),!e.G&&e.qa&&Mt(t,"TO",e.qa),Mt(t,"TYPE","xmlhttp"),Fn(e,t),e.o&&e.s&&Dn(t,e.o,e.s),e.L&&e.g.setTimeout(e.L);var n=e.g;e=e.pa,n.L=1,n.A=Lt(At(t)),n.u=null,n.S=!0,yt(n,e)}function Un(e){null!=e.v&&(x.clearTimeout(e.v),e.v=null)}function jn(e,t){var n,r,i,s=null;if(e.g==t){Un(e),Bn(e),e.g=null;var a=2}else{if(!Zt(e.i,t))return;s=t.F,tn(e.i,t),a=1}if(0!=e.H)if(t.i)1==a?(s=t.u?t.u.length:0,t=Date.now()-t.G,n=e.C,De(a=We(),new et(a,s)),Mn(e)):Pn(e);else if(3==(n=t.s)||0==n&&0<t.ca||(1!=a||(i=t,Xt((r=e).i)>=r.i.j-(r.m?1:0)||(r.m?(r.j=i.F.concat(r.j),0):1==r.H||2==r.H||r.C>=(r.cb?0:r.eb)||(r.m=tt(M(r.Na,r,i),zn(r,r.C)),r.C++,0))))&&(2!=a||!Vn(e)))switch(s&&0<s.length&&(t=e.i,t.i=t.i.concat(s)),n){case 1:Gn(e,5);break;case 4:Gn(e,10);break;case 3:Gn(e,6);break;default:Gn(e,2)}}function zn(e,t){let n=e.ab+Math.floor(Math.random()*e.hb);return e.isActive()||(n*=2),n*t}function Gn(e,t){var n,r;e.l.info("Error code "+t),2==t?(n=null,e.h&&(n=null),r=M(e.pb,e),n||(n=new Ct("//www.google.com/images/cleardot.gif"),x.location&&"http"==x.location.protocol||Nt(n,"https"),Lt(n)),function(e,t){var n=new Ke;if(x.Image){const r=new Image;r.onload=L(on,n,r,"TestLoadImage: loaded",!0,t),r.onerror=L(on,n,r,"TestLoadImage: error",!1,t),r.onabort=L(on,n,r,"TestLoadImage: abort",!1,t),r.ontimeout=L(on,n,r,"TestLoadImage: timeout",!1,t),x.setTimeout(function(){r.ontimeout&&r.ontimeout()},1e4),r.src=e}else t(!1)}(n.toString(),r)):Ze(2),e.H=0,e.h&&e.h.za(t),Kn(e),Rn(e)}function Kn(e){var t;e.H=0,e.ma=[],e.h&&(0==(t=nn(e.i)).length&&0==e.j.length||(B(e.ma,t),B(e.ma,e.j),e.i.i.length=0,V(e.j),e.j.length=0),e.h.ya())}function $n(e,t,n){var r,i,s=n instanceof Ct?At(n):new Ct(n);return""!=s.g?(t&&(s.g=t+"."+s.g),kt(s,s.m)):(s=(r=x.location).protocol,t=t?t+"."+r.hostname:r.hostname,r=+r.port,i=new Ct(null),s&&Nt(i,s),t&&(i.g=t),r&&kt(i,r),n&&(i.l=n),s=i),n=e.F,t=e.Da,n&&t&&Mt(s,n,t),Mt(s,"VER",e.ra),Fn(e,s),s}function Qn(e,t,n){if(t&&!e.J)throw Error("Can't create secondary domain capable XhrIo object.");return(t=e.Ha&&!e.va?new mn(new un({ob:n})):new mn(e.va)).Oa(e.J),t}function Hn(){}function Wn(){if(H&&!(10<=Number(ne)))throw Error("Environmental error: no available transport.")}function Jn(e,t){xe.call(this),this.g=new An(t),this.l=e,this.h=t&&t.messageUrlParams||null,e=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(e?e["X-Client-Protocol"]="webchannel":e={"X-Client-Protocol":"webchannel"}),this.g.s=e,e=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(e?e["X-WebChannel-Content-Type"]=t.messageContentType:e={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.Ca&&(e?e["X-WebChannel-Client-Profile"]=t.Ca:e={"X-WebChannel-Client-Profile":t.Ca}),this.g.U=e,(e=t&&t.cc)&&!j(e)&&(this.g.o=e),this.A=t&&t.supportsCrossDomainXhr||!1,this.v=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!j(t)&&(this.g.F=t,null!==(e=this.h)&&t in e&&(t in(e=this.h)&&delete e[t])),this.j=new Zn(this)}function Yn(e){ot.call(this),e.__headers__&&(this.headers=e.__headers__,this.statusCode=e.__status__,delete e.__headers__,delete e.__status__);var t=e.__sm__;if(t){e:{for(const n in t){e=n;break e}e=void 0}(this.i=e)&&(e=this.i,t=null!==t&&e in t?t[e]:void 0),this.data=t}else this.data=e}function Xn(){ut.call(this),this.status=1}function Zn(e){this.g=e}function er(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.m=Array(this.blockSize),this.i=this.h=0,this.reset()}function tr(e,t,n){n=n||0;var r=Array(16);if("string"==typeof t)for(var i=0;i<16;++i)r[i]=t.charCodeAt(n++)|t.charCodeAt(n++)<<8|t.charCodeAt(n++)<<16|t.charCodeAt(n++)<<24;else for(i=0;i<16;++i)r[i]=t[n++]|t[n++]<<8|t[n++]<<16|t[n++]<<24;t=e.g[0],n=e.g[1];var i=e.g[2],s=e.g[3],a=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=n+((a=t+(s^n&(i^s))+r[0]+3614090360&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[1]+3905402710&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[2]+606105819&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[3]+3250441966&4294967295)<<22&4294967295|a>>>10))+((a=t+(s^n&(i^s))+r[4]+4118548399&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[5]+1200080426&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[6]+2821735955&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[7]+4249261313&4294967295)<<22&4294967295|a>>>10))+((a=t+(s^n&(i^s))+r[8]+1770035416&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[9]+2336552879&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[10]+4294925233&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[11]+2304563134&4294967295)<<22&4294967295|a>>>10))+((a=t+(s^n&(i^s))+r[12]+1804603682&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[13]+4254626195&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[14]+2792965006&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[15]+1236535329&4294967295)<<22&4294967295|a>>>10))+((a=t+(i^s&(n^i))+r[1]+4129170786&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[6]+3225465664&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[11]+643717713&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[0]+3921069994&4294967295)<<20&4294967295|a>>>12))+((a=t+(i^s&(n^i))+r[5]+3593408605&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[10]+38016083&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[15]+3634488961&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[4]+3889429448&4294967295)<<20&4294967295|a>>>12))+((a=t+(i^s&(n^i))+r[9]+568446438&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[14]+3275163606&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[3]+4107603335&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[8]+1163531501&4294967295)<<20&4294967295|a>>>12))+((a=t+(i^s&(n^i))+r[13]+2850285829&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[2]+4243563512&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[7]+1735328473&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[12]+2368359562&4294967295)<<20&4294967295|a>>>12))+((a=t+(n^i^s)+r[5]+4294588738&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[8]+2272392833&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[11]+1839030562&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[14]+4259657740&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^i^s)+r[1]+2763975236&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[4]+1272893353&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[7]+4139469664&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[10]+3200236656&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^i^s)+r[13]+681279174&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[0]+3936430074&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[3]+3572445317&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[6]+76029189&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^i^s)+r[9]+3654602809&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[12]+3873151461&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[15]+530742520&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[2]+3299628645&4294967295)<<23&4294967295|a>>>9))+((a=t+(i^(n|~s))+r[0]+4096336452&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[7]+1126891415&4294967295)<<10&4294967295|a>>>22))+((a=i+(t^(s|~n))+r[14]+2878612391&4294967295)<<15&4294967295|a>>>17))+((a=n+(s^(i|~t))+r[5]+4237533241&4294967295)<<21&4294967295|a>>>11))+((a=t+(i^(n|~s))+r[12]+1700485571&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[3]+2399980690&4294967295)<<10&4294967295|a>>>22))+((a=i+(t^(s|~n))+r[10]+4293915773&4294967295)<<15&4294967295|a>>>17))+((a=n+(s^(i|~t))+r[1]+2240044497&4294967295)<<21&4294967295|a>>>11))+((a=t+(i^(n|~s))+r[8]+1873313359&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[15]+4264355552&4294967295)<<10&4294967295|a>>>22))+((a=i+(t^(s|~n))+r[6]+2734768916&4294967295)<<15&4294967295|a>>>17))+((a=n+(s^(i|~t))+r[13]+1309151649&4294967295)<<21&4294967295|a>>>11))+((s=(t=n+((a=t+(i^(n|~s))+r[4]+4149444226&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[11]+3174756917&4294967295)<<10&4294967295|a>>>22))^((i=s+((a=i+(t^(s|~n))+r[2]+718787259&4294967295)<<15&4294967295|a>>>17))|~t))+r[9]+3951481745&4294967295;e.g[0]=e.g[0]+t&4294967295,e.g[1]=e.g[1]+(i+(a<<21&4294967295|a>>>11))&4294967295,e.g[2]=e.g[2]+i&4294967295,e.g[3]=e.g[3]+s&4294967295}function nr(e,t){this.h=t;for(var n=[],r=!0,i=e.length-1;0<=i;i--){var s=0|e[i];r&&s==t||(n[i]=s,r=!1)}this.g=n}(E=mn.prototype).Oa=function(e){this.M=e},E.ha=function(e,t,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.I+"; newUri="+e);t=t?t.toUpperCase():"GET",this.I=e,this.j="",this.m=0,this.F=!1,this.h=!0,this.g=(this.u||dt).g(),this.C=this.u?st(this.u):st(dt),this.g.onreadystatechange=M(this.La,this);try{this.G=!0,this.g.open(t,String(e),!0),this.G=!1}catch(e){return void wn(this,e)}if(e=n||"",n=new Map(this.headers),r)if(Object.getPrototypeOf(r)===Object.prototype)for(var i in r)n.set(i,r[i]);else{if("function"!=typeof r.keys||"function"!=typeof r.get)throw Error("Unknown input type for opt_headers: "+String(r));for(const u of r.keys())n.set(u,r.get(u))}r=Array.from(n.keys()).find(e=>"content-type"==e.toLowerCase()),i=x.FormData&&e instanceof x.FormData,0<=P(vn,t)&&!r&&!i&&n.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(var[s,a]of n)this.g.setRequestHeader(s,a);this.K&&(this.g.responseType=this.K),"withCredentials"in this.g&&this.g.withCredentials!==this.M&&(this.g.withCredentials=this.M);try{En(this),0<this.B&&((this.L=(o=this.g,H&&"number"==typeof o.timeout&&void 0!==o.ontimeout))?(this.g.timeout=this.B,this.g.ontimeout=M(this.ua,this)):this.A=Be(this.ua,this.B,this)),this.v=!0,this.g.send(e),this.v=!1}catch(e){wn(this,e)}var o},E.ua=function(){void 0!==S&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,De(this,"timeout"),this.abort(8))},E.abort=function(e){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=e||7,De(this,"complete"),De(this,"abort"),In(this))},E.N=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),In(this,!0)),mn.$.N.call(this)},E.La=function(){this.s||(this.G||this.v||this.l?bn(this):this.kb())},E.kb=function(){bn(this)},E.isActive=function(){return!!this.g},E.da=function(){try{return 2<Tn(this)?this.g.status:-1}catch(e){return-1}},E.ja=function(){try{return this.g?this.g.responseText:""}catch(e){return""}},E.Wa=function(e){if(this.g){var t=this.g.responseText;return e&&0==t.indexOf(e)&&(t=t.substring(e.length)),gn(t)}},E.Ia=function(){return this.m},E.Sa=function(){return"string"==typeof this.j?this.j:String(this.j)},(E=An.prototype).ra=8,E.H=1,E.Na=function(t){if(this.m)if(this.m=null,1==this.H){if(!t){this.W=Math.floor(1e5*Math.random()),t=this.W++;const s=new ht(this,this.l,t);let e=this.s;if(this.U&&(e?(e=he(e),de(e,this.U)):e=this.U),null!==this.o||this.O||(s.I=e,e=null),this.P)e:{for(var n=0,r=0;r<this.j.length;r++){var i=this.j[r];if("__data__"in i.map&&"string"==typeof(i=i.map.__data__)?i=i.length:i=void 0,void 0===i)break;if(4096<(n+=i)){n=r;break e}if(4096===n||r===this.j.length-1){n=r+1;break e}}n=1e3}else n=1e3;n=On(this,s,n),Mt(r=At(this.I),"RID",t),Mt(r,"CVER",22),this.F&&Mt(r,"X-HTTP-Session-Id",this.F),Fn(this,r),e&&(this.O?n="headers="+encodeURIComponent(String(xn(e)))+"&"+n:this.o&&Dn(r,this.o,e)),en(this.i,s),this.bb&&Mt(r,"TYPE","init"),this.P?(Mt(r,"$req",n),Mt(r,"SID","null"),s.aa=!0,pt(s,r,null)):pt(s,r,n),this.H=2}}else 3==this.H&&(t?Ln(this,t):0==this.j.length||Yt(this.i)||Ln(this))},E.Ma=function(){var e;this.u=null,qn(this),this.ca&&!(this.M||null==this.g||this.S<=0)&&(e=2*this.S,this.l.info("BP detection timer enabled: "+e),this.B=tt(M(this.jb,this),e))},E.jb=function(){this.B&&(this.B=null,this.l.info("BP detection timeout reached."),this.l.info("Buffering proxy detected and switch to long-polling!"),this.G=!1,this.M=!0,Ze(10),kn(this),qn(this))},E.ib=function(){null!=this.v&&(this.v=null,kn(this),Vn(this),Ze(19))},E.pb=function(e){e?(this.l.info("Successfully pinged google.com"),Ze(2)):(this.l.info("Failed to ping google.com"),Ze(1))},E.isActive=function(){return!!this.h&&this.h.isActive(this)},(E=Hn.prototype).Ba=function(){},E.Aa=function(){},E.za=function(){},E.ya=function(){},E.isActive=function(){return!0},E.Va=function(){},Wn.prototype.g=function(e,t){return new Jn(e,t)},F(Jn,xe),Jn.prototype.m=function(){this.g.h=this.j,this.A&&(this.g.J=!0);var e=this.g,t=this.l,n=this.h||void 0;Ze(0),e.Y=t,e.na=n||{},e.G=e.aa,e.I=$n(e,null,e.Y),Mn(e)},Jn.prototype.close=function(){Nn(this.g)},Jn.prototype.u=function(e){var t,n=this.g;"string"==typeof e?((t={}).__data__=e,e=t):this.v&&((t={}).__data__=Ae(e),e=t),n.j.push(new Wt(n.fb++,e)),3==n.H&&Mn(n)},Jn.prototype.N=function(){this.g.h=null,delete this.j,Nn(this.g),delete this.g,Jn.$.N.call(this)},F(Yn,ot),F(Xn,ut),F(Zn,Hn),Zn.prototype.Ba=function(){De(this.g,"a")},Zn.prototype.Aa=function(e){De(this.g,new Yn(e))},Zn.prototype.za=function(e){De(this.g,new Xn)},Zn.prototype.ya=function(){De(this.g,"b")},F(er,function(){this.blockSize=-1}),er.prototype.reset=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.i=this.h=0},er.prototype.j=function(e,t){for(var n=(t=void 0===t?e.length:t)-this.blockSize,r=this.m,i=this.h,s=0;s<t;){if(0==i)for(;s<=n;)tr(this,e,s),s+=this.blockSize;if("string"==typeof e){for(;s<t;)if(r[i++]=e.charCodeAt(s++),i==this.blockSize){tr(this,r),i=0;break}}else for(;s<t;)if(r[i++]=e[s++],i==this.blockSize){tr(this,r),i=0;break}}this.h=i,this.i+=t},er.prototype.l=function(){var e=Array((this.h<56?this.blockSize:2*this.blockSize)-this.h);e[0]=128;for(var t=1;t<e.length-8;++t)e[t]=0;for(var n=8*this.i,t=e.length-8;t<e.length;++t)e[t]=255&n,n/=256;for(this.j(e),e=Array(16),t=n=0;t<4;++t)for(var r=0;r<32;r+=8)e[n++]=this.g[t]>>>r&255;return e};var rr={};function ir(e){return-128<=e&&e<128?(t=e,n=function(e){return new nr([0|e],e<0?-1:0)},r=rr,Object.prototype.hasOwnProperty.call(r,t)?r[t]:r[t]=n(t)):new nr([0|e],e<0?-1:0);var t,n,r}function sr(e){if(isNaN(e)||!isFinite(e))return or;if(e<0)return dr(sr(-e));for(var t=[],n=1,r=0;n<=e;r++)t[r]=e/n|0,n*=ar;return new nr(t,0)}var ar=4294967296,or=ir(0),ur=ir(1),cr=ir(16777216);function hr(e){if(0==e.h){for(var t=0;t<e.g.length;t++)if(0!=e.g[t])return;return 1}}function lr(e){return-1==e.h}function dr(e){for(var t=e.g.length,n=[],r=0;r<t;r++)n[r]=~e.g[r];return new nr(n,~e.h).add(ur)}function fr(e,t){return e.add(dr(t))}function gr(e,t){for(;(65535&e[t])!=e[t];)e[t+1]+=e[t]>>>16,e[t]&=65535,t++}function mr(e,t){this.g=e,this.h=t}function pr(e,t){if(hr(t))throw Error("division by zero");if(hr(e))return new mr(or,or);if(lr(e))return t=pr(dr(e),t),new mr(dr(t.g),dr(t.h));if(lr(t))return t=pr(e,dr(t)),new mr(dr(t.g),t.h);if(30<e.g.length){if(lr(e)||lr(t))throw Error("slowDivide_ only works with positive integers.");for(var n=ur,r=t;r.X(e)<=0;)n=yr(n),r=yr(r);for(var i=vr(n,1),s=vr(r,1),r=vr(r,2),n=vr(n,2);!hr(r);){var a=s.add(r);a.X(e)<=0&&(i=i.add(n),s=a),r=vr(r,1),n=vr(n,1)}return t=fr(e,i.R(t)),new mr(i,t)}for(i=or;0<=e.X(t);){for(n=Math.max(1,Math.floor(e.ea()/t.ea())),r=(r=Math.ceil(Math.log(n)/Math.LN2))<=48?1:Math.pow(2,r-48),a=(s=sr(n)).R(t);lr(a)||0<a.X(e);)a=(s=sr(n-=r)).R(t);hr(s)&&(s=ur),i=i.add(s),e=fr(e,a)}return new mr(i,e)}function yr(e){for(var t=e.g.length+1,n=[],r=0;r<t;r++)n[r]=e.D(r)<<1|e.D(r-1)>>>31;return new nr(n,e.h)}function vr(e,t){var n=t>>5;t%=32;for(var r=e.g.length-n,i=[],s=0;s<r;s++)i[s]=0<t?e.D(s+n)>>>t|e.D(s+n+1)<<32-t:e.D(s+n);return new nr(i,e.h)}(E=nr.prototype).ea=function(){if(lr(this))return-dr(this).ea();for(var e=0,t=1,n=0;n<this.g.length;n++){var r=this.D(n);e+=(0<=r?r:ar+r)*t,t*=ar}return e},E.toString=function(e){if((e=e||10)<2||36<e)throw Error("radix out of range: "+e);if(hr(this))return"0";if(lr(this))return"-"+dr(this).toString(e);for(var t=sr(Math.pow(e,6)),n=this,r="";;){var i=pr(n,t).g,s=((0<(n=fr(n,i.R(t))).g.length?n.g[0]:n.h)>>>0).toString(e);if(hr(n=i))return s+r;for(;s.length<6;)s="0"+s;r=s+r}},E.D=function(e){return e<0?0:e<this.g.length?this.g[e]:this.h},E.X=function(e){return lr(e=fr(this,e))?-1:hr(e)?0:1},E.abs=function(){return lr(this)?dr(this):this},E.add=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0,i=0;i<=t;i++){var s=r+(65535&this.D(i))+(65535&e.D(i)),a=(s>>>16)+(this.D(i)>>>16)+(e.D(i)>>>16),r=a>>>16;s&=65535,a&=65535,n[i]=a<<16|s}return new nr(n,-2147483648&n[n.length-1]?-1:0)},E.R=function(e){if(hr(this)||hr(e))return or;if(lr(this))return lr(e)?dr(this).R(dr(e)):dr(dr(this).R(e));if(lr(e))return dr(this.R(dr(e)));if(this.X(cr)<0&&e.X(cr)<0)return sr(this.ea()*e.ea());for(var t=this.g.length+e.g.length,n=[],r=0;r<2*t;r++)n[r]=0;for(r=0;r<this.g.length;r++)for(var i=0;i<e.g.length;i++){var s=this.D(r)>>>16,a=65535&this.D(r),o=e.D(i)>>>16,u=65535&e.D(i);n[2*r+2*i]+=a*u,gr(n,2*r+2*i),n[2*r+2*i+1]+=s*u,gr(n,2*r+2*i+1),n[2*r+2*i+1]+=a*o,gr(n,2*r+2*i+1),n[2*r+2*i+2]+=s*o,gr(n,2*r+2*i+2)}for(r=0;r<t;r++)n[r]=n[2*r+1]<<16|n[2*r];for(r=t;r<2*t;r++)n[r]=0;return new nr(n,0)},E.gb=function(e){return pr(this,e).h},E.and=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.D(r)&e.D(r);return new nr(n,this.h&e.h)},E.or=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.D(r)|e.D(r);return new nr(n,this.h|e.h)},E.xor=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.D(r)^e.D(r);return new nr(n,this.h^e.h)},Wn.prototype.createWebChannel=Wn.prototype.g,Jn.prototype.send=Jn.prototype.u,Jn.prototype.open=Jn.prototype.m,nt.NO_ERROR=0,nt.TIMEOUT=8,nt.HTTP_ERROR=6,rt.COMPLETE="complete",(at.EventType=T).OPEN="a",T.CLOSE="b",T.ERROR="c",T.MESSAGE="d",xe.prototype.listen=xe.prototype.O,mn.prototype.listenOnce=mn.prototype.P,mn.prototype.getLastError=mn.prototype.Sa,mn.prototype.getLastErrorCode=mn.prototype.Ia,mn.prototype.getStatus=mn.prototype.da,mn.prototype.getResponseJson=mn.prototype.Wa,mn.prototype.getResponseText=mn.prototype.ja,mn.prototype.send=mn.prototype.ha,mn.prototype.setWithCredentials=mn.prototype.Oa,er.prototype.digest=er.prototype.l,er.prototype.update=er.prototype.j,nr.prototype.multiply=nr.prototype.R,nr.prototype.modulo=nr.prototype.gb,nr.prototype.compare=nr.prototype.X,nr.prototype.toNumber=nr.prototype.ea,nr.prototype.getBits=nr.prototype.D,nr.fromNumber=sr,nr.fromString=function e(t,n){if(0==t.length)throw Error("number format error: empty string");if((n=n||10)<2||36<n)throw Error("radix out of range: "+n);if("-"==t.charAt(0))return dr(e(t.substring(1),n));if(0<=t.indexOf("-"))throw Error('number format error: interior "-" character');for(var r=sr(Math.pow(n,8)),i=or,s=0;s<t.length;s+=8)var a=Math.min(8,t.length-s),o=parseInt(t.substring(s,s+a),n),i=a<8?(a=sr(Math.pow(n,a)),i.R(a).add(sr(o))):(i=i.R(r)).add(sr(o));return i};var wr,_r,br,Ir=We,Er=nt,Tr=rt,Sr=Qe,xr=10,Dr=11,Cr=un,Ar=at,Nr=mn,kr=er,Rr=nr;const Mr="@firebase/firestore";class Lr{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}Lr.UNAUTHENTICATED=new Lr(null),Lr.GOOGLE_CREDENTIALS=new Lr("google-credentials-uid"),Lr.FIRST_PARTY=new Lr("first-party-uid"),Lr.MOCK_USER=new Lr("mock-user");let Fr="10.11.1";const Or=new class{constructor(e){this.name=e,this._logLevel=_,this._logHandler=I,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in l))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?w[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,l.DEBUG,...e),this._logHandler(this,l.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,l.VERBOSE,...e),this._logHandler(this,l.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,l.INFO,...e),this._logHandler(this,l.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,l.WARN,...e),this._logHandler(this,l.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,l.ERROR,...e),this._logHandler(this,l.ERROR,...e)}}("@firebase/firestore");function Pr(){return Or.logLevel}function Vr(e,...t){var n;Or.logLevel<=l.DEBUG&&(n=t.map(Ur),Or.debug(`Firestore (${Fr}): ${e}`,...n))}function Br(e,...t){var n;Or.logLevel<=l.ERROR&&(n=t.map(Ur),Or.error(`Firestore (${Fr}): ${e}`,...n))}function qr(e,...t){var n;Or.logLevel<=l.WARN&&(n=t.map(Ur),Or.warn(`Firestore (${Fr}): ${e}`,...n))}function Ur(t){if("string"==typeof t)return t;try{return JSON.stringify(t)}catch(e){return t}}function jr(e="Unexpected state"){var t=`FIRESTORE (${Fr}) INTERNAL ASSERTION FAILED: `+e;throw Br(t),new Error(t)}function zr(e){e||jr()}const Gr={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class Kr extends d{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class $r{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class Qr{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class Hr{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(Lr.UNAUTHENTICATED))}shutdown(){}}class Wr{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class Jr{constructor(e){this.t=e,this.currentUser=Lr.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,n){let r=this.i;const i=e=>this.i!==r?(r=this.i,n(e)):Promise.resolve();let s=new $r;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new $r,t.enqueueRetryable(()=>i(this.currentUser))};const a=()=>{const e=s;t.enqueueRetryable(async()=>{await e.promise,await i(this.currentUser)})},o=e=>{Vr("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),a()};this.t.onInit(e=>o(e)),setTimeout(()=>{var e;this.auth||((e=this.t.getImmediate({optional:!0}))?o(e):(Vr("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new $r))},0),a()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(e=>this.i!==t?(Vr("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(zr("string"==typeof e.accessToken),new Qr(e.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){var e=this.auth&&this.auth.getUid();return zr(null===e||"string"==typeof e),new Lr(e)}}class Yr{constructor(e,t,n){this.l=e,this.h=t,this.P=n,this.type="FirstParty",this.user=Lr.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);var e=this.T();return e&&this.I.set("Authorization",e),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}}class Xr{constructor(e,t,n){this.l=e,this.h=t,this.P=n}getToken(){return Promise.resolve(new Yr(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable(()=>t(Lr.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class Zr{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&0<e.length&&this.headers.set("x-firebase-appcheck",this.value)}}class ei{constructor(e){this.A=e,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(t,n){const r=e=>{null!=e.error&&Vr("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);var t=e.token!==this.R;return this.R=e.token,Vr("FirebaseAppCheckTokenProvider",`Received ${t?"new":"existing"} token.`),t?n(e.token):Promise.resolve()};this.o=e=>{t.enqueueRetryable(()=>r(e))};const i=e=>{Vr("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.A.onInit(e=>i(e)),setTimeout(()=>{var e;this.appCheck||((e=this.A.getImmediate({optional:!0}))?i(e):Vr("FirebaseAppCheckTokenProvider","AppCheck not yet detected"))},0)}getToken(){var e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?(zr("string"==typeof e.token),this.R=e.token,new Zr(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class ti{static newId(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=Math.floor(256/t.length)*t.length;let r="";for(;r.length<20;){var i=function(t){const n="undefined"!=typeof self&&(self.crypto||self.msCrypto),r=new Uint8Array(t);if(n&&"function"==typeof n.getRandomValues)n.getRandomValues(r);else for(let e=0;e<t;e++)r[e]=Math.floor(256*Math.random());return r}(40);for(let e=0;e<i.length;++e)r.length<20&&i[e]<n&&(r+=t.charAt(i[e]%t.length))}return r}}function ni(e,t){return e<t?-1:t<e?1:0}function ri(e,n,r){return e.length===n.length&&e.every((e,t)=>r(e,n[t]))}function ii(e){return e+"\0"}class si{constructor(e,t){if(this.seconds=e,(this.nanoseconds=t)<0)throw new Kr(Gr.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(1e9<=t)throw new Kr(Gr.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new Kr(Gr.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(253402300800<=e)throw new Kr(Gr.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return si.fromMillis(Date.now())}static fromDate(e){return si.fromMillis(e.getTime())}static fromMillis(e){var t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new si(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?ni(this.nanoseconds,e.nanoseconds):ni(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){var e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class ai{constructor(e){this.timestamp=e}static fromTimestamp(e){return new ai(e)}static min(){return new ai(new si(0,0))}static max(){return new ai(new si(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class oi{constructor(e,t,n){void 0===t?t=0:t>e.length&&jr(),void 0===n?n=e.length-t:n>e.length-t&&jr(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===oi.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof oi?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return this.construct(this.segments,this.offset+(e=void 0===e?1:e),this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=e.get(r),i=t.get(r);if(n<i)return-1;if(n>i)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class ui extends oi{construct(e,t,n){return new ui(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){const t=[];for(const n of e){if(0<=n.indexOf("//"))throw new Kr(Gr.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>0<e.length))}return new ui(t)}static emptyPath(){return new ui([])}}const ci=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class hi extends oi{construct(e,t,n){return new hi(e,t,n)}static isValidIdentifier(e){return ci.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),e=!hi.isValidIdentifier(e)?"`"+e+"`":e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new hi(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;var i=()=>{if(0===n.length)throw new Kr(Gr.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let s=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new Kr(Gr.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new Kr(Gr.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?s=!s:"."!==t||s?n+=t:i(),r++}if(i(),s)throw new Kr(Gr.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new hi(t)}static emptyPath(){return new hi([])}}class li{constructor(e){this.path=e}static fromPath(e){return new li(ui.fromString(e))}static fromName(e){return new li(ui.fromString(e).popFirst(5))}static empty(){return new li(ui.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return 2<=this.path.length&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===ui.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return ui.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new li(new ui(e.slice()))}}class di{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function fi(e){return e.fields.find(e=>2===e.kind)}function gi(e){return e.fields.filter(e=>2!==e.kind)}di.UNKNOWN_ID=-1;class mi{constructor(e,t){this.fieldPath=e,this.kind=t}}class pi{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new pi(0,wi.min())}}function yi(e,t){var n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1,r=ai.fromTimestamp(1e9===r?new si(n+1,0):new si(n,r));return new wi(r,li.empty(),t)}function vi(e){return new wi(e.readTime,e.key,-1)}class wi{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new wi(ai.min(),li.empty(),-1)}static max(){return new wi(ai.max(),li.empty(),-1)}}function _i(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=li.comparator(e.documentKey,t.documentKey),0!==n?n:ni(e.largestBatchId,t.largestBatchId))}const bi="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class Ii{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function Ei(e){if(e.code!==Gr.FAILED_PRECONDITION||e.message!==bi)throw e;Vr("LocalStore","Unexpectedly lost primary lease")}class Ti{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(r,i){return this.callbackAttached&&jr(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(i,this.error):this.wrapSuccess(r,this.result):new Ti((t,n)=>{this.nextCallback=e=>{this.wrapSuccess(r,e).next(t,n)},this.catchCallback=e=>{this.wrapFailure(i,e).next(t,n)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{var t=e();return t instanceof Ti?t:Ti.resolve(t)}catch(e){return Ti.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):Ti.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):Ti.reject(t)}static resolve(n){return new Ti((e,t)=>{e(n)})}static reject(n){return new Ti((e,t)=>{t(n)})}static waitFor(e){return new Ti((t,n)=>{let r=0,i=0,s=!1;e.forEach(e=>{++r,e.next(()=>{++i,s&&i===r&&t()},e=>n(e))}),s=!0,i===r&&t()})}static or(e){let t=Ti.resolve(!1);for(const n of e)t=t.next(e=>e?Ti.resolve(e):n());return t}static forEach(e,n){const r=[];return e.forEach((e,t)=>{r.push(n.call(this,e,t))}),this.waitFor(r)}static mapArray(o,u){return new Ti((t,n)=>{const r=o.length,i=new Array(r);let s=0;for(let e=0;e<r;e++){const a=e;u(o[a]).next(e=>{i[a]=e,++s,s===r&&t(i)},e=>n(e))}})}static doWhile(r,i){return new Ti((e,t)=>{const n=()=>{!0===r()?i().next(()=>{n()},t):e()};n()})}}class Si{constructor(n,e){this.action=n,this.transaction=e,this.aborted=!1,this.V=new $r,this.transaction.oncomplete=()=>{this.V.resolve()},this.transaction.onabort=()=>{e.error?this.V.reject(new Ai(n,e.error)):this.V.resolve()},this.transaction.onerror=e=>{var t=Li(e.target.error);this.V.reject(new Ai(n,t))}}static open(e,t,n,r){try{return new Si(t,e.transaction(r,n))}catch(e){throw new Ai(t,e)}}get m(){return this.V.promise}abort(e){e&&this.V.reject(e),this.aborted||(Vr("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}g(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){var t=this.transaction.objectStore(e);return new ki(t)}}class xi{constructor(e,t,n){this.name=e,this.version=t,this.p=n,12.2===xi.S(u())&&Br("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return Vr("SimpleDb","Removing database:",e),Ri(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!function(){try{return"object"==typeof indexedDB}catch(e){return}}())return!1;if(xi.C())return!0;const e=u(),t=xi.S(e),n=0<t&&t<10,r=Di(e),i=0<r&&r<4.5;return!(0<e.indexOf("MSIE ")||0<e.indexOf("Trident/")||0<e.indexOf("Edge/")||n||i)}static C(){var e;return"undefined"!=typeof process&&"YES"===(null===(e=process.__PRIVATE_env)||void 0===e?void 0:e.v)}static F(e,t){return e.store(t)}static S(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}async M(s){return this.db||(Vr("SimpleDb","Opening database:",this.name),this.db=await new Promise((n,r)=>{const i=indexedDB.open(this.name,this.version);i.onsuccess=e=>{var t=e.target.result;n(t)},i.onblocked=()=>{r(new Ai(s,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},i.onerror=e=>{var t=e.target.error;"VersionError"===t.name?r(new Kr(Gr.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===t.name?r(new Kr(Gr.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+t)):r(new Ai(s,t))},i.onupgradeneeded=e=>{Vr("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);var t=e.target.result;this.p.O(t,i.transaction,e.oldVersion,this.version).next(()=>{Vr("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.N&&(this.db.onversionchange=e=>this.N(e)),this.db}L(t){this.N=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(e,t,n,r){var i="readonly"===t;let s=0;for(;;){++s;try{this.db=await this.M(e);const t=Si.open(this.db,e,i?"readonly":"readwrite",n),s=r(t).next(e=>(t.g(),e)).catch(e=>(t.abort(e),Ti.reject(e))).toPromise();return s.catch(()=>{}),await t.m,s}catch(e){const t=e,n="FirebaseError"!==t.name&&s<3;if(Vr("SimpleDb","Transaction failed with error:",t.message,"Retrying:",n),this.close(),!n)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}function Di(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}class Ci{constructor(e){this.B=e,this.k=!1,this.q=null}get isDone(){return this.k}get K(){return this.q}set cursor(e){this.B=e}done(){this.k=!0}$(e){this.q=e}delete(){return Ri(this.B.delete())}}class Ai extends Kr{constructor(e,t){super(Gr.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function Ni(e){return"IndexedDbTransactionError"===e.name}class ki{constructor(e){this.store=e}put(e,t){let n;return n=void 0!==t?(Vr("SimpleDb","PUT",this.store.name,e,t),this.store.put(t,e)):(Vr("SimpleDb","PUT",this.store.name,"<auto-key>",e),this.store.put(e)),Ri(n)}add(e){return Vr("SimpleDb","ADD",this.store.name,e,e),Ri(this.store.add(e))}get(t){return Ri(this.store.get(t)).next(e=>(Vr("SimpleDb","GET",this.store.name,t,e=void 0===e?null:e),e))}delete(e){return Vr("SimpleDb","DELETE",this.store.name,e),Ri(this.store.delete(e))}count(){return Vr("SimpleDb","COUNT",this.store.name),Ri(this.store.count())}U(e,n){const t=this.options(e,n),r=t.index?this.store.index(t.index):this.store;if("function"==typeof r.getAll){const e=r.getAll(t.range);return new Ti((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}{const e=this.cursor(t),n=[];return this.W(e,(e,t)=>{n.push(t)}).next(()=>n)}}G(e,t){const r=this.store.getAll(e,null===t?void 0:t);return new Ti((t,n)=>{r.onerror=e=>{n(e.target.error)},r.onsuccess=e=>{t(e.target.result)}})}j(e,t){Vr("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.H=!1;var r=this.cursor(n);return this.W(r,(e,t,n)=>n.delete())}J(e,t){let n;t?n=e:(n={},t=e);var r=this.cursor(n);return this.W(r,t)}Y(i){const e=this.cursor({});return new Ti((n,r)=>{e.onerror=e=>{var t=Li(e.target.error);r(t)},e.onsuccess=e=>{const t=e.target.result;t?i(t.primaryKey,t.value).next(e=>{e?t.continue():n()}):n()}})}W(e,s){const a=[];return new Ti((i,t)=>{e.onerror=e=>{t(e.target.error)},e.onsuccess=e=>{const t=e.target.result;if(t){const n=new Ci(t),r=s(t.primaryKey,t.value,n);if(r instanceof Ti){const e=r.catch(e=>(n.done(),Ti.reject(e)));a.push(e)}n.isDone?i():null===n.K?t.continue():t.continue(n.K)}else i()}}).next(()=>Ti.waitFor(a))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.H?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function Ri(e){return new Ti((n,r)=>{e.onsuccess=e=>{var t=e.target.result;n(t)},e.onerror=e=>{var t=Li(e.target.error);r(t)}})}let Mi=!1;function Li(e){const t=xi.S(u());if(12.2<=t&&t<13){const t="An internal error was encountered in the Indexed Database server";if(0<=e.message.indexOf(t)){const e=new Kr("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Mi||(Mi=!0,setTimeout(()=>{throw e},0)),e}}return e}class Fi{constructor(e,t){this.asyncQueue=e,this.Z=t,this.task=null}start(){this.X(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}X(e){Vr("IndexBackfiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{Vr("IndexBackfiller",`Documents written: ${await this.Z.ee()}`)}catch(e){Ni(e)?Vr("IndexBackfiller","Ignoring IndexedDB error during index backfill: ",e):await Ei(e)}await this.X(6e4)})}}class Oi{constructor(e,t){this.localStore=e,this.persistence=t}async ee(t=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",e=>this.te(e,t))}te(e,t){const n=new Set;let r=t,i=!0;return Ti.doWhile(()=>!0===i&&0<r,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>null===t||n.has(t)?void(i=!1):(Vr("IndexBackfiller",`Processing collection: ${t}`),this.ne(e,t,r).next(e=>{r-=e,n.add(t)})))).next(()=>t-r)}ne(r,i,e){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(r,i).next(n=>this.localStore.localDocuments.getNextDocuments(r,i,n,e).next(e=>{const t=e.changes;return this.localStore.indexManager.updateIndexEntries(r,t).next(()=>this.re(n,e)).next(e=>(Vr("IndexBackfiller",`Updating offset: ${e}`),this.localStore.indexManager.updateCollectionGroup(r,i,e))).next(()=>t.size)}))}re(e,t){let r=e;return t.changes.forEach((e,t)=>{var n=vi(t);0<_i(n,r)&&(r=n)}),new wi(r.readTime,r.documentKey,Math.max(t.batchId,e.largestBatchId))}}class Pi{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ie(e),this.se=e=>t.writeSequenceNumber(e))}ie(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){var e=++this.previousValue;return this.se&&this.se(e),e}}function Vi(e){return null==e}function Bi(e){return 0===e&&1/e==-1/0}function qi(e){return"number"==typeof e&&Number.isInteger(e)&&!Bi(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function Ui(e){let t="";for(let n=0;n<e.length;n++)0<t.length&&(t=ji(t)),t=function(e,t){let n=t;const r=e.length;for(let i=0;i<r;i++){const r=e.charAt(i);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}(e.get(n),t);return ji(t)}function ji(e){return e+""}function zi(t){const n=t.length;if(zr(2<=n),2===n)return zr(""===t.charAt(0)&&""===t.charAt(1)),ui.emptyPath();const __PRIVATE_lastReasonableEscapeIndex=n-2,r=[];let i="";for(let a=0;a<n;){const n=t.indexOf("",a);switch((n<0||n>__PRIVATE_lastReasonableEscapeIndex)&&jr(),t.charAt(n+1)){case"":var s=t.substring(a,n);let e;0===i.length?e=s:(i+=s,e=i,i=""),r.push(e);break;case"":i+=t.substring(a,n),i+="\0";break;case"":i+=t.substring(a,n+1);break;default:jr()}a=n+2}return new ui(r)}Pi.oe=-1;const Gi=["userId","batchId"];function Ki(e,t){return[e,Ui(t)]}function $i(e,t,n){return[e,Ui(t),n]}const Qi={},Hi=["prefixPath","collectionGroup","readTime","documentId"],Wi=["prefixPath","collectionGroup","documentId"],Ji=["collectionGroup","readTime","prefixPath","documentId"],Yi=["canonicalId","targetId"],Xi=["targetId","path"],Zi=["path","targetId"],es=["collectionId","parent"],ts=["indexId","uid"],ns=["uid","sequenceNumber"],rs=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],is=["indexId","uid","orderedDocumentKey"],ss=["userId","collectionPath","documentId"],as=["userId","collectionPath","largestBatchId"],os=["userId","collectionGroup","largestBatchId"],us=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],cs=[...us,"documentOverlays"],hs=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],ls=hs,ds=[...ls,"indexConfiguration","indexState","indexEntries"],fs=ds;class gs extends Ii{constructor(e,t){super(),this._e=e,this.currentSequenceNumber=t}}function ms(e,t){var n=e;return xi.F(n._e,t)}function ps(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function ys(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function vs(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class ws{constructor(e,t){this.comparator=e,this.root=t||bs.EMPTY}insert(e,t){return new ws(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,bs.BLACK,null,null))}remove(e){return new ws(this.comparator,this.root.remove(e,this.comparator).copy(null,null,bs.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){var n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:0<n&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){var r=this.comparator(e,n.key);if(0===r)return t+n.left.size;n=r<0?n.left:(t+=n.left.size+1,n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(n){this.inorderTraversal((e,t)=>(n(e,t),!1))}toString(){const n=[];return this.inorderTraversal((e,t)=>(n.push(`${e}:${t}`),!1)),`{${n.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new _s(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new _s(this.root,e,this.comparator,!1)}getReverseIterator(){return new _s(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new _s(this.root,e,this.comparator,!0)}}class _s{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let i=1;for(;!e.isEmpty();)if(i=t?n(e.key,t):1,t&&r&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();var t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return 0<this.nodeStack.length}peek(){if(0===this.nodeStack.length)return null;var e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class bs{constructor(e,t,n,r,i){this.key=e,this.value=t,this.color=null!=n?n:bs.RED,this.left=null!=r?r:bs.EMPTY,this.right=null!=i?i:bs.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,i){return new bs(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;var i=n(e,r.key);return r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===i?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return bs.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return bs.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){var e=this.copy(null,null,bs.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){var e=this.copy(null,null,bs.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){var e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){var e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw jr();if(this.right.isRed())throw jr();var e=this.left.check();if(e!==this.right.check())throw jr();return e+(this.isRed()?0:1)}}bs.EMPTY=null,bs.RED=!0,bs.BLACK=!1,bs.EMPTY=new class{constructor(){this.size=0}get key(){throw jr()}get value(){throw jr()}get color(){throw jr()}get left(){throw jr()}get right(){throw jr()}copy(e,t,n,r,i){return this}insert(e,t,n){return new bs(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class Is{constructor(e){this.comparator=e,this.data=new ws(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(n){this.data.inorderTraversal((e,t)=>(n(e),!1))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){var r=n.getNext();if(0<=this.comparator(r.key,e[1]))return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new Es(this.data.getIterator())}getIteratorFrom(e){return new Es(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof Is))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const t=[];return this.forEach(e=>{t.push(e)}),t}toString(){const t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(e){const t=new Is(this.comparator);return t.data=e,t}}class Es{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function Ts(e){return e.hasNext()?e.getNext():void 0}class Ss{constructor(e){(this.fields=e).sort(hi.comparator)}static empty(){return new Ss([])}unionWith(e){let t=new Is(hi.comparator);for(const e of this.fields)t=t.add(e);for(const n of e)t=t.add(n);return new Ss(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return ri(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class xs extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class Ds{constructor(e){this.binaryString=e}static fromBase64String(e){var t=function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new xs("Invalid base64 string: "+e):e}}(e);return new Ds(t)}static fromUint8Array(e){var t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new Ds(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return ni(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}Ds.EMPTY_BYTE_STRING=new Ds("");const Cs=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function As(t){if(zr(!!t),"string"!=typeof t)return{seconds:Ns(t.seconds),nanos:Ns(t.nanos)};{let e=0;var n=Cs.exec(t);zr(!!n),n[1]&&(n=((n=n[1])+"000000000").substr(0,9),e=Number(n));const r=new Date(t);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}}function Ns(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function ks(e){return"string"==typeof e?Ds.fromBase64String(e):Ds.fromUint8Array(e)}function Rs(e){var t;return"server_timestamp"===(null===(t=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===t?void 0:t.stringValue)}function Ms(e){var t=e.mapValue.fields.__previous_value__;return Rs(t)?Ms(t):t}function Ls(e){var t=As(e.mapValue.fields.__local_write_time__.timestampValue);return new si(t.seconds,t.nanos)}class Fs{constructor(e,t,n,r,i,s,a,o,u){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=i,this.forceLongPolling=s,this.autoDetectLongPolling=a,this.longPollingOptions=o,this.useFetchStreams=u}}class Os{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new Os("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof Os&&e.projectId===this.projectId&&e.database===this.database}}const Ps={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Vs={nullValue:"NULL_VALUE"};function Bs(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?Rs(e)?4:Xs(e)?9007199254740991:10:jr()}function qs(e,t){if(e===t)return!0;var n,r,i=Bs(e);if(i!==Bs(t))return!1;switch(i){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return Ls(e).isEqual(Ls(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;var n=As(e.timestampValue),r=As(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return r=t,ks(e.bytesValue).isEqual(ks(r.bytesValue));case 7:return e.referenceValue===t.referenceValue;case 8:return n=t,Ns((r=e).geoPointValue.latitude)===Ns(n.geoPointValue.latitude)&&Ns(r.geoPointValue.longitude)===Ns(n.geoPointValue.longitude);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return Ns(e.integerValue)===Ns(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){var n=Ns(e.doubleValue),r=Ns(t.doubleValue);return n===r?Bi(n)===Bi(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return ri(e.arrayValue.values||[],t.arrayValue.values||[],qs);case 10:return function(e,t){const n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(ps(n)!==ps(r))return!1;for(const e in n)if(n.hasOwnProperty(e)&&(void 0===r[e]||!qs(n[e],r[e])))return!1;return!0}(e,t);default:return jr()}}function Us(e,t){return void 0!==(e.values||[]).find(e=>qs(e,t))}function js(e,t){if(e===t)return 0;var n,r,i,s,a=Bs(e),o=Bs(t);if(a!==o)return ni(a,o);switch(a){case 0:case 9007199254740991:return 0;case 1:return ni(e.booleanValue,t.booleanValue);case 2:return r=t,i=Ns((n=e).integerValue||n.doubleValue),s=Ns(r.integerValue||r.doubleValue),i<s?-1:s<i?1:i===s?0:isNaN(i)?isNaN(s)?0:-1:1;case 3:return zs(e.timestampValue,t.timestampValue);case 4:return zs(Ls(e),Ls(t));case 5:return ni(e.stringValue,t.stringValue);case 6:return function(e,t){const n=ks(e),r=ks(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){var n=e.split("/"),r=t.split("/");for(let i=0;i<n.length&&i<r.length;i++){const t=ni(n[i],r[i]);if(0!==t)return t}return ni(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return n=e.geoPointValue,r=t.geoPointValue,0!==(s=ni(Ns(n.latitude),Ns(r.latitude)))?s:ni(Ns(n.longitude),Ns(r.longitude));case 9:return function(e,t){var n=e.values||[],r=t.values||[];for(let i=0;i<n.length&&i<r.length;++i){const t=js(n[i],r[i]);if(t)return t}return ni(n.length,r.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){if(e===Ps.mapValue&&t===Ps.mapValue)return 0;if(e===Ps.mapValue)return 1;if(t===Ps.mapValue)return-1;const n=e.fields||{},r=Object.keys(n),i=t.fields||{},s=Object.keys(i);r.sort(),s.sort();for(let o=0;o<r.length&&o<s.length;++o){const t=ni(r[o],s[o]);if(0!==t)return t;var a=js(n[r[o]],i[s[o]]);if(0!==a)return a}return ni(r.length,s.length)}(e.mapValue,t.mapValue);default:throw jr()}}function zs(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return ni(e,t);var n=As(e),r=As(t),i=ni(n.seconds,r.seconds);return 0!==i?i:ni(n.nanos,r.nanos)}function Gs(e){return function s(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=As(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?function(e){return ks(e).toBase64()}(e.bytesValue):"referenceValue"in e?function(e){return li.fromName(e).toString()}(e.referenceValue):"geoPointValue"in e?function(e){return`geo(${e.latitude},${e.longitude})`}(e.geoPointValue):"arrayValue"in e?function(e){let t="[",n=!0;for(const r of e.values||[])n?n=!1:t+=",",t+=s(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const i of t)r?r=!1:n+=",",n+=`${i}:${s(e.fields[i])}`;return n+"}"}(e.mapValue):jr()}(e)}function Ks(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function $s(e){return!!e&&"integerValue"in e}function Qs(e){return!!e&&"arrayValue"in e}function Hs(e){return e&&"nullValue"in e}function Ws(e){return e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function Js(e){return e&&"mapValue"in e}function Ys(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const n={mapValue:{fields:{}}};return ys(t.mapValue.fields,(e,t)=>n.mapValue.fields[e]=Ys(t)),n}if(t.arrayValue){const r={arrayValue:{values:[]}};for(let e=0;e<(t.arrayValue.values||[]).length;++e)r.arrayValue.values[e]=Ys(t.arrayValue.values[e]);return r}return Object.assign({},t)}function Xs(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}function Zs(e,t){var n=js(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function ea(e,t){var n=js(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class ta{constructor(e){this.value=e}static empty(){return new ta({mapValue:{}})}field(n){if(n.isEmpty())return this.value;{let e=this.value;for(let t=0;t<n.length-1;++t)if(e=(e.mapValue.fields||{})[n.get(t)],!Js(e))return null;return e=(e.mapValue.fields||{})[n.lastSegment()],e||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=Ys(t)}setAll(e){let n=hi.emptyPath(),r={},i=[];e.forEach((e,t)=>{if(!n.isImmediateParentOf(t)){const e=this.getFieldsMap(n);this.applyChanges(e,r,i),r={},i=[],n=t.popLast()}e?r[t.lastSegment()]=Ys(e):i.push(t.lastSegment())});var t=this.getFieldsMap(n);this.applyChanges(t,r,i)}delete(e){const t=this.field(e.popLast());Js(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return qs(this.value,e.value)}getFieldsMap(t){let n=this.value;n.mapValue.fields||(n.mapValue={fields:{}});for(let r=0;r<t.length;++r){let e=n.mapValue.fields[t.get(r)];Js(e)&&e.mapValue.fields||(e={mapValue:{fields:{}}},n.mapValue.fields[t.get(r)]=e),n=e}return n.mapValue.fields}applyChanges(n,e,t){ys(e,(e,t)=>n[e]=t);for(const e of t)delete n[e]}clone(){return new ta(Ys(this.value))}}class na{constructor(e,t,n,r,i,s,a){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=i,this.data=s,this.documentState=a}static newInvalidDocument(e){return new na(e,0,ai.min(),ai.min(),ai.min(),ta.empty(),0)}static newFoundDocument(e,t,n,r){return new na(e,1,t,ai.min(),n,r,0)}static newNoDocument(e,t){return new na(e,2,t,ai.min(),ai.min(),ta.empty(),0)}static newUnknownDocument(e,t){return new na(e,3,t,ai.min(),ai.min(),ta.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(ai.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=ta.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=ta.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=ai.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof na&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new na(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class ra{constructor(e,t){this.position=e,this.inclusive=t}}function ia(e,t,n){let r=0;for(let i=0;i<e.position.length;i++){const s=t[i],a=e.position[i];if(r=s.field.isKeyField()?li.comparator(li.fromName(a.referenceValue),n.key):js(a,n.data.field(s.field)),"desc"===s.dir&&(r*=-1),0!==r)break}return r}function sa(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!qs(e.position[n],t.position[n]))return!1;return!0}class aa{constructor(e,t="asc"){this.field=e,this.dir=t}}class oa{}class ua extends oa{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new pa(e,t,n):"array-contains"===t?new _a(e,n):"in"===t?new ba(e,n):"not-in"===t?new Ia(e,n):"array-contains-any"===t?new Ea(e,n):new ua(e,t,n)}static createKeyFieldInFilter(e,t,n){return new("in"===t?ya:va)(e,n)}matches(e){var t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(js(t,this.value)):null!==t&&Bs(this.value)===Bs(t)&&this.matchesComparison(js(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return 0<e;case">=":return 0<=e;default:return jr()}}isInequality(){return 0<=["<","<=",">",">=","!=","not-in"].indexOf(this.op)}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class ca extends oa{constructor(e,t){super(),this.filters=e,this.op=t,this.ae=null}static create(e,t){return new ca(e,t)}matches(t){return ha(this)?void 0===this.filters.find(e=>!e.matches(t)):void 0!==this.filters.find(e=>e.matches(t))}getFlattenedFilters(){return null!==this.ae||(this.ae=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.ae}getFilters(){return Object.assign([],this.filters)}}function ha(e){return"and"===e.op}function la(e){return"or"===e.op}function da(e){return fa(e)&&ha(e)}function fa(e){for(const t of e.filters)if(t instanceof ca)return!1;return!0}function ga(e,t){var n=e.filters.concat(t);return ca.create(n,e.op)}function ma(e){return e instanceof ua?`${(t=e).field.canonicalString()} ${t.op} ${Gs(t.value)}`:e instanceof ca?(e=e).op.toString()+" {"+e.getFilters().map(ma).join(" ,")+"}":"Filter";var t}class pa extends ua{constructor(e,t,n){super(e,t,n),this.key=li.fromName(n.referenceValue)}matches(e){var t=li.comparator(e.key,this.key);return this.matchesComparison(t)}}class ya extends ua{constructor(e,t){super(e,"in",t),this.keys=wa(0,t)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}}class va extends ua{constructor(e,t){super(e,"not-in",t),this.keys=wa(0,t)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}}function wa(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map(e=>li.fromName(e.referenceValue))}class _a extends ua{constructor(e,t){super(e,"array-contains",t)}matches(e){var t=e.data.field(this.field);return Qs(t)&&Us(t.arrayValue,this.value)}}class ba extends ua{constructor(e,t){super(e,"in",t)}matches(e){var t=e.data.field(this.field);return null!==t&&Us(this.value.arrayValue,t)}}class Ia extends ua{constructor(e,t){super(e,"not-in",t)}matches(e){if(Us(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;var t=e.data.field(this.field);return null!==t&&!Us(this.value.arrayValue,t)}}class Ea extends ua{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!Qs(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>Us(this.value.arrayValue,e))}}class Ta{constructor(e,t=null,n=[],r=[],i=null,s=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=i,this.startAt=s,this.endAt=a,this.ue=null}}function Sa(e,t=null,n=[],r=[],i=null,s=null,a=null){return new Ta(e,t,n,r,i,s,a)}function xa(e){const t=e;if(null===t.ue){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map(e=>function t(e){if(e instanceof ua)return e.field.canonicalString()+e.op.toString()+Gs(e.value);if(da(e))return e.filters.map(e=>t(e)).join(",");var n=e.filters.map(e=>t(e)).join(",");return`${e.op}(${n})`}(e)).join(","),e+="|ob:",e+=t.orderBy.map(e=>function(e){return e.field.canonicalString()+e.dir}(e)).join(","),Vi(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map(e=>Gs(e)).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map(e=>Gs(e)).join(",")),t.ue=e}return t.ue}function Da(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let i=0;i<e.orderBy.length;i++)if(n=e.orderBy[i],r=t.orderBy[i],n.dir!==r.dir||!n.field.isEqual(r.field))return!1;var n,r;if(e.filters.length!==t.filters.length)return!1;for(let s=0;s<e.filters.length;s++)if(!function r(e,t){return e instanceof ua?(n=e,(s=t)instanceof ua&&n.op===s.op&&n.field.isEqual(s.field)&&qs(n.value,s.value)):e instanceof ca?(i=t)instanceof ca&&e.op===i.op&&e.filters.length===i.filters.length&&e.filters.reduce((e,t,n)=>e&&r(t,i.filters[n]),!0):void jr();var i,n,s}(e.filters[s],t.filters[s]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!sa(e.startAt,t.startAt)&&sa(e.endAt,t.endAt)}function Ca(e){return li.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function Aa(e,t){return e.filters.filter(e=>e instanceof ua&&e.field.isEqual(t))}function Na(t,n,r){let i=Vs,s=!0;for(const r of Aa(t,n)){let e=Vs,t=!0;switch(r.op){case"<":case"<=":e="nullValue"in(a=r.value)?Vs:"booleanValue"in a?{booleanValue:!1}:"integerValue"in a||"doubleValue"in a?{doubleValue:NaN}:"timestampValue"in a?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in a?{stringValue:""}:"bytesValue"in a?{bytesValue:""}:"referenceValue"in a?Ks(Os.empty(),li.empty()):"geoPointValue"in a?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in a?{arrayValue:{}}:"mapValue"in a?{mapValue:{}}:jr();break;case"==":case"in":case">=":e=r.value;break;case">":e=r.value,t=!1;break;case"!=":case"not-in":e=Vs}Zs({value:i,inclusive:s},{value:e,inclusive:t})<0&&(i=e,s=t)}var a;if(null!==r)for(let e=0;e<t.orderBy.length;++e)if(t.orderBy[e].field.isEqual(n)){const t=r.position[e];Zs({value:i,inclusive:s},{value:t,inclusive:r.inclusive})<0&&(i=t,s=r.inclusive);break}return{value:i,inclusive:s}}function ka(t,n,r){let i=Ps,s=!0;for(const r of Aa(t,n)){let e=Ps,t=!0;switch(r.op){case">=":case">":e="nullValue"in(a=r.value)?{booleanValue:!1}:"booleanValue"in a?{doubleValue:NaN}:"integerValue"in a||"doubleValue"in a?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in a?{stringValue:""}:"stringValue"in a?{bytesValue:""}:"bytesValue"in a?Ks(Os.empty(),li.empty()):"referenceValue"in a?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in a?{arrayValue:{}}:"arrayValue"in a?{mapValue:{}}:"mapValue"in a?Ps:jr(),t=!1;break;case"==":case"in":case"<=":e=r.value;break;case"<":e=r.value,t=!1;break;case"!=":case"not-in":e=Ps}0<ea({value:i,inclusive:s},{value:e,inclusive:t})&&(i=e,s=t)}var a;if(null!==r)for(let e=0;e<t.orderBy.length;++e)if(t.orderBy[e].field.isEqual(n)){const t=r.position[e];0<ea({value:i,inclusive:s},{value:t,inclusive:r.inclusive})&&(i=t,s=r.inclusive);break}return{value:i,inclusive:s}}class Ra{constructor(e,t=null,n=[],r=[],i=null,s="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.limitType=s,this.startAt=a,this.endAt=o,this.ce=null,this.le=null,this.he=null,this.startAt,this.endAt}}function Ma(e,t,n,r,i,s,a,o){return new Ra(e,t,n,r,i,s,a,o)}function La(e){return new Ra(e)}function Fa(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function Oa(e){return null!==e.collectionGroup}function Pa(t){const n=t;if(null===n.ce){n.ce=[];const t=new Set;for(const i of n.explicitOrderBy)n.ce.push(i),t.add(i.field.canonicalString());const r=0<n.explicitOrderBy.length?n.explicitOrderBy[n.explicitOrderBy.length-1].dir:"asc",e=function(e){let t=new Is(hi.comparator);return e.filters.forEach(e=>{e.getFlattenedFilters().forEach(e=>{e.isInequality()&&(t=t.add(e.field))})}),t}(n);e.forEach(e=>{t.has(e.canonicalString())||e.isKeyField()||n.ce.push(new aa(e,r))}),t.has(hi.keyField().canonicalString())||n.ce.push(new aa(hi.keyField(),r))}return n.ce}function Va(e){const t=e;return t.le||(t.le=function(e,t){if("F"===e.limitType)return Sa(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);{t=t.map(e=>{var t="desc"===e.dir?"asc":"desc";return new aa(e.field,t)});var n=e.endAt?new ra(e.endAt.position,e.endAt.inclusive):null,r=e.startAt?new ra(e.startAt.position,e.startAt.inclusive):null;return Sa(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}}(t,Pa(e))),t.le}function Ba(e,t){var n=e.filters.concat([t]);return new Ra(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function qa(e,t,n){return new Ra(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function Ua(e,t){return Da(Va(e),Va(t))&&e.limitType===t.limitType}function ja(e){return`${xa(Va(e))}|lt:${e.limitType}`}function za(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),0<e.filters.length&&(t+=`, filters: [${e.filters.map(e=>ma(e)).join(", ")}]`),Vi(e.limit)||(t+=", limit: "+e.limit),0<e.orderBy.length&&(t+=`, orderBy: [${e.orderBy.map(e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e)).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(e=>Gs(e)).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(e=>Gs(e)).join(",")),`Target(${t})`}(Va(e))}; limitType=${e.limitType})`}function Ga(e,t){return t.isFoundDocument()&&(i=e,a=(s=t).key.path,null!==i.collectionGroup?s.key.hasCollectionId(i.collectionGroup)&&i.path.isPrefixOf(a):li.isDocumentKey(i.path)?i.path.isEqual(a):i.path.isImmediateParentOf(a))&&function(e,t){for(const n of Pa(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return;return 1}(e,t)&&function(e,t){for(const n of e.filters)if(!n.matches(t))return;return 1}(e,t)&&(i=t,(!(t=e).startAt||(n=t.startAt,e=Pa(t),r=ia(n,e,i),n.inclusive?r<=0:r<0))&&(!t.endAt||(n=t.endAt,t=Pa(t),r=ia(n,t,i),n.inclusive?0<=r:0<r)));var n,r,i,s,a}function Ka(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function $a(i){return(e,t)=>{let n=!1;for(const r of Pa(i)){const i=function(e,t,n){var r=e.field.isKeyField()?li.comparator(t.key,n.key):function(e,t,n){var r=t.data.field(e),i=n.data.field(e);return null!==r&&null!==i?js(r,i):jr()}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return-1*r;default:return jr()}}(r,e,t);if(0!==i)return i;n=n||r.field.isKeyField()}return 0}}class Qa{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[t,r]of n)if(this.equalsFn(t,e))return r}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let i=0;i<r.length;i++)if(this.equalsFn(r[i][0],e))return void(r[i]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(r){ys(this.inner,(e,t)=>{for(const[e,n]of t)r(e,n)})}isEmpty(){return vs(this.inner)}size(){return this.innerSize}}const Ha=new ws(li.comparator);const Wa=new ws(li.comparator);function Ja(...e){let t=Wa;for(const n of e)t=t.insert(n.key,n);return t}function Ya(e){let n=Wa;return e.forEach((e,t)=>n=n.insert(e,t.overlayedDocument)),n}function Xa(){return new Qa(e=>e.toString(),(e,t)=>e.isEqual(t))}const Za=new ws(li.comparator),eo=new Is(li.comparator);function to(...e){let t=eo;for(const n of e)t=t.add(n);return t}const no=new Is(ni);function ro(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Bi(t)?"-0":t}}function io(e){return{integerValue:""+e}}function so(e,t){return qi(t)?io(t):ro(e,t)}class ao{constructor(){this._=void 0}}function oo(e,t){return e instanceof go?$s(e=t)||(e=e)&&"doubleValue"in e?t:{integerValue:0}:null}class uo extends ao{}class co extends ao{constructor(e){super(),this.elements=e}}function ho(e,t){const n=po(t);for(const t of e.elements)n.some(e=>qs(e,t))||n.push(t);return{arrayValue:{values:n}}}class lo extends ao{constructor(e){super(),this.elements=e}}function fo(e,t){let n=po(t);for(const t of e.elements)n=n.filter(e=>!qs(e,t));return{arrayValue:{values:n}}}class go extends ao{constructor(e,t){super(),this.serializer=e,this.Pe=t}}function mo(e){return Ns(e.integerValue||e.doubleValue)}function po(e){return Qs(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class yo{constructor(e,t){this.field=e,this.transform=t}}class vo{constructor(e,t){this.version=e,this.transformResults=t}}class wo{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new wo}static exists(e){return new wo(void 0,e)}static updateTime(e){return new wo(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function _o(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class bo{}function Io(e,n){if(!e.hasLocalMutations||n&&0===n.fields.length)return null;if(null===n)return e.isNoDocument()?new ko(e.key,wo.none()):new xo(e.key,e.data,wo.none());{const i=e.data,s=ta.empty();let t=new Is(hi.comparator);for(var r of n.fields)if(!t.has(r)){let e=i.field(r);null===e&&1<r.length&&(r=r.popLast(),e=i.field(r)),null===e?s.delete(r):s.set(r,e),t=t.add(r)}return new Do(e.key,s,new Ss(t.toArray()),wo.none())}}function Eo(e,t,n){e instanceof xo?function(e,t,n){const r=e.value.clone(),i=Ao(e.fieldTransforms,t,n.transformResults);r.setAll(i),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof Do?function(e,t,n){if(!_o(e.precondition,t))return t.convertToUnknownDocument(n.version);const r=Ao(e.fieldTransforms,t,n.transformResults),i=t.data;i.setAll(Co(e)),i.setAll(r),t.convertToFoundDocument(n.version,i).setHasCommittedMutations()}(e,t,n):t.convertToNoDocument(n.version).setHasCommittedMutations()}function To(e,t,n,r){return e instanceof xo?function(e,t,n,r){if(!_o(e.precondition,t))return n;const i=e.value.clone(),s=No(e.fieldTransforms,r,t);return i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null}(e,t,n,r):e instanceof Do?function(e,t,n,r){if(!_o(e.precondition,t))return n;const i=No(e.fieldTransforms,r,t),s=t.data;return s.setAll(Co(e)),s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null===n?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map(e=>e.field))}(e,t,n,r):(t=t,n=n,_o(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n)}function So(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(n=e.fieldTransforms,r=t.fieldTransforms,!!(void 0===n&&void 0===r||n&&r&&ri(n,r,(e,t)=>function(e,t){return e.field.isEqual(t.field)&&(e=e.transform,t=t.transform,e instanceof co&&t instanceof co||e instanceof lo&&t instanceof lo?ri(e.elements,t.elements,qs):e instanceof go&&t instanceof go?qs(e.Pe,t.Pe):e instanceof uo&&t instanceof uo)}(e,t)))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask)));var n,r}class xo extends bo{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class Do extends bo{constructor(e,t,n,r,i=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=i,this.type=1}getFieldMask(){return this.fieldMask}}function Co(n){const r=new Map;return n.fieldMask.fields.forEach(e=>{var t;e.isEmpty()||(t=n.data.field(e),r.set(e,t))}),r}function Ao(e,t,n){const r=new Map;zr(e.length===n.length);for(let h=0;h<n.length;h++){var i=e[h],s=i.transform,a=t.data.field(i.field);r.set(i.field,(o=s,u=a,c=n[h],o instanceof co?ho(o,u):o instanceof lo?fo(o,u):c))}var o,u,c;return r}function No(e,t,n){const r=new Map;for(const c of e){const e=c.transform,h=n.data.field(c.field);r.set(c.field,(i=e,s=h,a=t,u=o=void 0,i instanceof uo?function(e,t){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return(t=t&&Rs(t)?Ms(t):t)&&(n.fields.__previous_value__=t),{mapValue:n}}(a,s):i instanceof co?ho(i,s):i instanceof lo?fo(i,s):(o=oo(i=i,s),u=mo(o)+mo(i.Pe),$s(o)&&$s(i.Pe)?io(u):ro(i.serializer,u))))}var i,s,a,o,u;return r}class ko extends bo{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Ro extends bo{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class Mo{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){var n=t.mutationResults;for(let r=0;r<this.mutations.length;r++){const i=this.mutations[r];i.key.isEqual(e.key)&&Eo(i,e,n[r])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=To(n,e,t,this.localWriteTime));for(const r of this.mutations)r.key.isEqual(e.key)&&(t=To(r,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(s,a){const o=Xa();return this.mutations.forEach(e=>{const t=s.get(e.key),n=t.overlayedDocument;let r=this.applyToLocalView(n,t.mutatedFields);r=a.has(e.key)?null:r;var i=Io(n,r);null!==i&&o.set(e.key,i),n.isValidDocument()||n.convertToNoDocument(ai.min())}),o}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),to())}isEqual(e){return this.batchId===e.batchId&&ri(this.mutations,e.mutations,(e,t)=>So(e,t))&&ri(this.baseMutations,e.baseMutations,(e,t)=>So(e,t))}}class Lo{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){zr(e.mutations.length===n.length);let r=Za;var i=e.mutations;for(let s=0;s<i.length;s++)r=r.insert(i[s].key,n[s].version);return new Lo(e,t,n,r)}}class Fo{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class Oo{constructor(e,t){this.count=e,this.unchangedNames=t}}function Po(e){switch(e){default:return jr();case Gr.CANCELLED:case Gr.UNKNOWN:case Gr.DEADLINE_EXCEEDED:case Gr.RESOURCE_EXHAUSTED:case Gr.INTERNAL:case Gr.UNAVAILABLE:case Gr.UNAUTHENTICATED:return!1;case Gr.INVALID_ARGUMENT:case Gr.NOT_FOUND:case Gr.ALREADY_EXISTS:case Gr.PERMISSION_DENIED:case Gr.FAILED_PRECONDITION:case Gr.ABORTED:case Gr.OUT_OF_RANGE:case Gr.UNIMPLEMENTED:case Gr.DATA_LOSS:return!0}}function Vo(e){if(void 0===e)return Br("GRPC error has no .code"),Gr.UNKNOWN;switch(e){case wr.OK:return Gr.OK;case wr.CANCELLED:return Gr.CANCELLED;case wr.UNKNOWN:return Gr.UNKNOWN;case wr.DEADLINE_EXCEEDED:return Gr.DEADLINE_EXCEEDED;case wr.RESOURCE_EXHAUSTED:return Gr.RESOURCE_EXHAUSTED;case wr.INTERNAL:return Gr.INTERNAL;case wr.UNAVAILABLE:return Gr.UNAVAILABLE;case wr.UNAUTHENTICATED:return Gr.UNAUTHENTICATED;case wr.INVALID_ARGUMENT:return Gr.INVALID_ARGUMENT;case wr.NOT_FOUND:return Gr.NOT_FOUND;case wr.ALREADY_EXISTS:return Gr.ALREADY_EXISTS;case wr.PERMISSION_DENIED:return Gr.PERMISSION_DENIED;case wr.FAILED_PRECONDITION:return Gr.FAILED_PRECONDITION;case wr.ABORTED:return Gr.ABORTED;case wr.OUT_OF_RANGE:return Gr.OUT_OF_RANGE;case wr.UNIMPLEMENTED:return Gr.UNIMPLEMENTED;case wr.DATA_LOSS:return Gr.DATA_LOSS;default:return jr()}}function Bo(){return new TextEncoder}(rt=wr=wr||{})[rt.OK=0]="OK",rt[rt.CANCELLED=1]="CANCELLED",rt[rt.UNKNOWN=2]="UNKNOWN",rt[rt.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",rt[rt.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",rt[rt.NOT_FOUND=5]="NOT_FOUND",rt[rt.ALREADY_EXISTS=6]="ALREADY_EXISTS",rt[rt.PERMISSION_DENIED=7]="PERMISSION_DENIED",rt[rt.UNAUTHENTICATED=16]="UNAUTHENTICATED",rt[rt.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",rt[rt.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",rt[rt.ABORTED=10]="ABORTED",rt[rt.OUT_OF_RANGE=11]="OUT_OF_RANGE",rt[rt.UNIMPLEMENTED=12]="UNIMPLEMENTED",rt[rt.INTERNAL=13]="INTERNAL",rt[rt.UNAVAILABLE=14]="UNAVAILABLE",rt[rt.DATA_LOSS=15]="DATA_LOSS";const qo=new Rr([4294967295,4294967295],0);function Uo(e){const t=Bo().encode(e),n=new kr;return n.update(t),new Uint8Array(n.digest())}function jo(e){const t=new DataView(e.buffer),n=t.getUint32(0,!0),r=t.getUint32(4,!0),i=t.getUint32(8,!0),s=t.getUint32(12,!0);return[new Rr([n,r],0),new Rr([i,s],0)]}class zo{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||8<=t)throw new Go(`Invalid padding: ${t}`);if(n<0)throw new Go(`Invalid hash count: ${n}`);if(0<e.length&&0===this.hashCount)throw new Go(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new Go(`Invalid padding when bitmap length is 0: ${t}`);this.Ie=8*e.length-t,this.Te=Rr.fromNumber(this.Ie)}Ee(e,t,n){let r=e.add(t.multiply(Rr.fromNumber(n)));return 1===r.compare(qo)&&(r=new Rr([r.getBits(0),r.getBits(1)],0)),r.modulo(this.Te).toNumber()}de(e){return 0!=(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.Ie)return!1;const t=Uo(e),[n,r]=jo(t);for(let i=0;i<this.hashCount;i++){const t=this.Ee(n,r,i);if(!this.de(t))return!1}return!0}static create(e,t,n){const r=e%8==0?0:8-e%8,i=new Uint8Array(Math.ceil(e/8)),s=new zo(i,r,t);return n.forEach(e=>s.insert(e)),s}insert(t){if(0!==this.Ie){const n=Uo(t),[r,i]=jo(n);for(let e=0;e<this.hashCount;e++){const n=this.Ee(r,i,e);this.Ae(n)}}}Ae(e){var t=Math.floor(e/8);this.bitmap[t]|=1<<e%8}}class Go extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class Ko{constructor(e,t,n,r,i){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const r=new Map;return r.set(e,$o.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new Ko(ai.min(),r,new ws(ni),Ha,to())}}class $o{constructor(e,t,n,r,i){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new $o(n,t,to(),to(),to())}}class Qo{constructor(e,t,n,r){this.Re=e,this.removedTargetIds=t,this.key=n,this.Ve=r}}class Ho{constructor(e,t){this.targetId=e,this.me=t}}class Wo{constructor(e,t,n=Ds.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class Jo{constructor(){this.fe=0,this.ge=Zo(),this.pe=Ds.EMPTY_BYTE_STRING,this.ye=!1,this.we=!0}get current(){return this.ye}get resumeToken(){return this.pe}get Se(){return 0!==this.fe}get be(){return this.we}De(e){0<e.approximateByteSize()&&(this.we=!0,this.pe=e)}Ce(){let n=to(),r=to(),i=to();return this.ge.forEach((e,t)=>{switch(t){case 0:n=n.add(e);break;case 2:r=r.add(e);break;case 1:i=i.add(e);break;default:jr()}}),new $o(this.pe,this.ye,n,r,i)}ve(){this.we=!1,this.ge=Zo()}Fe(e,t){this.we=!0,this.ge=this.ge.insert(e,t)}Me(e){this.we=!0,this.ge=this.ge.remove(e)}xe(){this.fe+=1}Oe(){--this.fe,zr(0<=this.fe)}Ne(){this.we=!0,this.ye=!0}}class Yo{constructor(e){this.Le=e,this.Be=new Map,this.ke=Ha,this.qe=Xo(),this.Qe=new ws(ni)}Ke(e){for(const t of e.Re)e.Ve&&e.Ve.isFoundDocument()?this.$e(t,e.Ve):this.Ue(t,e.key,e.Ve);for(const n of e.removedTargetIds)this.Ue(n,e.key,e.Ve)}We(n){this.forEachTarget(n,e=>{const t=this.Ge(e);switch(n.state){case 0:this.ze(e)&&t.De(n.resumeToken);break;case 1:t.Oe(),t.Se||t.ve(),t.De(n.resumeToken);break;case 2:t.Oe(),t.Se||this.removeTarget(e);break;case 3:this.ze(e)&&(t.Ne(),t.De(n.resumeToken));break;case 4:this.ze(e)&&(this.je(e),t.De(n.resumeToken));break;default:jr()}})}forEachTarget(e,n){0<e.targetIds.length?e.targetIds.forEach(n):this.Be.forEach((e,t)=>{this.ze(t)&&n(t)})}He(e){const t=e.targetId,n=e.me.count,r=this.Je(t);if(r){var i=r.target;if(Ca(i))if(0===n){const e=new li(i.path);this.Ue(t,e,na.newNoDocument(e,ai.min()))}else zr(1===n);else{const r=this.Ye(t);if(r!==n){const n=this.Ze(e),s=n?this.Xe(n,e,r):1;if(0!==s){this.je(t);const e=2===s?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Qe=this.Qe.insert(t,e)}}}}}Ze(e){var t=e.me.unchangedNames;if(!t||!t.bits)return null;var{bits:{bitmap:n="",padding:r=0},hashCount:t=0}=t;let i,s;try{i=ks(n).toUint8Array()}catch(e){if(e instanceof xs)return qr("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{s=new zo(i,r,t)}catch(e){return qr(e instanceof Go?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===s.Ie?null:s}Xe(e,t,n){return t.me.count===n-this.nt(e,t.targetId)?0:2}nt(n,r){const e=this.Le.getRemoteKeysForTarget(r);let i=0;return e.forEach(e=>{var t=this.Le.tt(),t=`projects/${t.projectId}/databases/${t.database}/documents/${e.path.canonicalString()}`;n.mightContain(t)||(this.Ue(r,e,null),i++)}),i}rt(r){const i=new Map;this.Be.forEach((e,t)=>{var n=this.Je(t);if(n){if(e.current&&Ca(n.target)){const i=new li(n.target.path);null!==this.ke.get(i)||this.it(t,i)||this.Ue(t,i,na.newNoDocument(i,r))}e.be&&(i.set(t,e.Ce()),e.ve())}});let s=to();this.qe.forEach((e,t)=>{let n=!0;t.forEachWhile(e=>{var t=this.Je(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(n=!1)}),n&&(s=s.add(e))}),this.ke.forEach((e,t)=>t.setReadTime(r));var e=new Ko(r,i,this.Qe,this.ke,s);return this.ke=Ha,this.qe=Xo(),this.Qe=new ws(ni),e}$e(e,t){var n;this.ze(e)&&(n=this.it(e,t.key)?2:0,this.Ge(e).Fe(t.key,n),this.ke=this.ke.insert(t.key,t),this.qe=this.qe.insert(t.key,this.st(t.key).add(e)))}Ue(e,t,n){if(this.ze(e)){const r=this.Ge(e);this.it(e,t)?r.Fe(t,1):r.Me(t),this.qe=this.qe.insert(t,this.st(t).delete(e)),n&&(this.ke=this.ke.insert(t,n))}}removeTarget(e){this.Be.delete(e)}Ye(e){var t=this.Ge(e).Ce();return this.Le.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}xe(e){this.Ge(e).xe()}Ge(e){let t=this.Be.get(e);return t||(t=new Jo,this.Be.set(e,t)),t}st(e){let t=this.qe.get(e);return t||(t=new Is(ni),this.qe=this.qe.insert(e,t)),t}ze(e){var t=null!==this.Je(e);return t||Vr("WatchChangeAggregator","Detected inactive target",e),t}Je(e){var t=this.Be.get(e);return t&&t.Se?null:this.Le.ot(e)}je(t){this.Be.set(t,new Jo),this.Le.getRemoteKeysForTarget(t).forEach(e=>{this.Ue(t,e,null)})}it(e,t){return this.Le.getRemoteKeysForTarget(e).has(t)}}function Xo(){return new ws(li.comparator)}function Zo(){return new ws(li.comparator)}const eu={asc:"ASCENDING",desc:"DESCENDING"},tu={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},nu={and:"AND",or:"OR"};class ru{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function iu(e,t){return e.useProto3Json||Vi(t)?t:{value:t}}function su(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function au(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function ou(e){return zr(!!e),ai.fromTimestamp((t=As(e),new si(t.seconds,t.nanos)));var t}function uu(e,t){return cu(e,t).canonicalString()}function cu(e,t){const n=(e=e,new ui(["projects",e.projectId,"databases",e.database]).child("documents"));return void 0===t?n:n.child(t)}function hu(e){var t=ui.fromString(e);return zr(Cu(t)),t}function lu(e,t){return uu(e.databaseId,t.path)}function du(e,t){const n=hu(t);if(n.get(1)!==e.databaseId.projectId)throw new Kr(Gr.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new Kr(Gr.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new li(pu(n))}function fu(e,t){return uu(e.databaseId,t)}function gu(e){var t=hu(e);return 4===t.length?ui.emptyPath():pu(t)}function mu(e){return new ui(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function pu(e){return zr(4<e.length&&"documents"===e.get(4)),e.popFirst(5)}function yu(e,t,n){return{name:lu(e,t),fields:n.value.mapValue.fields}}function vu(e,t,n){const r=du(e,t.name),i=ou(t.updateTime),s=t.createTime?ou(t.createTime):ai.min(),a=new ta({mapValue:{fields:t.fields}}),o=na.newFoundDocument(r,i,s,a);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function wu(e,t){let n;if(t instanceof xo)n={update:yu(e,t.key,t.value)};else if(t instanceof ko)n={delete:lu(e,t.key)};else if(t instanceof Do)n={update:yu(e,t.key,t.data),updateMask:function(e){const t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}(t.fieldMask)};else{if(!(t instanceof Ro))return jr();n={verify:lu(e,t.key)}}return 0<t.fieldTransforms.length&&(n.updateTransforms=t.fieldTransforms.map(e=>function(e){var t=e.transform;if(t instanceof uo)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(t instanceof co)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:t.elements}};if(t instanceof lo)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:t.elements}};if(t instanceof go)return{fieldPath:e.field.canonicalString(),increment:t.Pe};throw jr()}(e))),t.precondition.isNone||(n.currentDocument=(r=e,void 0!==(e=t.precondition).updateTime?{updateTime:(t=e.updateTime,su(r,t.toTimestamp()))}:void 0!==e.exists?{exists:e.exists}:jr())),n;var r}function _u(t,e){const n=e.currentDocument?void 0!==(i=e.currentDocument).updateTime?wo.updateTime(ou(i.updateTime)):void 0!==i.exists?wo.exists(i.exists):wo.none():wo.none(),r=e.updateTransforms?e.updateTransforms.map(e=>function(e,t){let n=null;if("setToServerValue"in t)zr("REQUEST_TIME"===t.setToServerValue),n=new uo;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new co(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new lo(e)}else"increment"in t?n=new go(e,t.increment):jr();var r=hi.fromServerFormat(t.fieldPath);return new yo(r,n)}(t,e)):[];var i;if(e.update){e.update.name;var s=du(t,e.update.name),a=new ta({mapValue:{fields:e.update.fields}});if(e.updateMask){const t=function(e){const t=e.fieldPaths||[];return new Ss(t.map(e=>hi.fromServerFormat(e)))}(e.updateMask);return new Do(s,a,t,n,r)}return new xo(s,a,n,r)}if(e.delete){const r=du(t,e.delete);return new ko(r,n)}if(e.verify){const r=du(t,e.verify);return new Ro(r,n)}return jr()}function bu(e,t){return{documents:[fu(e,t.path)]}}function Iu(e,t){const n={structuredQuery:{}},r=t.path;let i;null!==t.collectionGroup?(i=r,n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(i=r.popLast(),n.structuredQuery.from=[{collectionId:r.lastSegment()}]),n.parent=fu(e,i);var s=function(e){if(0!==e.length)return function n(e){return e instanceof ua?function(e){if("=="===e.op){if(Ws(e.value))return{unaryFilter:{field:xu(e.field),op:"IS_NAN"}};if(Hs(e.value))return{unaryFilter:{field:xu(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(Ws(e.value))return{unaryFilter:{field:xu(e.field),op:"IS_NOT_NAN"}};if(Hs(e.value))return{unaryFilter:{field:xu(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:xu(e.field),op:Tu(e.op),value:e.value}}}(e):e instanceof ca?function(e){const t=e.getFilters().map(e=>n(e));return 1===t.length?t[0]:{compositeFilter:{op:Su(e.op),filters:t}}}(e):jr()}(ca.create(e,"and"))}(t.filters);s&&(n.structuredQuery.where=s);s=function(e){if(0!==e.length)return e.map(e=>function(e){return{field:xu(e.field),direction:(e=e.dir,eu[e])}}(e))}(t.orderBy);s&&(n.structuredQuery.orderBy=s);s=iu(e,t.limit);return null!==s&&(n.structuredQuery.limit=s),t.startAt&&(n.structuredQuery.startAt={before:(e=t.startAt).inclusive,values:e.position}),t.endAt&&(n.structuredQuery.endAt={before:!(t=t.endAt).inclusive,values:t.position}),{_t:n,parent:i}}function Eu(e){let t=gu(e.parent);var n,r,i,s=e.structuredQuery,a=s.from?s.from.length:0;let o=null;if(0<a){zr(1===a);const f=s.from[0];f.allDescendants?o=f.collectionId:t=t.child(f.collectionId)}let u=[];s.where&&(u=function(e){const t=function t(e){return void 0!==e.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":const t=Du(e.unaryFilter.field);return ua.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=Du(e.unaryFilter.field);return ua.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=Du(e.unaryFilter.field);return ua.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const i=Du(e.unaryFilter.field);return ua.create(i,"!=",{nullValue:"NULL_VALUE"});default:return jr()}}(e):void 0!==e.fieldFilter?function(e){return ua.create(Du(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return jr()}}(e.fieldFilter.op),e.fieldFilter.value)}(e):void 0!==e.compositeFilter?function(e){return ca.create(e.compositeFilter.filters.map(e=>t(e)),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return jr()}}(e.compositeFilter.op))}(e):jr()}(e);return t instanceof ca&&da(t)?t.getFilters():[t]}(s.where));let c=[];s.orderBy&&(c=s.orderBy.map(e=>function(e){return new aa(Du(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))}(e)));let h=null;s.limit&&(h=(e=s.limit,Vi(n="object"==typeof e?e.value:e)?null:n));let l=null;s.startAt&&(l=(r=s.startAt,i=!!r.before,n=r.values||[],new ra(n,i)));let d=null;return s.endAt&&(d=(r=s.endAt,i=!r.before,s=r.values||[],new ra(s,i))),Ma(t,o,c,u,h,"F",l,d)}function Tu(e){return tu[e]}function Su(e){return nu[e]}function xu(e){return{fieldPath:e.canonicalString()}}function Du(e){return hi.fromServerFormat(e.fieldPath)}function Cu(e){return 4<=e.length&&"projects"===e.get(0)&&"databases"===e.get(2)}class Au{constructor(e,t,n,r,i=ai.min(),s=ai.min(),a=Ds.EMPTY_BYTE_STRING,o=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=s,this.resumeToken=a,this.expectedCount=o}withSequenceNumber(e){return new Au(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new Au(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new Au(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new Au(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class Nu{constructor(e){this.ut=e}}function ku(e,t){const n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:Ru(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document={name:lu(i=e.ut,(e=t).key),fields:e.data.value.mapValue.fields,updateTime:su(i,e.version.toTimestamp()),createTime:su(i,e.createTime.toTimestamp())};else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:Mu(t.version)};else{if(!t.isUnknownDocument())return jr();r.unknownDocument={path:n.path.toArray(),version:Mu(t.version)}}var i;return r}function Ru(e){var t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function Mu(e){var t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function Lu(e){var t=new si(e.seconds,e.nanoseconds);return ai.fromTimestamp(t)}function Fu(t,e){const n=(e.baseMutations||[]).map(e=>_u(t.ut,e));for(let s=0;s<e.mutations.length-1;++s){const n=e.mutations[s];if(s+1<e.mutations.length&&void 0!==e.mutations[s+1].transform){const r=e.mutations[s+1];n.updateTransforms=r.transform.fieldTransforms,e.mutations.splice(s+1,1),++s}}const r=e.mutations.map(e=>_u(t.ut,e)),i=si.fromMillis(e.localWriteTimeMs);return new Mo(e.batchId,i,n,r)}function Ou(e){var t,n=Lu(e.readTime),r=void 0!==e.lastLimboFreeSnapshotVersion?Lu(e.lastLimboFreeSnapshotVersion):ai.min(),i=void 0!==e.query.documents?(zr(1===(t=e.query).documents.length),Va(La(gu(t.documents[0])))):Va(Eu(e.query));return new Au(i,e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,n,r,Ds.fromBase64String(e.resumeToken))}function Pu(e,t){var n=Mu(t.snapshotVersion),r=Mu(t.lastLimboFreeSnapshotVersion),i=Ca(t.target)?bu(e.ut,t.target):Iu(e.ut,t.target)._t,s=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:xa(t.target),readTime:n,resumeToken:s,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:i}}function Vu(e){var t=Eu({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?qa(t,t.limit,"L"):t}function Bu(e,t){return new Fo(t.largestBatchId,_u(e.ut,t.overlayMutation))}function qu(e,t){var n=t.path.lastSegment();return[e,Ui(t.path.popLast()),n]}function Uu(e,t,n,r){return{indexId:e,uid:t,sequenceNumber:n,readTime:Mu(r.readTime),documentKey:Ui(r.documentKey.path),largestBatchId:r.largestBatchId}}class ju{getBundleMetadata(e,t){return zu(e).get(t).next(e=>{if(e)return{id:(e=e).bundleId,createTime:Lu(e.createTime),version:e.version}})}saveBundleMetadata(e,t){return zu(e).put({bundleId:(t=t).id,createTime:Mu(ou(t.createTime)),version:t.version})}getNamedQuery(e,t){return Gu(e).get(t).next(e=>{if(e)return{name:(e=e).name,query:Vu(e.bundledQuery),readTime:Lu(e.readTime)}})}saveNamedQuery(e,t){return Gu(e).put({name:(t=t).name,readTime:Mu(ou(t.readTime)),bundledQuery:t.bundledQuery})}}function zu(e){return ms(e,"bundles")}function Gu(e){return ms(e,"namedQueries")}class Ku{constructor(e,t){this.serializer=e,this.userId=t}static ct(e,t){var n=t.uid||"";return new Ku(e,n)}getOverlay(e,t){return $u(e).get(qu(this.userId,t)).next(e=>e?Bu(this.serializer,e):null)}getOverlays(e,t){const n=Xa();return Ti.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(r,i,e){const s=[];return e.forEach((e,t)=>{var n=new Fo(i,t);s.push(this.lt(r,n))}),Ti.waitFor(s)}removeOverlaysForBatchId(n,e,r){const t=new Set;e.forEach(e=>t.add(Ui(e.getCollectionPath())));const i=[];return t.forEach(e=>{var t=IDBKeyRange.bound([this.userId,e,r],[this.userId,e,r+1],!1,!0);i.push($u(n).j("collectionPathOverlayIndex",t))}),Ti.waitFor(i)}getOverlaysForCollection(e,t,n){const r=Xa(),i=Ui(t),s=IDBKeyRange.bound([this.userId,i,n],[this.userId,i,Number.POSITIVE_INFINITY],!0);return $u(e).U("collectionPathOverlayIndex",s).next(e=>{for(const t of e){const e=Bu(this.serializer,t);r.set(e.getKey(),e)}return r})}getOverlaysForCollectionGroup(e,t,n,i){const s=Xa();let a;var r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return $u(e).J({index:"collectionGroupOverlayIndex",range:r},(e,t,n)=>{const r=Bu(this.serializer,t);s.size()<i||r.largestBatchId===a?(s.set(r.getKey(),r),a=r.largestBatchId):n.done()}).next(()=>s)}lt(e,t){return $u(e).put(function(e,t,n){var[,r,i]=qu(t,n.mutation.key);return{userId:t,collectionPath:r,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:wu(e.ut,n.mutation)}}(this.serializer,this.userId,t))}}function $u(e){return ms(e,"documentOverlays")}class Qu{constructor(){}ht(e,t){this.Pt(e,t),t.It()}Pt(t,n){if("nullValue"in t)this.Tt(n,5);else if("booleanValue"in t)this.Tt(n,10),n.Et(t.booleanValue?1:0);else if("integerValue"in t)this.Tt(n,15),n.Et(Ns(t.integerValue));else if("doubleValue"in t){var e=Ns(t.doubleValue);isNaN(e)?this.Tt(n,13):(this.Tt(n,15),Bi(e)?n.Et(0):n.Et(e))}else if("timestampValue"in t){let e=t.timestampValue;this.Tt(n,20),"string"==typeof e&&(e=As(e)),n.dt(`${e.seconds||""}`),n.Et(e.nanos||0)}else"stringValue"in t?(this.At(t.stringValue,n),this.Rt(n)):"bytesValue"in t?(this.Tt(n,30),n.Vt(ks(t.bytesValue)),this.Rt(n)):"referenceValue"in t?this.ft(t.referenceValue,n):"geoPointValue"in t?(e=t.geoPointValue,this.Tt(n,45),n.Et(e.latitude||0),n.Et(e.longitude||0)):"mapValue"in t?Xs(t)?this.Tt(n,Number.MAX_SAFE_INTEGER):(this.gt(t.mapValue,n),this.Rt(n)):"arrayValue"in t?(this.yt(t.arrayValue,n),this.Rt(n)):jr()}At(e,t){this.Tt(t,25),this.wt(e,t)}wt(e,t){t.dt(e)}gt(e,t){var n=e.fields||{};this.Tt(t,55);for(const e of Object.keys(n))this.At(e,t),this.Pt(n[e],t)}yt(e,t){var n=e.values||[];this.Tt(t,50);for(const e of n)this.Pt(e,t)}ft(e,t){this.Tt(t,37),li.fromName(e).path.forEach(e=>{this.Tt(t,60),this.wt(e,t)})}Tt(e,t){e.Et(t)}Rt(e){e.Et(2)}}function Hu(e){var t=64-function(e){let t=0;for(let r=0;r<8;++r){var n=function(e){if(0===e)return 8;let t=0;return e>>4==0&&(t+=4,e<<=4),e>>6==0&&(t+=2,e<<=2),e>>7==0&&(t+=1),t}(255&e[r]);if(t+=n,8!==n)break}return t}(e);return Math.ceil(t/8)}Qu.St=new Qu;class Wu{constructor(){this.buffer=new Uint8Array(1024),this.position=0}bt(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Dt(n.value),n=t.next();this.Ct()}vt(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ft(n.value),n=t.next();this.Mt()}xt(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Dt(e);else if(e<2048)this.Dt(960|e>>>6),this.Dt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Dt(480|e>>>12),this.Dt(128|63&e>>>6),this.Dt(128|63&e);else{const e=t.codePointAt(0);this.Dt(240|e>>>18),this.Dt(128|63&e>>>12),this.Dt(128|63&e>>>6),this.Dt(128|63&e)}}this.Ct()}Ot(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ft(e);else if(e<2048)this.Ft(960|e>>>6),this.Ft(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ft(480|e>>>12),this.Ft(128|63&e>>>6),this.Ft(128|63&e);else{const e=t.codePointAt(0);this.Ft(240|e>>>18),this.Ft(128|63&e>>>12),this.Ft(128|63&e>>>6),this.Ft(128|63&e)}}this.Mt()}Nt(e){var t=this.Lt(e),n=Hu(t);this.Bt(1+n),this.buffer[this.position++]=255&n;for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=255&t[r]}kt(e){var t=this.Lt(e),n=Hu(t);this.Bt(1+n),this.buffer[this.position++]=~(255&n);for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=~(255&t[r])}qt(){this.Qt(255),this.Qt(255)}Kt(){this.$t(255),this.$t(255)}reset(){this.position=0}seed(e){this.Bt(e.length),this.buffer.set(e,this.position),this.position+=e.length}Ut(){return this.buffer.slice(0,this.position)}Lt(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=0!=(128&t[0]);t[0]^=n?255:128;for(let r=1;r<t.length;++r)t[r]^=n?255:0;return t}Dt(e){var t=255&e;0==t?(this.Qt(0),this.Qt(255)):255==t?(this.Qt(255),this.Qt(0)):this.Qt(t)}Ft(e){var t=255&e;0==t?(this.$t(0),this.$t(255)):255==t?(this.$t(255),this.$t(0)):this.$t(e)}Ct(){this.Qt(0),this.Qt(1)}Mt(){this.$t(0),this.$t(1)}Qt(e){this.Bt(1),this.buffer[this.position++]=e}$t(e){this.Bt(1),this.buffer[this.position++]=~e}Bt(e){var t=e+this.position;if(!(t<=this.buffer.length)){let e=2*this.buffer.length;e<t&&(e=t);const n=new Uint8Array(e);n.set(this.buffer),this.buffer=n}}}class Ju{constructor(e){this.Wt=e}Vt(e){this.Wt.bt(e)}dt(e){this.Wt.xt(e)}Et(e){this.Wt.Nt(e)}It(){this.Wt.qt()}}class Yu{constructor(e){this.Wt=e}Vt(e){this.Wt.vt(e)}dt(e){this.Wt.Ot(e)}Et(e){this.Wt.kt(e)}It(){this.Wt.Kt()}}class Xu{constructor(){this.Wt=new Wu,this.Gt=new Ju(this.Wt),this.zt=new Yu(this.Wt)}seed(e){this.Wt.seed(e)}jt(e){return 0===e?this.Gt:this.zt}Ut(){return this.Wt.Ut()}reset(){this.Wt.reset()}}class Zu{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}Ht(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new Zu(this.indexId,this.documentKey,this.arrayValue,n)}}function ec(e,t){let n=e.indexId-t.indexId;return 0!==n?n:(n=tc(e.arrayValue,t.arrayValue),0!==n?n:(n=tc(e.directionalValue,t.directionalValue),0!==n?n:li.comparator(e.documentKey,t.documentKey)))}function tc(e,t){for(let r=0;r<e.length&&r<t.length;++r){var n=e[r]-t[r];if(0!=n)return n}return e.length-t.length}class nc{constructor(e){this.Jt=new Is((e,t)=>hi.comparator(e.field,t.field)),this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.Yt=e.orderBy,this.Zt=[];for(const t of e.filters){const e=t;e.isInequality()?this.Jt=this.Jt.add(e):this.Zt.push(e)}}get Xt(){return 1<this.Jt.size}en(e){if(zr(e.collectionGroup===this.collectionId),this.Xt)return!1;const t=fi(e);if(void 0!==t&&!this.tn(t))return!1;const n=gi(e);let r=new Set,i=0,s=0;for(;i<n.length&&this.tn(n[i]);++i)r=r.add(n[i].fieldPath.canonicalString());if(i===n.length)return!0;if(0<this.Jt.size){const e=this.Jt.getIterator().getNext();if(!r.has(e.field.canonicalString())){const t=n[i];if(!this.nn(e,t)||!this.rn(this.Yt[s++],t))return!1}++i}for(;i<n.length;++i){const e=n[i];if(s>=this.Yt.length||!this.rn(this.Yt[s++],e))return!1}return!0}sn(){if(this.Xt)return null;let e=new Is(hi.comparator);const t=[];for(const n of this.Zt)n.field.isKeyField()||("array-contains"===n.op||"array-contains-any"===n.op?t.push(new mi(n.field,2)):e.has(n.field)||(e=e.add(n.field),t.push(new mi(n.field,0))));for(const r of this.Yt)r.field.isKeyField()||e.has(r.field)||(e=e.add(r.field),t.push(new mi(r.field,"asc"===r.dir?0:1)));return new di(di.UNKNOWN_ID,this.collectionId,t,pi.empty())}tn(e){for(const t of this.Zt)if(this.nn(t,e))return!0;return!1}nn(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;var n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind==n}rn(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function rc(e){if(0===e.getFilters().length)return[];const t=function t(e){if(zr(e instanceof ua||e instanceof ca),e instanceof ua)return e;if(1===e.filters.length)return t(e.filters[0]);const n=e.filters.map(e=>t(e));let r=ca.create(n,e.op);return r=cc(r),ac(r)?r:(zr(r instanceof ca),zr(ha(r)),zr(1<r.filters.length),r.filters.reduce((e,t)=>oc(e,t)))}(function t(n){var e;if(zr(n instanceof ua||n instanceof ca),n instanceof ua){if(n instanceof ba){const r=(null===(e=null===(e=n.value.arrayValue)||void 0===e?void 0:e.values)||void 0===e?void 0:e.map(e=>ua.create(n.field,"==",e)))||[];return ca.create(r,"or")}return n}const r=n.filters.map(e=>t(e));return ca.create(r,n.op)}(e));return zr(ac(t)),ic(t)||sc(t)?[t]:t.getFilters()}function ic(e){return e instanceof ua}function sc(e){return e instanceof ca&&da(e)}function ac(e){return ic(e)||sc(e)||function(e){if(e instanceof ca&&la(e)){for(const t of e.getFilters())if(!ic(t)&&!sc(t))return!1;return!0}return!1}(e)}function oc(e,t){var n,r;return zr(e instanceof ua||e instanceof ca),zr(t instanceof ua||t instanceof ca),cc(e instanceof ua?t instanceof ua?(n=e,r=t,ca.create([n,r],"and")):uc(e,t):t instanceof ua?uc(t,e):function(e,t){if(zr(0<e.filters.length&&0<t.filters.length),ha(e)&&ha(t))return ga(e,t.getFilters());const n=la(e)?e:t,r=la(e)?t:e,i=n.filters.map(e=>oc(e,r));return ca.create(i,"or")}(e,t))}function uc(t,e){if(ha(e))return ga(e,t.getFilters());var n=e.filters.map(e=>oc(t,e));return ca.create(n,"or")}function cc(t){if(zr(t instanceof ua||t instanceof ca),t instanceof ua)return t;const e=t.getFilters();if(1===e.length)return cc(e[0]);if(fa(t))return t;const n=e.map(e=>cc(e)),r=[];return n.forEach(e=>{e instanceof ua?r.push(e):e instanceof ca&&(e.op===t.op?r.push(...e.filters):r.push(e))}),1===r.length?r[0]:ca.create(r,t.op)}class hc{constructor(){this.on=new lc}addToCollectionParentIndex(e,t){return this.on.add(t),Ti.resolve()}getCollectionParents(e,t){return Ti.resolve(this.on.getEntries(t))}addFieldIndex(e,t){return Ti.resolve()}deleteFieldIndex(e,t){return Ti.resolve()}deleteAllFieldIndexes(e){return Ti.resolve()}createTargetIndexes(e,t){return Ti.resolve()}getDocumentsMatchingTarget(e,t){return Ti.resolve(null)}getIndexType(e,t){return Ti.resolve(0)}getFieldIndexes(e,t){return Ti.resolve([])}getNextCollectionGroupToUpdate(e){return Ti.resolve(null)}getMinOffset(e,t){return Ti.resolve(wi.min())}getMinOffsetFromCollectionGroup(e,t){return Ti.resolve(wi.min())}updateCollectionGroup(e,t,n){return Ti.resolve()}updateIndexEntries(e,t){return Ti.resolve()}}class lc{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new Is(ui.comparator),i=!r.has(n);return this.index[t]=r.add(n),i}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new Is(ui.comparator)).toArray()}}const dc=new Uint8Array(0);class fc{constructor(e,t){this.databaseId=t,this._n=new lc,this.an=new Qa(e=>xa(e),(e,t)=>Da(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(this._n.has(t))return Ti.resolve();var n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener(()=>{this._n.add(t)});r={collectionId:n,parent:Ui(r)};return gc(e).put(r)}getCollectionParents(e,n){const r=[],t=IDBKeyRange.bound([n,""],[ii(n),""],!1,!0);return gc(e).U(t).next(e=>{for(const t of e){if(t.collectionId!==n)break;r.push(zi(t.parent))}return r})}addFieldIndex(e,t){const n=pc(e),r={indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])};delete r.indexId;const i=n.add(r);if(t.indexState){const n=yc(e);return i.next(e=>{n.put(Uu(e,this.uid,t.indexState.sequenceNumber,t.indexState.offset))})}return i.next()}deleteFieldIndex(e,t){const n=pc(e),r=yc(e),i=mc(e);return n.delete(t.indexId).next(()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){const t=pc(e),n=mc(e),r=yc(e);return t.j().next(()=>n.j()).next(()=>r.j())}createTargetIndexes(n,e){return Ti.forEach(this.un(e),t=>this.getIndexType(n,t).next(e=>{if(0===e||1===e){const e=new nc(t).sn();if(null!=e)return this.addFieldIndex(n,e)}}))}getDocumentsMatchingTarget(e,h){const l=mc(e);let d=!0;const n=new Map;return Ti.forEach(this.un(h),t=>this.cn(e,t).next(e=>{d=d&&!!e,n.set(t,e)})).next(()=>{if(d){let c=to();const d=[];return Ti.forEach(n,(e,t)=>{var n;Vr("IndexedDbIndexManager",`Using index ${n=e,`id=${n.indexId}|cg=${n.collectionGroup}|f=${n.fields.map(e=>`${e.fieldPath}:${e.kind}`).join(",")}`} to execute ${xa(h)}`);var r=function(e,t){var n=fi(t);if(void 0===n)return null;for(const t of Aa(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(t,e),i=function(e,t){const n=new Map;for(const r of gi(t))for(const t of Aa(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(t,e),s=function(e,t){const n=[];let r=!0;for(const i of gi(t)){const t=(0===i.kind?Na:ka)(e,i.fieldPath,e.startAt);n.push(t.value),r=r&&t.inclusive}return new ra(n,r)}(t,e),a=function(e,t){const n=[];let r=!0;for(const i of gi(t)){const t=(0===i.kind?ka:Na)(e,i.fieldPath,e.endAt);n.push(t.value),r=r&&t.inclusive}return new ra(n,r)}(t,e),o=this.ln(e,t,s),u=this.ln(e,t,a),i=this.hn(e,t,i),i=this.Pn(e.indexId,r,o,s.inclusive,u,a.inclusive,i);return Ti.forEach(i,e=>l.G(e,h.limit).next(e=>{e.forEach(e=>{var t=li.fromSegments(e.documentKey);c.has(t)||(c=c.add(t),d.push(t))})}))}).next(()=>d)}return Ti.resolve(null)})}un(t){let e=this.an.get(t);return e||(e=0===t.filters.length?[t]:rc(ca.create(t.filters,"and")).map(e=>Sa(t.path,t.collectionGroup,t.orderBy,e.getFilters(),t.limit,t.startAt,t.endAt)),this.an.set(t,e),e)}Pn(t,e,n,r,i,s,a){const o=(null!=e?e.length:1)*Math.max(n.length,i.length),u=o/(null!=e?e.length:1),c=[];for(let h=0;h<o;++h){const o=e?this.In(e[h/u]):dc,l=this.Tn(t,o,n[h%u],r),d=this.En(t,o,i[h%u],s),f=a.map(e=>this.Tn(t,o,e,!0));c.push(...this.createRange(l,d,f))}return c}Tn(e,t,n,r){const i=new Zu(e,li.empty(),t,n);return r?i:i.Ht()}En(e,t,n,r){const i=new Zu(e,li.empty(),t,n);return r?i.Ht():i}cn(e,t){const r=new nc(t),n=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,n).next(e=>{let t=null;for(const n of e)r.en(n)&&(!t||n.fields.length>t.fields.length)&&(t=n);return t})}getIndexType(e,t){let n=2;const r=this.un(t);return Ti.forEach(r,t=>this.cn(e,t).next(e=>{e?0!==n&&e.fields.length<function(e){let t=new Is(hi.comparator),n=!1;for(const r of e.filters)for(const e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(const n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})).next(()=>function(e){return null!==e.limit}(t)&&1<r.length&&2===n?1:n)}dn(e,t){const n=new Xu;for(const i of gi(e)){const e=t.data.field(i.fieldPath);if(null==e)return null;var r=n.jt(i.kind);Qu.St.ht(e,r)}return n.Ut()}In(e){const t=new Xu;return Qu.St.ht(e,t.jt(0)),t.Ut()}An(e,t){const n=new Xu;return Qu.St.ht(Ks(this.databaseId,t),n.jt(0===(r=gi(e)).length?0:r[r.length-1].kind)),n.Ut();var r}hn(e,t,n){if(null===n)return[];let r=[];r.push(new Xu);let i=0;for(const s of gi(e)){const e=n[i++];for(const n of r)if(this.Rn(t,s.fieldPath)&&Qs(e))r=this.Vn(r,s,e);else{const t=n.jt(s.kind);Qu.St.ht(e,t)}}return this.mn(r)}ln(e,t,n){return this.hn(e,t,n.position)}mn(e){const t=[];for(let n=0;n<e.length;++n)t[n]=e[n].Ut();return t}Vn(e,t,n){const r=[...e],i=[];for(const e of n.arrayValue.values||[])for(const n of r){const r=new Xu;r.seed(n.Ut()),Qu.St.ht(e,r.jt(t.kind)),i.push(r)}return i}Rn(e,t){return!!e.filters.find(e=>e instanceof ua&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){const n=pc(e),r=yc(e);return(t?n.U("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.U()).next(e=>{const s=[];return Ti.forEach(e,i=>r.get([i.indexId,this.uid]).next(e=>{var t,n,r;s.push((t=i,n=(e=e)?new pi(e.sequenceNumber,new wi(Lu(e.readTime),new li(zi(e.documentKey)),e.largestBatchId)):pi.empty(),r=t.fields.map(([e,t])=>new mi(hi.fromServerFormat(e),t)),new di(t.indexId,t.collectionGroup,r,n)))})).next(()=>s)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{var n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!=n?n:ni(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,n,r){const i=pc(e),s=yc(e);return this.fn(e).next(t=>i.U("collectionGroupIndex",IDBKeyRange.bound(n,n)).next(e=>Ti.forEach(e,e=>s.put(Uu(e.indexId,this.uid,t,r)))))}updateIndexEntries(i,e){const n=new Map;return Ti.forEach(e,(t,r)=>{var e=n.get(t.collectionGroup);return(e?Ti.resolve(e):this.getFieldIndexes(i,t.collectionGroup)).next(e=>(n.set(t.collectionGroup,e),Ti.forEach(e,n=>this.gn(i,t,n).next(e=>{var t=this.pn(r,n);return e.isEqual(t)?Ti.resolve():this.yn(i,r,n,e,t)}))))})}wn(e,t,n,r){return mc(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.An(n,t.key),documentKey:t.key.path.toArray()})}Sn(e,t,n,r){return mc(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.An(n,t.key),t.key.path.toArray()])}gn(e,n,r){const t=mc(e);let i=new Is(ec);return t.J({index:"documentKeyIndex",range:IDBKeyRange.only([r.indexId,this.uid,this.An(r,n)])},(e,t)=>{i=i.add(new Zu(r.indexId,n,t.arrayValue,t.directionalValue))}).next(()=>i)}pn(e,t){let n=new Is(ec);var r=this.dn(t,e);if(null==r)return n;const i=fi(t);if(null!=i){var s=e.data.field(i.fieldPath);if(Qs(s))for(const i of s.arrayValue.values||[])n=n.add(new Zu(t.indexId,e.key,this.In(i),r))}else n=n.add(new Zu(t.indexId,e.key,dc,r));return n}yn(t,n,r,e,i){Vr("IndexedDbIndexManager","Updating index entries for document '%s'",n.key);const s=[];return function(e,t,n,r,i){var s=e.getIterator(),a=t.getIterator();let o=Ts(s),u=Ts(a);for(;o||u;){let e=!1,t=!1;if(o&&u){const r=n(o,u);r<0?t=!0:0<r&&(e=!0)}else null!=o?t=!0:e=!0;e?(r(u),u=Ts(a)):t?(i(o),o=Ts(s)):(o=Ts(s),u=Ts(a))}}(e,i,ec,e=>{s.push(this.wn(t,n,r,e))},e=>{s.push(this.Sn(t,n,r,e))}),Ti.waitFor(s)}fn(e){let r=1;return yc(e).J({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,t,n)=>{n.done(),r=t.sequenceNumber+1}).next(()=>r)}createRange(e,t,n){n=n.sort((e,t)=>ec(e,t)).filter((e,t,n)=>!t||0!==ec(e,n[t-1]));const r=[];r.push(e);for(const i of n){const n=ec(i,e),s=ec(i,t);if(0===n)r[0]=e.Ht();else if(0<n&&s<0)r.push(i),r.push(i.Ht());else if(0<s)break}r.push(t);const i=[];for(let a=0;a<r.length;a+=2){if(this.bn(r[a],r[a+1]))return[];const t=[r[a].indexId,this.uid,r[a].arrayValue,r[a].directionalValue,dc,[]],n=[r[a+1].indexId,this.uid,r[a+1].arrayValue,r[a+1].directionalValue,dc,[]];i.push(IDBKeyRange.bound(t,n))}return i}bn(e,t){return 0<ec(e,t)}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(vc)}getMinOffset(t,e){return Ti.mapArray(this.un(e),e=>this.cn(t,e).next(e=>e||jr())).next(vc)}}function gc(e){return ms(e,"collectionParents")}function mc(e){return ms(e,"indexEntries")}function pc(e){return ms(e,"indexConfiguration")}function yc(e){return ms(e,"indexState")}function vc(e){zr(0!==e.length);let t=e[0].indexState.offset,n=t.largestBatchId;for(let i=1;i<e.length;i++){var r=e[i].indexState.offset;_i(r,t)<0&&(t=r),n<r.largestBatchId&&(n=r.largestBatchId)}return new wi(t.readTime,t.documentKey,n)}const wc={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class _c{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new _c(e,_c.DEFAULT_COLLECTION_PERCENTILE,_c.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function bc(e,t,n){const r=e.store("mutations"),i=e.store("documentMutations"),s=[],a=IDBKeyRange.only(n.batchId);let o=0;const u=r.J({range:a},(e,t,n)=>(o++,n.delete()));s.push(u.next(()=>{zr(1===o)}));const c=[];for(const e of n.mutations){const r=$i(t,e.key.path,n.batchId);s.push(i.delete(r)),c.push(e.key)}return Ti.waitFor(s).next(()=>c)}function Ic(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw jr();t=e.noDocument}return JSON.stringify(t).length}_c.DEFAULT_COLLECTION_PERCENTILE=10,_c.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,_c.DEFAULT=new _c(41943040,_c.DEFAULT_COLLECTION_PERCENTILE,_c.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),_c.DISABLED=new _c(-1,0,0);class Ec{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.Dn={}}static ct(e,t,n,r){zr(""!==e.uid);var i=e.isAuthenticated()?e.uid:"";return new Ec(i,t,n,r)}checkEmpty(e){let r=!0;var t=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Sc(e).J({index:"userMutationsIndex",range:t},(e,t,n)=>{r=!1,n.done()}).next(()=>r)}addMutationBatch(h,l,d,f){const g=xc(h),m=Sc(h);return m.add({}).next(e=>{zr("number"==typeof e);const t=new Mo(e,l,d,f),n=(i=this.serializer,s=this.userId,a=t,o=a.baseMutations.map(e=>wu(i.ut,e)),u=a.mutations.map(e=>wu(i.ut,e)),{userId:s,batchId:a.batchId,localWriteTimeMs:a.localWriteTime.toMillis(),baseMutations:o,mutations:u}),r=[];var i,s,a,o,u;let c=new Is((e,t)=>ni(e.canonicalString(),t.canonicalString()));for(const h of f){const l=$i(this.userId,h.key.path,e);c=c.add(h.key.path.popLast()),r.push(m.put(n)),r.push(g.put(l,Qi))}return c.forEach(e=>{r.push(this.indexManager.addToCollectionParentIndex(h,e))}),h.addOnCommittedListener(()=>{this.Dn[e]=t.keys()}),Ti.waitFor(r).next(()=>t)})}lookupMutationBatch(e,t){return Sc(e).get(t).next(e=>e?(zr(e.userId===this.userId),Fu(this.serializer,e)):null)}Cn(e,n){return this.Dn[n]?Ti.resolve(this.Dn[n]):this.lookupMutationBatch(e,n).next(e=>{if(e){var t=e.keys();return this.Dn[n]=t}return null})}getNextMutationBatchAfterBatchId(e,t){const r=t+1,n=IDBKeyRange.lowerBound([this.userId,r]);let i=null;return Sc(e).J({index:"userMutationsIndex",range:n},(e,t,n)=>{t.userId===this.userId&&(zr(t.batchId>=r),i=Fu(this.serializer,t)),n.done()}).next(()=>i)}getHighestUnacknowledgedBatchId(e){var t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let r=-1;return Sc(e).J({index:"userMutationsIndex",range:t,reverse:!0},(e,t,n)=>{r=t.batchId,n.done()}).next(()=>r)}getAllMutationBatches(e){var t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Sc(e).U("userMutationsIndex",t).next(e=>e.map(e=>Fu(this.serializer,e)))}getAllMutationBatchesAffectingDocumentKey(a,o){const e=Ki(this.userId,o.path),t=IDBKeyRange.lowerBound(e),u=[];return xc(a).J({range:t},(e,t,n)=>{var[r,i,s]=e,i=zi(i);if(r===this.userId&&o.path.isEqual(i))return Sc(a).get(s).next(e=>{if(!e)throw jr();zr(e.userId===this.userId),u.push(Fu(this.serializer,e))});n.done()}).next(()=>u)}getAllMutationBatchesAffectingDocumentKeys(t,e){let o=new Is(ni);const n=[];return e.forEach(a=>{var e=Ki(this.userId,a.path),e=IDBKeyRange.lowerBound(e),e=xc(t).J({range:e},(e,t,n)=>{var[r,i,s]=e,i=zi(i);r===this.userId&&a.path.isEqual(i)?o=o.add(s):n.done()});n.push(e)}),Ti.waitFor(n).next(()=>this.vn(t,o))}getAllMutationBatchesAffectingQuery(e,t){const a=t.path,o=a.length+1,n=Ki(this.userId,a),r=IDBKeyRange.lowerBound(n);let u=new Is(ni);return xc(e).J({range:r},(e,t,n)=>{var[r,i,s]=e,i=zi(i);r===this.userId&&a.isPrefixOf(i)?i.length===o&&(u=u.add(s)):n.done()}).next(()=>this.vn(e,u))}vn(t,e){const n=[],r=[];return e.forEach(e=>{r.push(Sc(t).get(e).next(e=>{if(null===e)throw jr();zr(e.userId===this.userId),n.push(Fu(this.serializer,e))}))}),Ti.waitFor(r).next(()=>n)}removeMutationBatch(t,n){return bc(t._e,this.userId,n).next(e=>(t.addOnCommittedListener(()=>{this.Fn(n.batchId)}),Ti.forEach(e,e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))}Fn(e){delete this.Dn[e]}performConsistencyCheck(n){return this.checkEmpty(n).next(e=>{if(!e)return Ti.resolve();const t=IDBKeyRange.lowerBound([this.userId]),r=[];return xc(n).J({range:t},(e,t,n)=>{if(e[0]===this.userId){const t=zi(e[1]);r.push(t)}else n.done()}).next(()=>{zr(0===r.length)})})}containsKey(e,t){return Tc(e,this.userId,t)}Mn(e){return Dc(e).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function Tc(e,s,t){const n=Ki(s,t.path),a=n[1],r=IDBKeyRange.lowerBound(n);let o=!1;return xc(e).J({range:r,H:!0},(e,t,n)=>{var[r,i]=e;r===s&&i===a&&(o=!0),n.done()}).next(()=>o)}function Sc(e){return ms(e,"mutations")}function xc(e){return ms(e,"documentMutations")}function Dc(e){return ms(e,"mutationQueues")}class Cc{constructor(e){this.xn=e}next(){return this.xn+=2,this.xn}static On(){return new Cc(0)}static Nn(){return new Cc(-1)}}class Ac{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(n){return this.Ln(n).next(e=>{const t=new Cc(e.highestTargetId);return e.highestTargetId=t.next(),this.Bn(n,e).next(()=>e.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.Ln(e).next(e=>ai.fromTimestamp(new si(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.Ln(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(t,n,r){return this.Ln(t).next(e=>(e.highestListenSequenceNumber=n,r&&(e.lastRemoteSnapshotVersion=r.toTimestamp()),n>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=n),this.Bn(t,e)))}addTargetData(t,n){return this.kn(t,n).next(()=>this.Ln(t).next(e=>(e.targetCount+=1,this.qn(n,e),this.Bn(t,e))))}updateTargetData(e,t){return this.kn(e,t)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next(()=>Nc(t).delete(e.targetId)).next(()=>this.Ln(t)).next(e=>(zr(0<e.targetCount),--e.targetCount,this.Bn(t,e)))}removeTargets(r,i,s){let a=0;const o=[];return Nc(r).J((e,t)=>{var n=Ou(t);n.sequenceNumber<=i&&null===s.get(n.targetId)&&(a++,o.push(this.removeTargetData(r,n)))}).next(()=>Ti.waitFor(o)).next(()=>a)}forEachTarget(e,r){return Nc(e).J((e,t)=>{var n=Ou(t);r(n)})}Ln(e){return kc(e).get("targetGlobalKey").next(e=>(zr(null!==e),e))}Bn(e,t){return kc(e).put("targetGlobalKey",t)}kn(e,t){return Nc(e).put(Pu(this.serializer,t))}qn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.Ln(e).next(e=>e.targetCount)}getTargetData(e,i){var t=xa(i),t=IDBKeyRange.bound([t,Number.NEGATIVE_INFINITY],[t,Number.POSITIVE_INFINITY]);let s=null;return Nc(e).J({range:t,index:"queryTargetsIndex"},(e,t,n)=>{var r=Ou(t);Da(i,r.target)&&(s=r,n.done())}).next(()=>s)}addMatchingKeys(n,e,r){const i=[],s=Rc(n);return e.forEach(e=>{var t=Ui(e.path);i.push(s.put({targetId:r,path:t})),i.push(this.referenceDelegate.addReference(n,r,e))}),Ti.waitFor(i)}removeMatchingKeys(n,e,r){const i=Rc(n);return Ti.forEach(e,e=>{var t=Ui(e.path);return Ti.waitFor([i.delete([r,t]),this.referenceDelegate.removeReference(n,r,e)])})}removeMatchingKeysForTargetId(e,t){const n=Rc(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=Rc(e);let i=to();return r.J({range:n,H:!0},(e,t,n)=>{var r=zi(e[1]),r=new li(r);i=i.add(r)}).next(()=>i)}containsKey(e,t){var n=Ui(t.path),n=IDBKeyRange.bound([n],[ii(n)],!1,!0);let r=0;return Rc(e).J({index:"documentTargetsIndex",H:!0,range:n},([e],t,n)=>{0!==e&&(r++,n.done())}).next(()=>0<r)}ot(e,t){return Nc(e).get(t).next(e=>e?Ou(e):null)}}function Nc(e){return ms(e,"targets")}function kc(e){return ms(e,"targetGlobal")}function Rc(e){return ms(e,"targetDocuments")}function Mc([e,t],[n,r]){var i=ni(e,n);return 0===i?ni(t,r):i}class Lc{constructor(e){this.Qn=e,this.buffer=new Is(Mc),this.Kn=0}$n(){return++this.Kn}Un(e){var t=[e,this.$n()];if(this.buffer.size<this.Qn)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();Mc(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class Fc{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Wn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Gn(6e4)}stop(){this.Wn&&(this.Wn.cancel(),this.Wn=null)}get started(){return null!==this.Wn}Gn(e){Vr("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.Wn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.Wn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){Ni(e)?Vr("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await Ei(e)}await this.Gn(3e5)})}}class Oc{constructor(e,t){this.zn=e,this.params=t}calculateTargetCount(e,t){return this.zn.jn(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return Ti.resolve(Pi.oe);const n=new Lc(t);return this.zn.forEachTarget(e,e=>n.Un(e.sequenceNumber)).next(()=>this.zn.Hn(e,e=>n.Un(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.zn.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.zn.removeOrphanedDocuments(e,t)}collect(t,n){return-1===this.params.cacheSizeCollectionThreshold?(Vr("LruGarbageCollector","Garbage collection skipped; disabled"),Ti.resolve(wc)):this.getCacheSize(t).next(e=>e<this.params.cacheSizeCollectionThreshold?(Vr("LruGarbageCollector",`Garbage collection skipped; Cache size ${e} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),wc):this.Jn(t,n))}getCacheSize(e){return this.zn.getCacheSize(e)}Jn(t,n){let r,i,s,a,o,u,c;const h=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(e=>(i=e>this.params.maximumSequenceNumbersToCollect?(Vr("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${e}`),this.params.maximumSequenceNumbersToCollect):e,a=Date.now(),this.nthSequenceNumber(t,i))).next(e=>(r=e,o=Date.now(),this.removeTargets(t,r,n))).next(e=>(s=e,u=Date.now(),this.removeOrphanedDocuments(t,r))).next(e=>(c=Date.now(),Pr()<=l.DEBUG&&Vr("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${a-h}ms\n\tDetermined least recently used ${i} in `+(o-a)+"ms\n"+`\tRemoved ${s} targets in `+(u-o)+"ms\n"+`\tRemoved ${e} documents in `+(c-u)+"ms\n"+`Total Duration: ${c-h}ms`),Ti.resolve({didRun:!0,sequenceNumbersCollected:i,targetsRemoved:s,documentsRemoved:e})))}}class Pc{constructor(e,t){this.db=e,this.garbageCollector=(e=this,t=t,new Oc(e,t))}jn(e){const n=this.Yn(e);return this.db.getTargetCache().getTargetCount(e).next(t=>n.next(e=>t+e))}Yn(e){let t=0;return this.Hn(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Hn(e,n){return this.Zn(e,(e,t)=>n(t))}addReference(e,t,n){return Vc(e,n)}removeReference(e,t,n){return Vc(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return Vc(e,t)}Xn(t,n){let r=!1;return Dc(t).Y(e=>Tc(t,e,n).next(e=>(e&&(r=!0),Ti.resolve(!e)))).next(()=>r)}removeOrphanedDocuments(n,r){const i=this.db.getRemoteDocumentCache().newChangeBuffer(),s=[];let a=0;return this.Zn(n,(t,e)=>{if(e<=r){const r=this.Xn(n,t).next(e=>{if(!e)return a++,i.getEntry(n,t).next(()=>(i.removeEntry(t,ai.min()),Rc(n).delete(function(e){return[0,Ui(e.path)]}(t))))});s.push(r)}}).next(()=>Ti.waitFor(s)).next(()=>i.apply(n)).next(()=>a)}removeTarget(e,t){var n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return Vc(e,t)}Zn(e,r){const t=Rc(e);let i,s=Pi.oe;return t.J({index:"documentTargetsIndex"},([e],{path:t,sequenceNumber:n})=>{0===e?(s!==Pi.oe&&r(new li(zi(i)),s),s=n,i=t):s=Pi.oe}).next(()=>{s!==Pi.oe&&r(new li(zi(i)),s)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function Vc(e,t){return Rc(e).put((e=e.currentSequenceNumber,{targetId:0,path:Ui(t.path),sequenceNumber:e}))}class Bc{constructor(){this.changes=new Qa(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,na.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();var n=this.changes.get(t);return void 0!==n?Ti.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class qc{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return Gc(e).put(n)}removeEntry(e,t,n){return Gc(e).delete(function(e,t){const n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],Ru(t),n[n.length-1]]}(t,n))}updateMetadata(t,n){return this.getMetadata(t).next(e=>(e.byteSize+=n,this.er(t,e)))}getEntry(e,n){let r=na.newInvalidDocument(n);return Gc(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(Kc(n))},(e,t)=>{r=this.tr(n,t)}).next(()=>r)}nr(e,n){let r={size:0,document:na.newInvalidDocument(n)};return Gc(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(Kc(n))},(e,t)=>{r={document:this.tr(n,t),size:Ic(t)}}).next(()=>r)}getEntries(e,t){let r=Ha;return this.rr(e,t,(e,t)=>{var n=this.tr(e,t);r=r.insert(e,n)}).next(()=>r)}ir(e,t){let r=Ha,i=new ws(li.comparator);return this.rr(e,t,(e,t)=>{var n=this.tr(e,t);r=r.insert(e,n),i=i.insert(e,Ic(t))}).next(()=>({documents:r,sr:i}))}rr(e,t,i){if(t.isEmpty())return Ti.resolve();let n=new Is(Qc);t.forEach(e=>n=n.add(e));const r=IDBKeyRange.bound(Kc(n.first()),Kc(n.last())),s=n.getIterator();let a=s.getNext();return Gc(e).J({index:"documentKeyIndex",range:r},(e,t,n)=>{for(var r=li.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);a&&Qc(a,r)<0;)i(a,null),a=s.getNext();a&&a.isEqual(r)&&(i(a,t),a=s.hasNext()?s.getNext():null),a?n.$(Kc(a)):n.done()}).next(()=>{for(;a;)i(a,null),a=s.hasNext()?s.getNext():null})}getDocumentsMatchingQuery(e,n,t,r,i){const s=n.path,a=[s.popLast().toArray(),s.lastSegment(),Ru(t.readTime),t.documentKey.path.isEmpty()?"":t.documentKey.path.lastSegment()],o=[s.popLast().toArray(),s.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Gc(e).U(IDBKeyRange.bound(a,o,!0)).next(e=>{null==i||i.incrementDocumentReadCount(e.length);let t=Ha;for(const i of e){const e=this.tr(li.fromSegments(i.prefixPath.concat(i.collectionGroup,i.documentId)),i);e.isFoundDocument()&&(Ga(n,e)||r.has(e.key))&&(t=t.insert(e.key,e))}return t})}getAllFromCollectionGroup(e,t,n,i){let s=Ha;var r=$c(t,n),a=$c(t,wi.max());return Gc(e).J({index:"collectionGroupIndex",range:IDBKeyRange.bound(r,a,!0)},(e,t,n)=>{var r=this.tr(li.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);s=s.insert(r.key,r),s.size===i&&n.done()}).next(()=>s)}newChangeBuffer(e){return new jc(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return zc(e).get("remoteDocumentGlobalKey").next(e=>(zr(!!e),e))}er(e,t){return zc(e).put("remoteDocumentGlobalKey",t)}tr(e,t){if(t){const e=function(e,t){let n;if(t.document)n=vu(e.ut,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=li.fromSegments(t.noDocument.path),i=Lu(t.noDocument.readTime);n=na.newNoDocument(e,i),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return jr();{const e=li.fromSegments(t.unknownDocument.path),s=Lu(t.unknownDocument.version);n=na.newUnknownDocument(e,s)}}return t.readTime&&n.setReadTime((t=t.readTime,r=new si(t[0],t[1]),ai.fromTimestamp(r))),n;var r}(this.serializer,t);if(!e.isNoDocument()||!e.version.isEqual(ai.min()))return e}return na.newInvalidDocument(e)}}function Uc(e){return new qc(e)}class jc extends Bc{constructor(e,t){super(),this._r=e,this.trackRemovals=t,this.ar=new Qa(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(s){const a=[];let o=0,u=new Is((e,t)=>ni(e.canonicalString(),t.canonicalString()));return this.changes.forEach((e,t)=>{var n=this.ar.get(e);if(a.push(this._r.removeEntry(s,e,n.readTime)),t.isValidDocument()){var r=ku(this._r.serializer,t);u=u.add(e.path.popLast());var i=Ic(r);o+=i-n.size,a.push(this._r.addEntry(s,e,r))}else if(o-=n.size,this.trackRemovals){const o=ku(this._r.serializer,t.convertToNoDocument(ai.min()));a.push(this._r.addEntry(s,e,o))}}),u.forEach(e=>{a.push(this._r.indexManager.addToCollectionParentIndex(s,e))}),a.push(this._r.updateMetadata(s,o)),Ti.waitFor(a)}getFromCache(e,t){return this._r.nr(e,t).next(e=>(this.ar.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this._r.ir(e,t).next(({documents:n,sr:e})=>(e.forEach((e,t)=>{this.ar.set(e,{size:t,readTime:n.get(e).readTime})}),n))}}function zc(e){return ms(e,"remoteDocumentGlobal")}function Gc(e){return ms(e,"remoteDocumentsV14")}function Kc(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function $c(e,t){const n=t.documentKey.path.toArray();return[e,Ru(t.readTime),n.slice(0,n.length-2),0<n.length?n[n.length-1]:""]}function Qc(e,t){var n=e.path.toArray(),r=t.path.toArray();let i=0;for(let s=0;s<n.length-2&&s<r.length-2;++s)if(i=ni(n[s],r[s]),i)return i;return i=ni(n.length,r.length),i||(i=ni(n[n.length-2],r[r.length-2]),i||ni(n[n.length-1],r[r.length-1]))}class Hc{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class Wc{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(t,n){let r=null;return this.documentOverlayCache.getOverlay(t,n).next(e=>(r=e,this.remoteDocumentCache.getEntry(t,n))).next(e=>(null!==r&&To(r.mutation,e,Ss.empty(),si.now()),e))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next(e=>this.getLocalViewOfDocuments(t,e,to()).next(()=>e))}getLocalViewOfDocuments(e,t,n=to()){const r=Xa();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,n).next(e=>{let n=Ja();return e.forEach((e,t)=>{n=n.insert(e,t.overlayedDocument)}),n}))}getOverlayedDocuments(e,t){const n=Xa();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,to()))}populateOverlays(e,n,t){const r=[];return t.forEach(e=>{n.has(e)||r.push(e)}),this.documentOverlayCache.getOverlays(e,r).next(e=>{e.forEach((e,t)=>{n.set(e,t)})})}computeViews(e,t,r,i){let s=Ha;const a=Xa(),o=Xa();return t.forEach((e,t)=>{const n=r.get(t.key);i.has(t.key)&&(void 0===n||n.mutation instanceof Do)?s=s.insert(t.key,t):void 0!==n?(a.set(t.key,n.mutation.getFieldMask()),To(n.mutation,t,n.mutation.getFieldMask(),si.now())):a.set(t.key,Ss.empty())}),this.recalculateAndSaveOverlays(e,s).next(e=>(e.forEach((e,t)=>a.set(e,t)),t.forEach((e,t)=>{var n;return o.set(e,new Hc(t,null!==(n=a.get(e))&&void 0!==n?n:null))}),o))}recalculateAndSaveOverlays(s,a){const o=Xa();let u=new ws((e,t)=>e-t),c=to();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(s,a).next(e=>{for(const r of e)r.keys().forEach(e=>{var t,n=a.get(e);null!==n&&(t=o.get(e)||Ss.empty(),t=r.applyToLocalView(n,t),o.set(e,t),t=(u.get(r.batchId)||to()).add(e),u=u.insert(r.batchId,t))})}).next(()=>{const e=[],t=u.getReverseIterator();for(;t.hasNext();){const u=t.getNext(),n=u.key,r=u.value,i=Xa();r.forEach(e=>{var t;c.has(e)||(null!==(t=Io(a.get(e),o.get(e)))&&i.set(e,t),c=c.add(e))}),e.push(this.documentOverlayCache.saveOverlays(s,n,i))}return Ti.waitFor(e)}).next(()=>o)}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next(e=>this.recalculateAndSaveOverlays(t,e))}getDocumentsMatchingQuery(e,t,n,r){return i=t,li.isDocumentKey(i.path)&&null===i.collectionGroup&&0===i.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):Oa(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n,r):this.getDocumentsMatchingCollectionQuery(e,t,n,r);var i}getNextDocuments(s,t,a,o){return this.remoteDocumentCache.getAllFromCollectionGroup(s,t,a,o).next(n=>{const e=0<o-n.size?this.documentOverlayCache.getOverlaysForCollectionGroup(s,t,a.largestBatchId,o-n.size):Ti.resolve(Xa());let r=-1,i=n;return e.next(e=>Ti.forEach(e,(t,e)=>(r<e.largestBatchId&&(r=e.largestBatchId),n.get(t)?Ti.resolve():this.remoteDocumentCache.getEntry(s,t).next(e=>{i=i.insert(t,e)}))).next(()=>this.populateOverlays(s,e,n)).next(()=>this.computeViews(s,i,e,to())).next(e=>({batchId:r,changes:Ya(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new li(t)).next(e=>{let t=Ja();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t})}getDocumentsMatchingCollectionGroupQuery(r,i,s,a){const o=i.collectionGroup;let u=Ja();return this.indexManager.getCollectionParents(r,o).next(e=>Ti.forEach(e,e=>{var t,n=(t=i,e=e.child(o),new Ra(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt));return this.getDocumentsMatchingCollectionQuery(r,n,s,a).next(e=>{e.forEach((e,t)=>{u=u.insert(e,t)})})}).next(()=>u))}getDocumentsMatchingCollectionQuery(t,s,n,r){let a;return this.documentOverlayCache.getOverlaysForCollection(t,s.path,n.largestBatchId).next(e=>(a=e,this.remoteDocumentCache.getDocumentsMatchingQuery(t,s,n,a,r))).next(r=>{a.forEach((e,t)=>{var n=t.getKey();null===r.get(n)&&(r=r.insert(n,na.newInvalidDocument(n)))});let i=Ja();return r.forEach((e,t)=>{var n=a.get(e);void 0!==n&&To(n.mutation,t,Ss.empty(),si.now()),Ga(s,t)&&(i=i.insert(e,t))}),i})}}class Jc{constructor(e){this.serializer=e,this.ur=new Map,this.cr=new Map}getBundleMetadata(e,t){return Ti.resolve(this.ur.get(t))}saveBundleMetadata(e,t){return this.ur.set(t.id,{id:t.id,version:t.version,createTime:ou(t.createTime)}),Ti.resolve()}getNamedQuery(e,t){return Ti.resolve(this.cr.get(t))}saveNamedQuery(e,t){return this.cr.set(t.name,{name:(t=t).name,query:Vu(t.bundledQuery),readTime:ou(t.readTime)}),Ti.resolve()}}class Yc{constructor(){this.overlays=new ws(li.comparator),this.lr=new Map}getOverlay(e,t){return Ti.resolve(this.overlays.get(t))}getOverlays(e,t){const n=Xa();return Ti.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(n,r,e){return e.forEach((e,t)=>{this.lt(n,r,t)}),Ti.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.lr.get(n);return void 0!==r&&(r.forEach(e=>this.overlays=this.overlays.remove(e)),this.lr.delete(n)),Ti.resolve()}getOverlaysForCollection(e,t,n){const r=Xa(),i=t.length+1,s=new li(t.child("")),a=this.overlays.getIteratorFrom(s);for(;a.hasNext();){const e=a.getNext().value,s=e.getKey();if(!t.isPrefixOf(s.path))break;s.path.length===i&&e.largestBatchId>n&&r.set(e.getKey(),e)}return Ti.resolve(r)}getOverlaysForCollectionGroup(t,e,n,r){let i=new ws((e,t)=>e-t);const s=this.overlays.getIterator();for(;s.hasNext();){const t=s.getNext().value;if(t.getKey().getCollectionGroup()===e&&t.largestBatchId>n){let e=i.get(t.largestBatchId);null===e&&(e=Xa(),i=i.insert(t.largestBatchId,e)),e.set(t.getKey(),t)}}const a=Xa(),o=i.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach((e,t)=>a.set(e,t)),!(a.size()>=r)););return Ti.resolve(a)}lt(e,t,n){var r=this.overlays.get(n.key);if(null!==r){const e=this.lr.get(r.largestBatchId).delete(n.key);this.lr.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new Fo(t,n));let i=this.lr.get(t);void 0===i&&(i=to(),this.lr.set(t,i)),this.lr.set(t,i.add(n.key))}}class Xc{constructor(){this.hr=new Is(Zc.Pr),this.Ir=new Is(Zc.Tr)}isEmpty(){return this.hr.isEmpty()}addReference(e,t){var n=new Zc(e,t);this.hr=this.hr.add(n),this.Ir=this.Ir.add(n)}Er(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.dr(new Zc(e,t))}Ar(e,t){e.forEach(e=>this.removeReference(e,t))}Rr(e){const t=new li(new ui([])),n=new Zc(t,e),r=new Zc(t,e+1),i=[];return this.Ir.forEachInRange([n,r],e=>{this.dr(e),i.push(e.key)}),i}Vr(){this.hr.forEach(e=>this.dr(e))}dr(e){this.hr=this.hr.delete(e),this.Ir=this.Ir.delete(e)}mr(e){var t=new li(new ui([])),n=new Zc(t,e),t=new Zc(t,e+1);let r=to();return this.Ir.forEachInRange([n,t],e=>{r=r.add(e.key)}),r}containsKey(e){var t=new Zc(e,0),t=this.hr.firstAfterOrEqual(t);return null!==t&&e.isEqual(t.key)}}class Zc{constructor(e,t){this.key=e,this.gr=t}static Pr(e,t){return li.comparator(e.key,t.key)||ni(e.gr,t.gr)}static Tr(e,t){return ni(e.gr,t.gr)||li.comparator(e.key,t.key)}}class eh{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.pr=1,this.yr=new Is(Zc.Pr)}checkEmpty(e){return Ti.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){var i=this.pr;this.pr++,0<this.mutationQueue.length&&this.mutationQueue[this.mutationQueue.length-1];var s=new Mo(i,t,n,r);this.mutationQueue.push(s);for(const t of r)this.yr=this.yr.add(new Zc(t.key,i)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return Ti.resolve(s)}lookupMutationBatch(e,t){return Ti.resolve(this.wr(t))}getNextMutationBatchAfterBatchId(e,t){var n=this.Sr(t+1),n=n<0?0:n;return Ti.resolve(this.mutationQueue.length>n?this.mutationQueue[n]:null)}getHighestUnacknowledgedBatchId(){return Ti.resolve(0===this.mutationQueue.length?-1:this.pr-1)}getAllMutationBatches(e){return Ti.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new Zc(t,0),r=new Zc(t,Number.POSITIVE_INFINITY),i=[];return this.yr.forEachInRange([n,r],e=>{var t=this.wr(e.gr);i.push(t)}),Ti.resolve(i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let r=new Is(ni);return t.forEach(e=>{var t=new Zc(e,0),n=new Zc(e,Number.POSITIVE_INFINITY);this.yr.forEachInRange([t,n],e=>{r=r.add(e.gr)})}),Ti.resolve(this.br(r))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let i=n;li.isDocumentKey(i)||(i=i.child(""));var s=new Zc(new li(i),0);let a=new Is(ni);return this.yr.forEachWhile(e=>{var t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(a=a.add(e.gr)),!0)},s),Ti.resolve(this.br(a))}br(e){const n=[];return e.forEach(e=>{var t=this.wr(e);null!==t&&n.push(t)}),n}removeMutationBatch(n,r){zr(0===this.Dr(r.batchId,"removed")),this.mutationQueue.shift();let i=this.yr;return Ti.forEach(r.mutations,e=>{var t=new Zc(e.key,r.batchId);return i=i.delete(t),this.referenceDelegate.markPotentiallyOrphaned(n,e.key)}).next(()=>{this.yr=i})}Fn(e){}containsKey(e,t){var n=new Zc(t,0),n=this.yr.firstAfterOrEqual(n);return Ti.resolve(t.isEqual(n&&n.key))}performConsistencyCheck(e){return this.mutationQueue.length,Ti.resolve()}Dr(e,t){return this.Sr(e)}Sr(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}wr(e){var t=this.Sr(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class th{constructor(e){this.Cr=e,this.docs=new ws(li.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),i=r?r.size:0,s=this.Cr(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:s}),this.size+=s-i,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){var t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return Ti.resolve(n?n.document.mutableCopy():na.newInvalidDocument(t))}getEntries(e,t){let n=Ha;return t.forEach(e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():na.newInvalidDocument(e))}),Ti.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let i=Ha;const s=t.path,a=new li(s.child("")),o=this.docs.getIteratorFrom(a);for(;o.hasNext();){const{key:e,value:{document:a}}=o.getNext();if(!s.isPrefixOf(e.path))break;e.path.length>s.length+1||_i(vi(a),n)<=0||(r.has(a.key)||Ga(t,a))&&(i=i.insert(a.key,a.mutableCopy()))}return Ti.resolve(i)}getAllFromCollectionGroup(e,t,n,r){jr()}vr(e,t){return Ti.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new nh(this)}getSize(e){return Ti.resolve(this.size)}}class nh extends Bc{constructor(e){super(),this._r=e}applyChanges(n){const r=[];return this.changes.forEach((e,t)=>{t.isValidDocument()?r.push(this._r.addEntry(n,t)):this._r.removeEntry(e)}),Ti.waitFor(r)}getFromCache(e,t){return this._r.getEntry(e,t)}getAllFromCache(e,t){return this._r.getEntries(e,t)}}class rh{constructor(e){this.persistence=e,this.Fr=new Qa(e=>xa(e),Da),this.lastRemoteSnapshotVersion=ai.min(),this.highestTargetId=0,this.Mr=0,this.Or=new Xc,this.targetCount=0,this.Nr=Cc.On()}forEachTarget(e,n){return this.Fr.forEach((e,t)=>n(t)),Ti.resolve()}getLastRemoteSnapshotVersion(e){return Ti.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return Ti.resolve(this.Mr)}allocateTargetId(e){return this.highestTargetId=this.Nr.next(),Ti.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.Mr&&(this.Mr=t),Ti.resolve()}kn(e){this.Fr.set(e.target,e);var t=e.targetId;t>this.highestTargetId&&(this.Nr=new Cc(t),this.highestTargetId=t),e.sequenceNumber>this.Mr&&(this.Mr=e.sequenceNumber)}addTargetData(e,t){return this.kn(t),this.targetCount+=1,Ti.resolve()}updateTargetData(e,t){return this.kn(t),Ti.resolve()}removeTargetData(e,t){return this.Fr.delete(t.target),this.Or.Rr(t.targetId),--this.targetCount,Ti.resolve()}removeTargets(n,r,i){let s=0;const a=[];return this.Fr.forEach((e,t)=>{t.sequenceNumber<=r&&null===i.get(t.targetId)&&(this.Fr.delete(e),a.push(this.removeMatchingKeysForTargetId(n,t.targetId)),s++)}),Ti.waitFor(a).next(()=>s)}getTargetCount(e){return Ti.resolve(this.targetCount)}getTargetData(e,t){var n=this.Fr.get(t)||null;return Ti.resolve(n)}addMatchingKeys(e,t,n){return this.Or.Er(t,n),Ti.resolve()}removeMatchingKeys(t,e,n){this.Or.Ar(e,n);const r=this.persistence.referenceDelegate,i=[];return r&&e.forEach(e=>{i.push(r.markPotentiallyOrphaned(t,e))}),Ti.waitFor(i)}removeMatchingKeysForTargetId(e,t){return this.Or.Rr(t),Ti.resolve()}getMatchingKeysForTargetId(e,t){var n=this.Or.mr(t);return Ti.resolve(n)}containsKey(e,t){return Ti.resolve(this.Or.containsKey(t))}}class ih{constructor(e,t){this.Lr={},this.overlays={},this.Br=new Pi(0),this.kr=!1,this.kr=!0,this.referenceDelegate=e(this),this.qr=new rh(this),this.indexManager=new hc,this.remoteDocumentCache=(e=e=>this.referenceDelegate.Qr(e),new th(e)),this.serializer=new Nu(t),this.Kr=new Jc(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.kr=!1,Promise.resolve()}get started(){return this.kr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new Yc,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.Lr[e.toKey()];return n||(n=new eh(t,this.referenceDelegate),this.Lr[e.toKey()]=n),n}getTargetCache(){return this.qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Kr}runTransaction(e,t,n){Vr("MemoryPersistence","Starting transaction:",e);const r=new sh(this.Br.next());return this.referenceDelegate.$r(),n(r).next(e=>this.referenceDelegate.Ur(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}Wr(t,n){return Ti.or(Object.values(this.Lr).map(e=>()=>e.containsKey(t,n)))}}class sh extends Ii{constructor(e){super(),this.currentSequenceNumber=e}}class ah{constructor(e){this.persistence=e,this.Gr=new Xc,this.zr=null}static jr(e){return new ah(e)}get Hr(){if(this.zr)return this.zr;throw jr()}addReference(e,t,n){return this.Gr.addReference(n,t),this.Hr.delete(n.toString()),Ti.resolve()}removeReference(e,t,n){return this.Gr.removeReference(n,t),this.Hr.add(n.toString()),Ti.resolve()}markPotentiallyOrphaned(e,t){return this.Hr.add(t.toString()),Ti.resolve()}removeTarget(e,t){this.Gr.Rr(t.targetId).forEach(e=>this.Hr.add(e.toString()));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.Hr.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}$r(){this.zr=new Set}Ur(n){const r=this.persistence.getRemoteDocumentCache().newChangeBuffer();return Ti.forEach(this.Hr,e=>{const t=li.fromPath(e);return this.Jr(n,t).next(e=>{e||r.removeEntry(t,ai.min())})}).next(()=>(this.zr=null,r.apply(n)))}updateLimboDocument(e,t){return this.Jr(e,t).next(e=>{e?this.Hr.delete(t.toString()):this.Hr.add(t.toString())})}Qr(e){return 0}Jr(e,t){return Ti.or([()=>Ti.resolve(this.Gr.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Wr(e,t)])}}class oh{constructor(e){this.serializer=e}O(t,e,n,r){const i=new Si("createOrUpgrade",e);var s;n<1&&1<=r&&(t.createObjectStore("owner"),(s=t).createObjectStore("mutationQueues",{keyPath:"userId"}),s.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Gi,{unique:!0}),s.createObjectStore("documentMutations"),uh(t),t.createObjectStore("remoteDocuments"));let a=Ti.resolve();return n<3&&3<=r&&(0!==n&&((s=t).deleteObjectStore("targetDocuments"),s.deleteObjectStore("targets"),s.deleteObjectStore("targetGlobal"),uh(t)),a=a.next(()=>function(e){const t=e.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:ai.min().toTimestamp(),targetCount:0};return t.put("targetGlobalKey",n)}(i))),n<4&&4<=r&&(0!==n&&(a=a.next(()=>function(r,i){return i.store("mutations").U().next(e=>{r.deleteObjectStore("mutations"),r.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Gi,{unique:!0});const t=i.store("mutations"),n=e.map(e=>t.put(e));return Ti.waitFor(n)})}(t,i))),a=a.next(()=>{t.createObjectStore("clientMetadata",{keyPath:"clientId"})})),n<5&&5<=r&&(a=a.next(()=>this.Zr(i))),n<6&&6<=r&&(a=a.next(()=>(function(e){e.createObjectStore("remoteDocumentGlobal")}(t),this.Xr(i)))),n<7&&7<=r&&(a=a.next(()=>this.ei(i))),n<8&&8<=r&&(a=a.next(()=>this.ti(t,i))),n<9&&9<=r&&(a=a.next(()=>{var e;(e=t).objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")})),n<10&&10<=r&&(a=a.next(()=>this.ni(i))),n<11&&11<=r&&(a=a.next(()=>{t.createObjectStore("bundles",{keyPath:"bundleId"}),t.createObjectStore("namedQueries",{keyPath:"name"})})),n<12&&12<=r&&(a=a.next(()=>{!function(e){const t=e.createObjectStore("documentOverlays",{keyPath:ss});t.createIndex("collectionPathOverlayIndex",as,{unique:!1}),t.createIndex("collectionGroupOverlayIndex",os,{unique:!1})}(t)})),n<13&&13<=r&&(a=a.next(()=>function(e){const t=e.createObjectStore("remoteDocumentsV14",{keyPath:Hi});t.createIndex("documentKeyIndex",Wi),t.createIndex("collectionGroupIndex",Ji)}(t)).next(()=>this.ri(t,i)).next(()=>t.deleteObjectStore("remoteDocuments"))),n<14&&14<=r&&(a=a.next(()=>this.ii(t,i))),n<15&&15<=r&&(a=a.next(()=>function(e){e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:ts}).createIndex("sequenceNumberIndex",ns,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:rs}).createIndex("documentKeyIndex",is,{unique:!1})}(t))),n<16&&16<=r&&(a=a.next(()=>{e.objectStore("indexState").clear()}).next(()=>{e.objectStore("indexEntries").clear()})),a}Xr(t){let n=0;return t.store("remoteDocuments").J((e,t)=>{n+=Ic(t)}).next(()=>{var e={byteSize:n};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",e)})}Zr(r){const e=r.store("mutationQueues"),t=r.store("mutations");return e.U().next(e=>Ti.forEach(e,n=>{var e=IDBKeyRange.bound([n.userId,-1],[n.userId,n.lastAcknowledgedBatchId]);return t.U("userMutationsIndex",e).next(e=>Ti.forEach(e,e=>{zr(e.userId===n.userId);var t=Fu(this.serializer,e);return bc(r,n.userId,t).next(()=>{})}))}))}ei(e){const a=e.store("targetDocuments"),t=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next(i=>{const s=[];return t.J((e,t)=>{const n=new ui(e),r=[0,Ui(n)];s.push(a.get(r).next(e=>e?Ti.resolve():(e=>a.put({targetId:0,path:Ui(e),sequenceNumber:i.highestListenSequenceNumber}))(n)))}).next(()=>Ti.waitFor(s))})}ti(e,t){e.createObjectStore("collectionParents",{keyPath:es});const n=t.store("collectionParents"),r=new lc,i=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:Ui(r)})}};return t.store("remoteDocuments").J({H:!0},(e,t)=>{const n=new ui(e);return i(n.popLast())}).next(()=>t.store("documentMutations").J({H:!0},([,e],t)=>{const n=zi(e);return i(n.popLast())}))}ni(e){const r=e.store("targets");return r.J((e,t)=>{var n=Ou(t),n=Pu(this.serializer,n);return r.put(n)})}ri(e,a){const t=a.store("remoteDocuments"),o=[];return t.J((e,t)=>{const n=a.store("remoteDocumentsV14"),r=((s=t).document?new li(ui.fromString(s.document.name).popFirst(5)):s.noDocument?li.fromSegments(s.noDocument.path):s.unknownDocument?li.fromSegments(s.unknownDocument.path):jr()).path.toArray(),i={prefixPath:r.slice(0,r.length-2),collectionGroup:r[r.length-2],documentId:r[r.length-1],readTime:t.readTime||[0,0],unknownDocument:t.unknownDocument,noDocument:t.noDocument,document:t.document,hasCommittedMutations:!!t.hasCommittedMutations};var s;o.push(n.put(i))}).next(()=>Ti.waitFor(o))}ii(e,s){const t=s.store("mutations"),a=Uc(this.serializer),o=new ih(ah.jr,this.serializer.ut);return t.U().next(e=>{const r=new Map;return e.forEach(e=>{var t;let n=null!==(t=r.get(e.userId))&&void 0!==t?t:to();Fu(this.serializer,e).keys().forEach(e=>n=n.add(e)),r.set(e.userId,n)}),Ti.forEach(r,(e,t)=>{var n=new Lr(t),r=Ku.ct(this.serializer,n),i=o.getIndexManager(n),n=Ec.ct(n,this.serializer,i,o.referenceDelegate);return new Wc(a,n,r,i).recalculateAndSaveOverlaysForDocumentKeys(new gs(s,Pi.oe),e).next()})})}}function uh(e){e.createObjectStore("targetDocuments",{keyPath:Xi}).createIndex("documentTargetsIndex",Zi,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",Yi,{unique:!0}),e.createObjectStore("targetGlobal")}const ch="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class hh{constructor(e,t,n,r,i,s,a,o,u,c,h=16){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.si=i,this.window=s,this.document=a,this.oi=u,this._i=c,this.ai=h,this.Br=null,this.kr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.ui=null,this.inForeground=!1,this.ci=null,this.li=null,this.hi=Number.NEGATIVE_INFINITY,this.Pi=e=>Promise.resolve(),!hh.D())throw new Kr(Gr.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Pc(this,r),this.Ii=t+"main",this.serializer=new Nu(o),this.Ti=new xi(this.Ii,this.ai,new oh(this.serializer)),this.qr=new Ac(this.referenceDelegate,this.serializer),this.remoteDocumentCache=Uc(this.serializer),this.Kr=new ju,this.window&&this.window.localStorage?this.Ei=this.window.localStorage:(this.Ei=null,!1===c&&Br("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.di().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new Kr(Gr.FAILED_PRECONDITION,ch);return this.Ai(),this.Ri(),this.Vi(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.qr.getHighestSequenceNumber(e))}).then(e=>{this.Br=new Pi(e,this.oi)}).then(()=>{this.kr=!0}).catch(e=>(this.Ti&&this.Ti.close(),Promise.reject(e)))}mi(t){return this.Pi=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.Ti.L(async e=>{null===e.newVersion&&await t()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.si.enqueueAndForget(async()=>{this.started&&await this.di()}))}di(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",t=>dh(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.fi(t).next(e=>{e||(this.isPrimary=!1,this.si.enqueueRetryable(()=>this.Pi(!1)))})}).next(()=>this.gi(t)).next(e=>this.isPrimary&&!e?this.pi(t).next(()=>!1):!!e&&this.yi(t).next(()=>!0))).catch(e=>{if(Ni(e))return Vr("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return Vr("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.si.enqueueRetryable(()=>this.Pi(e)),this.isPrimary=e})}fi(e){return lh(e).get("owner").next(e=>Ti.resolve(this.wi(e)))}Si(e){return dh(e).delete(this.clientId)}async bi(){if(this.isPrimary&&!this.Di(this.hi,18e5)){this.hi=Date.now();var e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{const r=ms(e,"clientMetadata");return r.U().next(e=>{const t=this.Ci(e,18e5),n=e.filter(e=>-1===t.indexOf(e));return Ti.forEach(n,e=>r.delete(e.clientId)).next(()=>n)})}).catch(()=>[]);if(this.Ei)for(const t of e)this.Ei.removeItem(this.vi(t.clientId))}}Vi(){this.li=this.si.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.di().then(()=>this.bi()).then(()=>this.Vi()))}wi(e){return!!e&&e.ownerId===this.clientId}gi(t){return this._i?Ti.resolve(!0):lh(t).get("owner").next(e=>{if(null!==e&&this.Di(e.leaseTimestampMs,5e3)&&!this.Fi(e.ownerId)){if(this.wi(e)&&this.networkEnabled)return!0;if(!this.wi(e)){if(!e.allowTabSynchronization)throw new Kr(Gr.FAILED_PRECONDITION,ch);return!1}}return!(!this.networkEnabled||!this.inForeground)||dh(t).U().next(e=>void 0===this.Ci(e,5e3).find(e=>{if(this.clientId!==e.clientId){var t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&Vr("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.kr=!1,this.Mi(),this.li&&(this.li.cancel(),this.li=null),this.xi(),this.Oi(),await this.Ti.runTransaction("shutdown","readwrite",["owner","clientMetadata"],e=>{const t=new gs(e,Pi.oe);return this.pi(t).next(()=>this.Si(t))}),this.Ti.close(),this.Ni()}Ci(e,t){return e.filter(e=>this.Di(e.updateTimeMs,t)&&!this.Fi(e.clientId))}Li(){return this.runTransaction("getActiveClients","readonly",e=>dh(e).U().next(e=>this.Ci(e,18e5).map(e=>e.clientId)))}get started(){return this.kr}getMutationQueue(e,t){return Ec.ct(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new fc(e,this.serializer.ut.databaseId)}getDocumentOverlayCache(e){return Ku.ct(this.serializer,e)}getBundleCache(){return this.Kr}runTransaction(t,n,r){Vr("IndexedDbPersistence","Starting transaction:",t);var e,i="readonly"===n?"readonly":"readwrite",s=16===(e=this.ai)?fs:15===e?ds:14===e?ls:13===e?hs:12===e?cs:11===e?us:void jr();let a;return this.Ti.runTransaction(t,i,s,e=>(a=new gs(e,this.Br?this.Br.next():Pi.oe),"readwrite-primary"===n?this.fi(a).next(e=>!!e||this.gi(a)).next(e=>{if(!e)throw Br(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.si.enqueueRetryable(()=>this.Pi(!1)),new Kr(Gr.FAILED_PRECONDITION,bi);return r(a)}).next(e=>this.yi(a).next(()=>e)):this.Bi(a).next(()=>r(a)))).then(e=>(a.raiseOnCommittedEvent(),e))}Bi(e){return lh(e).get("owner").next(e=>{if(null!==e&&this.Di(e.leaseTimestampMs,5e3)&&!this.Fi(e.ownerId)&&!this.wi(e)&&!(this._i||this.allowTabSynchronization&&e.allowTabSynchronization))throw new Kr(Gr.FAILED_PRECONDITION,ch)})}yi(e){var t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return lh(e).put("owner",t)}static D(){return xi.D()}pi(e){const t=lh(e);return t.get("owner").next(e=>this.wi(e)?(Vr("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):Ti.resolve())}Di(e,t){var n=Date.now();return!(e<n-t||n<e&&(Br(`Detected an update time that is in the future: ${e} > ${n}`),1))}Ai(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.ci=()=>{this.si.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.di()))},this.document.addEventListener("visibilitychange",this.ci),this.inForeground="visible"===this.document.visibilityState)}xi(){this.ci&&(this.document.removeEventListener("visibilitychange",this.ci),this.ci=null)}Ri(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.ui=()=>{this.Mi();var e=/(?:Version|Mobile)\/1[456]/;h()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.si.enterRestrictedMode(!0),this.si.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.ui))}Oi(){this.ui&&(this.window.removeEventListener("pagehide",this.ui),this.ui=null)}Fi(e){var t;try{var n=null!==(null===(t=this.Ei)||void 0===t?void 0:t.getItem(this.vi(e)));return Vr("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return Br("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}Mi(){if(this.Ei)try{this.Ei.setItem(this.vi(this.clientId),String(Date.now()))}catch(e){Br("Failed to set zombie client id.",e)}}Ni(){if(this.Ei)try{this.Ei.removeItem(this.vi(this.clientId))}catch(e){}}vi(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function lh(e){return ms(e,"owner")}function dh(e){return ms(e,"clientMetadata")}function fh(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class gh{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.ki=n,this.qi=r}static Qi(e,t){let n=to(),r=to();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new gh(e,t.fromCache,n,r)}}class mh{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class ph{constructor(){this.Ki=!1,this.$i=!1,this.Ui=100,this.Wi=h()?8:0<Di(u())?6:4}initialize(e,t){this.Gi=e,this.indexManager=t,this.Ki=!0}getDocumentsMatchingQuery(n,r,e,t){const i={result:null};return this.zi(n,r).next(e=>{i.result=e}).next(()=>{if(!i.result)return this.ji(n,r,t,e).next(e=>{i.result=e})}).next(()=>{if(!i.result){const t=new mh;return this.Hi(n,r,t).next(e=>{if(i.result=e,this.$i)return this.Ji(n,r,t,e.size)})}}).next(()=>i.result)}Ji(e,t,n,r){return n.documentReadCount<this.Ui?(Pr()<=l.DEBUG&&Vr("QueryEngine","SDK will not create cache indexes for query:",za(t),"since it only creates cache indexes for collection contains","more than or equal to",this.Ui,"documents"),Ti.resolve()):(Pr()<=l.DEBUG&&Vr("QueryEngine","Query:",za(t),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.Wi*r?(Pr()<=l.DEBUG&&Vr("QueryEngine","The SDK decides to create cache indexes for query:",za(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,Va(t))):Ti.resolve())}zi(i,s){if(Fa(s))return Ti.resolve(null);let t=Va(s);return this.indexManager.getIndexType(i,t).next(e=>0===e?null:(null!==s.limit&&1===e&&(s=qa(s,null,"F"),t=Va(s)),this.indexManager.getDocumentsMatchingTarget(i,t).next(e=>{const r=to(...e);return this.Gi.getDocuments(i,r).next(n=>this.indexManager.getMinOffset(i,t).next(e=>{var t=this.Yi(s,n);return this.Zi(s,t,r,e.readTime)?this.zi(i,qa(s,null,"F")):this.Xi(i,t,s,e)}))})))}ji(n,r,i,s){return Fa(r)||s.isEqual(ai.min())?Ti.resolve(null):this.Gi.getDocuments(n,i).next(e=>{var t=this.Yi(r,e);return this.Zi(r,t,i,s)?Ti.resolve(null):(Pr()<=l.DEBUG&&Vr("QueryEngine","Re-using previous result from %s to execute query: %s",s.toString(),za(r)),this.Xi(n,t,r,yi(s,-1)).next(e=>e))})}Yi(n,e){let r=new Is($a(n));return e.forEach((e,t)=>{Ga(n,t)&&(r=r.add(t))}),r}Zi(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const i="F"===e.limitType?t.last():t.first();return!!i&&(i.hasPendingWrites||0<i.version.compareTo(r))}Hi(e,t,n){return Pr()<=l.DEBUG&&Vr("QueryEngine","Using full collection scan to execute query:",za(t)),this.Gi.getDocumentsMatchingQuery(e,t,wi.min(),n)}Xi(e,n,t,r){return this.Gi.getDocumentsMatchingQuery(e,t,r).next(t=>(n.forEach(e=>{t=t.insert(e.key,e)}),t))}}class yh{constructor(e,t,n,r){this.persistence=e,this.es=t,this.serializer=r,this.ts=new ws(ni),this.ns=new Qa(e=>xa(e),Da),this.rs=new Map,this.ss=e.getRemoteDocumentCache(),this.qr=e.getTargetCache(),this.Kr=e.getBundleCache(),this.os(n)}os(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new Wc(this.ss,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.ss.setIndexManager(this.indexManager),this.es.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.ts))}}function vh(e,t,n,r){return new yh(e,t,n,r)}async function wh(e,t){const a=e;return a.persistence.runTransaction("Handle user change","readonly",i=>{let s;return a.mutationQueue.getAllMutationBatches(i).next(e=>(s=e,a.os(t),a.mutationQueue.getAllMutationBatches(i))).next(e=>{const t=[],n=[];let r=to();for(const i of s){t.push(i.batchId);for(const e of i.mutations)r=r.add(e.key)}for(const i of e){n.push(i.batchId);for(const e of i.mutations)r=r.add(e.key)}return a.localDocuments.getDocuments(i,r).next(e=>({_s:e,removedBatchIds:t,addedBatchIds:n}))})})}function _h(e){const t=e;return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.qr.getLastRemoteSnapshotVersion(e))}function bh(e,c){const h=e,l=c.snapshotVersion;let d=h.ts;return h.persistence.runTransaction("Apply remote event","readwrite-primary",o=>{const e=h.ss.newChangeBuffer({trackRemovals:!0});d=h.ts;const u=[];c.targetChanges.forEach((t,n)=>{const r=d.get(n);if(r){u.push(h.qr.removeMatchingKeys(o,t.removedDocuments,n).next(()=>h.qr.addMatchingKeys(o,t.addedDocuments,n)));let e=r.withSequenceNumber(o.currentSequenceNumber);var i,s,a;null!==c.targetMismatches.get(n)?e=e.withResumeToken(Ds.EMPTY_BYTE_STRING,ai.min()).withLastLimboFreeSnapshotVersion(ai.min()):0<t.resumeToken.approximateByteSize()&&(e=e.withResumeToken(t.resumeToken,l)),d=d.insert(n,e),i=r,s=e,a=t,0!==i.resumeToken.approximateByteSize()&&!(3e8<=s.snapshotVersion.toMicroseconds()-i.snapshotVersion.toMicroseconds()||0<a.addedDocuments.size+a.modifiedDocuments.size+a.removedDocuments.size)||u.push(h.qr.updateTargetData(o,e))}});let t=Ha,n=to();if(c.documentUpdates.forEach(e=>{c.resolvedLimboDocuments.has(e)&&u.push(h.persistence.referenceDelegate.updateLimboDocument(o,e))}),u.push(Ih(o,e,c.documentUpdates).next(e=>{t=e.us,n=e.cs})),!l.isEqual(ai.min())){const c=h.qr.getLastRemoteSnapshotVersion(o).next(e=>h.qr.setTargetsMetadata(o,o.currentSequenceNumber,l));u.push(c)}return Ti.waitFor(u).next(()=>e.apply(o)).next(()=>h.localDocuments.getLocalViewOfDocuments(o,t,n)).next(()=>t)}).then(e=>(h.ts=d,e))}function Ih(e,s,t){let n=to(),a=to();return t.forEach(e=>n=n.add(e)),s.getEntries(e,n).next(r=>{let i=Ha;return t.forEach((e,t)=>{const n=r.get(e);t.isFoundDocument()!==n.isFoundDocument()&&(a=a.add(e)),t.isNoDocument()&&t.version.isEqual(ai.min())?(s.removeEntry(e,t.readTime),i=i.insert(e,t)):!n.isValidDocument()||0<t.version.compareTo(n.version)||0===t.version.compareTo(n.version)&&n.hasPendingWrites?(s.addEntry(t),i=i.insert(e,t)):Vr("LocalStore","Ignoring outdated watch update for ",e,". Current version:",n.version," Watch version:",t.version)}),{us:i,cs:a}})}function Eh(e,r){const i=e;return i.persistence.runTransaction("Allocate target","readwrite",t=>{let n;return i.qr.getTargetData(t,r).next(e=>e?(n=e,Ti.resolve(n)):i.qr.allocateTargetId(t).next(e=>(n=new Au(r,e,"TargetPurposeListen",t.currentSequenceNumber),i.qr.addTargetData(t,n).next(()=>n))))}).then(e=>{var t=i.ts.get(e.targetId);return(null===t||0<e.snapshotVersion.compareTo(t.snapshotVersion))&&(i.ts=i.ts.insert(e.targetId,e),i.ns.set(r,e.targetId)),e})}async function Th(e,t,n){const r=e,i=r.ts.get(t),s=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",s,e=>r.persistence.referenceDelegate.removeTarget(e,i))}catch(e){if(!Ni(e))throw e;Vr("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}r.ts=r.ts.remove(t),r.ns.delete(i.target)}function Sh(e,n,r){const i=e;let s=ai.min(),a=to();return i.persistence.runTransaction("Execute query","readwrite",t=>function(e,t,n){const r=e,i=r.ns.get(n);return void 0!==i?Ti.resolve(r.ts.get(i)):r.qr.getTargetData(t,n)}(i,t,Va(n)).next(e=>{if(e)return s=e.lastLimboFreeSnapshotVersion,i.qr.getMatchingKeysForTargetId(t,e.targetId).next(e=>{a=e})}).next(()=>i.es.getDocumentsMatchingQuery(t,n,r?s:ai.min(),r?a:to())).next(e=>(Ch(i,Ka(n),e),{documents:e,ls:a})))}function xh(e,t){const n=e,r=n.qr,i=n.ts.get(t);return i?Promise.resolve(i.target):n.persistence.runTransaction("Get target data","readonly",e=>r.ot(e,t).next(e=>e?e.target:null))}function Dh(e,t){const n=e,r=n.rs.get(t)||ai.min();return n.persistence.runTransaction("Get new document changes","readonly",e=>n.ss.getAllFromCollectionGroup(e,t,yi(r,-1),Number.MAX_SAFE_INTEGER)).then(e=>(Ch(n,t,e),e))}function Ch(e,t,n){let r=e.rs.get(t)||ai.min();n.forEach((e,t)=>{0<t.readTime.compareTo(r)&&(r=t.readTime)}),e.rs.set(t,r)}function Ah(e,t){return`firestore_clients_${e}_${t}`}function Nh(e,t,n){let r=`firestore_mutations_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}function kh(e,t){return`firestore_targets_${e}_${t}`}class Rh{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Ts(e,t,n){var r=JSON.parse(n);let i,s="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return s&&r.error&&(s="string"==typeof r.error.message&&"string"==typeof r.error.code,s&&(i=new Kr(r.error.code,r.error.message))),s?new Rh(e,t,r.state,i):(Br("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}Es(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Mh{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Ts(e,t){var n=JSON.parse(t);let r,i="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return i&&n.error&&(i="string"==typeof n.error.message&&"string"==typeof n.error.code,i&&(r=new Kr(n.error.code,n.error.message))),i?new Mh(e,n.state,r):(Br("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}Es(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Lh{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Ts(e,t){var n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,i=no;for(let s=0;r&&s<n.activeTargetIds.length;++s)r=qi(n.activeTargetIds[s]),i=i.add(n.activeTargetIds[s]);return r?new Lh(e,i):(Br("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class Fh{constructor(e,t){this.clientId=e,this.onlineState=t}static Ts(e){var t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new Fh(t.clientId,t.onlineState):(Br("SharedClientState",`Failed to parse online state: ${e}`),null)}}class Oh{constructor(){this.activeTargetIds=no}ds(e){this.activeTargetIds=this.activeTargetIds.add(e)}As(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Es(){var e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class Ph{constructor(e,t,n,r,i){this.window=e,this.si=t,this.persistenceKey=n,this.Rs=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Vs=this.fs.bind(this),this.gs=new ws(ni),this.started=!1,this.ps=[];var s=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=i,this.ys=Ah(this.persistenceKey,this.Rs),this.ws=`firestore_sequence_number_${this.persistenceKey}`,this.gs=this.gs.insert(this.Rs,new Oh),this.Ss=new RegExp(`^firestore_clients_${s}_([^_]*)$`),this.bs=new RegExp(`^firestore_mutations_${s}_(\\d+)(?:_(.*))?$`),this.Ds=new RegExp(`^firestore_targets_${s}_(\\d+)$`),this.Cs=`firestore_online_state_${this.persistenceKey}`,this.vs=`firestore_bundle_loaded_v2_${this.persistenceKey}`,this.window.addEventListener("storage",this.Vs)}static D(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.Li();for(const n of e)if(n!==this.Rs){const e=this.getItem(Ah(this.persistenceKey,n));var t;!e||(t=Lh.Ts(n,e))&&(this.gs=this.gs.insert(t.clientId,t))}this.Fs();const n=this.storage.getItem(this.Cs);if(n){const e=this.Ms(n);e&&this.xs(e)}for(const e of this.ps)this.fs(e);this.ps=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.ws,JSON.stringify(e))}getAllActiveQueryTargets(){return this.Os(this.gs)}isActiveQueryTarget(n){let r=!1;return this.gs.forEach((e,t)=>{t.activeTargetIds.has(n)&&(r=!0)}),r}addPendingMutation(e){this.Ns(e,"pending")}updateMutationState(e,t,n){this.Ns(e,t,n),this.Ls(e)}addLocalQueryTarget(e){let t="not-current";var n;return this.isActiveQueryTarget(e)&&(!(n=this.storage.getItem(kh(this.persistenceKey,e)))||(n=Mh.Ts(e,n))&&(t=n.state)),this.Bs.ds(e),this.Fs(),t}removeLocalQueryTarget(e){this.Bs.As(e),this.Fs()}isLocalQueryTarget(e){return this.Bs.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(kh(this.persistenceKey,e))}updateQueryState(e,t,n){this.ks(e,t,n)}handleUserChange(e,t,n){t.forEach(e=>{this.Ls(e)}),this.currentUser=e,n.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.qs(e)}notifyBundleLoaded(e){this.Qs(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Vs),this.removeItem(this.ys),this.started=!1)}getItem(e){var t=this.storage.getItem(e);return Vr("SharedClientState","READ",e,t),t}setItem(e,t){Vr("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){Vr("SharedClientState","REMOVE",e),this.storage.removeItem(e)}fs(e){const i=e;i.storageArea===this.storage&&(Vr("SharedClientState","EVENT",i.key,i.newValue),i.key!==this.ys?this.si.enqueueRetryable(async()=>{if(this.started){if(null!==i.key)if(this.Ss.test(i.key)){if(null==i.newValue){var e=this.Ks(i.key);return this.$s(e,null)}e=this.Us(i.key,i.newValue);if(e)return this.$s(e.clientId,e)}else if(this.bs.test(i.key)){if(null!==i.newValue){var t=this.Ws(i.key,i.newValue);if(t)return this.Gs(t)}}else if(this.Ds.test(i.key)){if(null!==i.newValue){t=this.zs(i.key,i.newValue);if(t)return this.js(t)}}else if(i.key===this.Cs){if(null!==i.newValue){var n=this.Ms(i.newValue);if(n)return this.xs(n)}}else if(i.key===this.ws){n=function(e){let t=Pi.oe;if(null!=e)try{var n=JSON.parse(e);zr("number"==typeof n),t=n}catch(e){Br("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(i.newValue);n!==Pi.oe&&this.sequenceNumberHandler(n)}else if(i.key===this.vs){const r=this.Hs(i.newValue);await Promise.all(r.map(e=>this.syncEngine.Js(e)))}}else this.ps.push(i)}):Br("Received WebStorage notification for local change. Another client might have garbage-collected our state"))}get Bs(){return this.gs.get(this.Rs)}Fs(){this.setItem(this.ys,this.Bs.Es())}Ns(e,t,n){const r=new Rh(this.currentUser,e,t,n),i=Nh(this.persistenceKey,this.currentUser,e);this.setItem(i,r.Es())}Ls(e){var t=Nh(this.persistenceKey,this.currentUser,e);this.removeItem(t)}qs(e){var t={clientId:this.Rs,onlineState:e};this.storage.setItem(this.Cs,JSON.stringify(t))}ks(e,t,n){const r=kh(this.persistenceKey,e),i=new Mh(e,t,n);this.setItem(r,i.Es())}Qs(e){var t=JSON.stringify(Array.from(e));this.setItem(this.vs,t)}Ks(e){var t=this.Ss.exec(e);return t?t[1]:null}Us(e,t){var n=this.Ks(e);return Lh.Ts(n,t)}Ws(e,t){var n=this.bs.exec(e),r=Number(n[1]),n=void 0!==n[2]?n[2]:null;return Rh.Ts(new Lr(n),r,t)}zs(e,t){var n=this.Ds.exec(e),n=Number(n[1]);return Mh.Ts(n,t)}Ms(e){return Fh.Ts(e)}Hs(e){return JSON.parse(e)}async Gs(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.Ys(e.batchId,e.state,e.error);Vr("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)}js(e){return this.syncEngine.Zs(e.targetId,e.state,e.error)}$s(e,t){const n=t?this.gs.insert(e,t):this.gs.remove(e),r=this.Os(this.gs),i=this.Os(n),s=[],a=[];return i.forEach(e=>{r.has(e)||s.push(e)}),r.forEach(e=>{i.has(e)||a.push(e)}),this.syncEngine.Xs(s,a).then(()=>{this.gs=n})}xs(e){this.gs.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}Os(e){let n=no;return e.forEach((e,t)=>{n=n.unionWith(t.activeTargetIds)}),n}}class Vh{constructor(){this.eo=new Oh,this.no={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.eo.ds(e),this.no[e]||"not-current"}updateQueryState(e,t,n){this.no[e]=t}removeLocalQueryTarget(e){this.eo.As(e)}isLocalQueryTarget(e){return this.eo.activeTargetIds.has(e)}clearQueryState(e){delete this.no[e]}getAllActiveQueryTargets(){return this.eo.activeTargetIds}isActiveQueryTarget(e){return this.eo.activeTargetIds.has(e)}start(){return this.eo=new Oh,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class Bh{ro(e){}shutdown(){}}class qh{constructor(){this.io=()=>this.so(),this.oo=()=>this._o(),this.ao=[],this.uo()}ro(e){this.ao.push(e)}shutdown(){window.removeEventListener("online",this.io),window.removeEventListener("offline",this.oo)}uo(){window.addEventListener("online",this.io),window.addEventListener("offline",this.oo)}so(){Vr("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.ao)e(0)}_o(){Vr("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.ao)e(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let Uh=null;function jh(){return null===Uh?Uh=268435456+Math.round(2147483648*Math.random()):Uh++,"0x"+Uh.toString(16)}const zh={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class Gh{constructor(e){this.co=e.co,this.lo=e.lo}ho(e){this.Po=e}Io(e){this.To=e}Eo(e){this.Ao=e}onMessage(e){this.Ro=e}close(){this.lo()}send(e){this.co(e)}Vo(){this.Po()}mo(){this.To()}fo(e){this.Ao(e)}po(e){this.Ro(e)}}const Kh="WebChannelConnection";class $h extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;var t=e.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.yo=t+"://"+e.host,this.wo=`projects/${n}/databases/${r}`,this.So="(default)"===this.databaseId.database?`project_id=${n}`:`project_id=${n}&database_id=${r}`}get bo(){return!1}Do(t,e,n,r,i){const s=jh(),a=this.Co(t,e.toUriEncodedString());Vr("RestConnection",`Sending RPC '${t}' ${s}:`,a,n);var o={"google-cloud-resource-prefix":this.wo,"x-goog-request-params":this.So};return this.vo(o,r,i),this.Fo(t,a,o,n).then(e=>(Vr("RestConnection",`Received RPC '${t}' ${s}: `,e),e),e=>{throw qr("RestConnection",`RPC '${t}' ${s} failed with error: `,e,"url: ",a,"request:",n),e})}Mo(e,t,n,r,i,s){return this.Do(e,t,n,r,i)}vo(n,e,t){n["X-Goog-Api-Client"]="gl-js/ fire/"+Fr,n["Content-Type"]="text/plain",this.databaseInfo.appId&&(n["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach((e,t)=>n[t]=e),t&&t.headers.forEach((e,t)=>n[t]=e)}Co(e,t){var n=zh[e];return`${this.yo}/v1/${t}:${n}`}terminate(){}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}Fo(u,t,n,r){const c=jh();return new Promise((s,a)=>{const o=new Nr;o.setWithCredentials(!0),o.listenOnce(Tr.COMPLETE,()=>{try{switch(o.getLastErrorCode()){case Er.NO_ERROR:var e=o.getResponseJson();Vr(Kh,`XHR for RPC '${u}' ${c} received:`,JSON.stringify(e)),s(e);break;case Er.TIMEOUT:Vr(Kh,`RPC '${u}' ${c} timed out`),a(new Kr(Gr.DEADLINE_EXCEEDED,"Request time out"));break;case Er.HTTP_ERROR:var t=o.getStatus();if(Vr(Kh,`RPC '${u}' ${c} failed with status:`,t,"response text:",o.getResponseText()),0<t){let e=o.getResponseJson();Array.isArray(e)&&(e=e[0]);var n=null==e?void 0:e.error;if(n&&n.status&&n.message){const u=(r=n.status,i=r.toLowerCase().replace(/_/g,"-"),0<=Object.values(Gr).indexOf(i)?i:Gr.UNKNOWN);a(new Kr(u,n.message))}else a(new Kr(Gr.UNKNOWN,"Server responded with status "+o.getStatus()))}else a(new Kr(Gr.UNAVAILABLE,"Connection failed."));break;default:jr()}}finally{Vr(Kh,`RPC '${u}' ${c} completed.`)}var r,i});var e=JSON.stringify(r);Vr(Kh,`RPC '${u}' ${c} sending request:`,r),o.send(t,"POST",e,n,15)})}xo(i,e,t){const s=jh(),n=[this.yo,"/","google.firestore.v1.Firestore","/",i,"/channel"],r=new Wn,a=Ir(),o={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(o.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(o.xmlHttpFactory=new Cr({})),this.vo(o.initMessageHeaders,e,t),o.encodeInitMessageHeaders=!0;var c=n.join("");Vr(Kh,`Creating RPC '${i}' stream ${s}: ${c}`,o);const h=r.createWebChannel(c,o);let l=!1,d=!1;const f=new Gh({co:e=>{d?Vr(Kh,`Not sending because RPC '${i}' stream ${s} is closed:`,e):(l||(Vr(Kh,`Opening RPC '${i}' stream ${s} transport.`),h.open(),l=!0),Vr(Kh,`RPC '${i}' stream ${s} sending:`,e),h.send(e))},lo:()=>h.close()}),g=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};return g(h,Ar.EventType.OPEN,()=>{d||(Vr(Kh,`RPC '${i}' stream ${s} transport opened.`),f.Vo())}),g(h,Ar.EventType.CLOSE,()=>{d||(d=!0,Vr(Kh,`RPC '${i}' stream ${s} transport closed`),f.fo())}),g(h,Ar.EventType.ERROR,e=>{d||(d=!0,qr(Kh,`RPC '${i}' stream ${s} transport errored:`,e),f.fo(new Kr(Gr.UNAVAILABLE,"The operation could not be completed")))}),g(h,Ar.EventType.MESSAGE,n=>{if(!d){var e=n.data[0];zr(!!e);var r=e.error||(null===(r=e[0])||void 0===r?void 0:r.error);if(r){Vr(Kh,`RPC '${i}' stream ${s} received error:`,r);const n=r.status;let e=function(e){var t=wr[e];if(void 0!==t)return Vo(t)}(n),t=r.message;void 0===e&&(e=Gr.INTERNAL,t="Unknown error status: "+n+" with message "+r.message),d=!0,f.fo(new Kr(e,t)),h.close()}else Vr(Kh,`RPC '${i}' stream ${s} received:`,e),f.po(e)}}),g(a,Sr.STAT_EVENT,e=>{e.stat===xr?Vr(Kh,`RPC '${i}' stream ${s} detected buffering proxy`):e.stat===Dr&&Vr(Kh,`RPC '${i}' stream ${s} detected no buffering proxy`)}),setTimeout(()=>{f.mo()},0),f}}function Qh(){return"undefined"!=typeof window?window:null}function Hh(){return"undefined"!=typeof document?document:null}function Wh(e){return new ru(e,!0)}class Jh{constructor(e,t,n=1e3,r=1.5,i=6e4){this.si=e,this.timerId=t,this.Oo=n,this.No=r,this.Lo=i,this.Bo=0,this.ko=null,this.qo=Date.now(),this.reset()}reset(){this.Bo=0}Qo(){this.Bo=this.Lo}Ko(e){this.cancel();var t=Math.floor(this.Bo+this.$o()),n=Math.max(0,Date.now()-this.qo),r=Math.max(0,t-n);0<r&&Vr("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.Bo} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.ko=this.si.enqueueAfterDelay(this.timerId,r,()=>(this.qo=Date.now(),e())),this.Bo*=this.No,this.Bo<this.Oo&&(this.Bo=this.Oo),this.Bo>this.Lo&&(this.Bo=this.Lo)}Uo(){null!==this.ko&&(this.ko.skipDelay(),this.ko=null)}cancel(){null!==this.ko&&(this.ko.cancel(),this.ko=null)}$o(){return(Math.random()-.5)*this.Bo}}class Yh{constructor(e,t,n,r,i,s,a,o){this.si=e,this.Wo=n,this.Go=r,this.connection=i,this.authCredentialsProvider=s,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.zo=0,this.jo=null,this.Ho=null,this.stream=null,this.Jo=new Jh(e,t)}Yo(){return 1===this.state||5===this.state||this.Zo()}Zo(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Xo()}async stop(){this.Yo()&&await this.close(0)}e_(){this.state=0,this.Jo.reset()}t_(){this.Zo()&&null===this.jo&&(this.jo=this.si.enqueueAfterDelay(this.Wo,6e4,()=>this.n_()))}r_(e){this.i_(),this.stream.send(e)}async n_(){if(this.Zo())return this.close(0)}i_(){this.jo&&(this.jo.cancel(),this.jo=null)}s_(){this.Ho&&(this.Ho.cancel(),this.Ho=null)}async close(e,t){this.i_(),this.s_(),this.Jo.cancel(),this.zo++,4!==e?this.Jo.reset():t&&t.code===Gr.RESOURCE_EXHAUSTED?(Br(t.toString()),Br("Using maximum backoff delay to prevent overloading the backend."),this.Jo.Qo()):t&&t.code===Gr.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.o_(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Eo(t)}o_(){}auth(){this.state=1;const e=this.__(this.zo),n=this.zo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,t])=>{this.zo===n&&this.a_(e,t)},t=>{e(()=>{var e=new Kr(Gr.UNKNOWN,"Fetching auth token failed: "+t.message);return this.u_(e)})})}a_(e,t){const n=this.__(this.zo);this.stream=this.c_(e,t),this.stream.ho(()=>{n(()=>this.listener.ho())}),this.stream.Io(()=>{n(()=>(this.state=2,this.Ho=this.si.enqueueAfterDelay(this.Go,1e4,()=>(this.Zo()&&(this.state=3),Promise.resolve())),this.listener.Io()))}),this.stream.Eo(e=>{n(()=>this.u_(e))}),this.stream.onMessage(e=>{n(()=>this.onMessage(e))})}Xo(){this.state=5,this.Jo.Ko(async()=>{this.state=0,this.start()})}u_(e){return Vr("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}__(t){return e=>{this.si.enqueueAndForget(()=>this.zo===t?e():(Vr("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class Xh extends Yh{constructor(e,t,n,r,i,s){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}c_(e,t){return this.connection.xo("Listen",e,t)}onMessage(e){this.Jo.reset();var t=function(e,t){let n;if("targetChange"in t){t.targetChange;var r="NO_CHANGE"===(f=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===f?1:"REMOVE"===f?2:"CURRENT"===f?3:"RESET"===f?4:jr(),i=t.targetChange.targetIds||[],s=(f=t.targetChange.resumeToken,e.useProto3Json?(zr(void 0===f||"string"==typeof f),Ds.fromBase64String(f||"")):(zr(void 0===f||f instanceof Buffer||f instanceof Uint8Array),Ds.fromUint8Array(f||new Uint8Array))),a=t.targetChange.cause,o=a&&(o=void 0===(f=a).code?Gr.UNKNOWN:Vo(f.code),new Kr(o,f.message||""));n=new Wo(r,i,s,o||null)}else if("documentChange"in t){t.documentChange;var u=t.documentChange;u.document,u.document.name,u.document.updateTime;var s=du(e,u.document.name),o=ou(u.document.updateTime),c=u.document.createTime?ou(u.document.createTime):ai.min(),h=new ta({mapValue:{fields:u.document.fields}}),c=na.newFoundDocument(s,o,c,h),h=u.targetIds||[],u=u.removedTargetIds||[];n=new Qo(h,u,c.key,c)}else if("documentDelete"in t){t.documentDelete;h=t.documentDelete;h.document;u=du(e,h.document),c=h.readTime?ou(h.readTime):ai.min(),c=na.newNoDocument(u,c),h=h.removedTargetIds||[];n=new Qo([],h,c.key,c)}else if("documentRemove"in t){t.documentRemove;var l=t.documentRemove;l.document;var d=du(e,l.document),l=l.removedTargetIds||[];n=new Qo([],l,d,null)}else{if(!("filter"in t))return jr();{t.filter;const e=t.filter;e.targetId;var{count:l=0,unchangedNames:d}=e,l=new Oo(l,d),d=e.targetId;n=new Ho(d,l)}}var o,f;return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return ai.min();var t=e.targetChange;return(!t.targetIds||!t.targetIds.length)&&t.readTime?ou(t.readTime):ai.min()}(e);return this.listener.l_(t,n)}h_(e){const t={};t.database=mu(this.serializer),t.addTarget=function(e,t){let n;const r=t.target;if(n=Ca(r)?{documents:bu(e,r)}:{query:Iu(e,r)._t},n.targetId=t.targetId,0<t.resumeToken.approximateByteSize()){n.resumeToken=au(e,t.resumeToken);const r=iu(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(0<t.snapshotVersion.compareTo(ai.min())){n.readTime=su(e,t.snapshotVersion.toTimestamp());const r=iu(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);var n,n=(this.serializer,e,null==(n=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return jr()}}(e.purpose))?null:{"goog-listen-tags":n});n&&(t.labels=n),this.r_(t)}P_(e){const t={};t.database=mu(this.serializer),t.removeTarget=e,this.r_(t)}}class Zh extends Yh{constructor(e,t,n,r,i,s){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i,this.I_=!1}get T_(){return this.I_}start(){this.I_=!1,this.lastStreamToken=void 0,super.start()}o_(){this.I_&&this.E_([])}c_(e,t){return this.connection.xo("Write",e,t)}onMessage(e){if(zr(!!e.streamToken),this.lastStreamToken=e.streamToken,this.I_){this.Jo.reset();var t=(r=e.writeResults,i=e.commitTime,r&&0<r.length?(zr(void 0!==i),r.map(e=>function(e,t){let n=e.updateTime?ou(e.updateTime):ou(t);return n.isEqual(ai.min())&&(n=ou(t)),new vo(n,e.transformResults||[])}(e,i))):[]),n=ou(e.commitTime);return this.listener.d_(n,t)}var r,i;return zr(!e.writeResults||0===e.writeResults.length),this.I_=!0,this.listener.A_()}R_(){const e={};e.database=mu(this.serializer),this.r_(e)}E_(e){var t={streamToken:this.lastStreamToken,writes:e.map(e=>wu(this.serializer,e))};this.r_(t)}}class el extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.V_=!1}m_(){if(this.V_)throw new Kr(Gr.FAILED_PRECONDITION,"The client has already been terminated.")}Do(n,r,i,s){return this.m_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.connection.Do(n,cu(r,i),s,e,t)).catch(e=>{throw"FirebaseError"===e.name?(e.code===Gr.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new Kr(Gr.UNKNOWN,e.toString())})}Mo(n,r,i,s,a){return this.m_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.connection.Mo(n,cu(r,i),s,e,t,a)).catch(e=>{throw"FirebaseError"===e.name?(e.code===Gr.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new Kr(Gr.UNKNOWN,e.toString())})}terminate(){this.V_=!0,this.connection.terminate()}}class tl{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.g_=0,this.p_=null,this.y_=!0}w_(){0===this.g_&&(this.S_("Unknown"),this.p_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.p_=null,this.b_("Backend didn't respond within 10 seconds."),this.S_("Offline"),Promise.resolve())))}D_(e){"Online"===this.state?this.S_("Unknown"):(this.g_++,1<=this.g_&&(this.C_(),this.b_(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.S_("Offline")))}set(e){this.C_(),this.g_=0,"Online"===e&&(this.y_=!1),this.S_(e)}S_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}b_(e){var t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.y_?(Br(t),this.y_=!1):Vr("OnlineStateTracker",t)}C_(){null!==this.p_&&(this.p_.cancel(),this.p_=null)}}class nl{constructor(e,t,n,r,i){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.v_=[],this.F_=new Map,this.M_=new Set,this.x_=[],this.O_=i,this.O_.ro(e=>{n.enqueueAndForget(async()=>{ll(this)&&(Vr("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=e;t.M_.add(4),await il(t),t.N_.set("Unknown"),t.M_.delete(4),await rl(t)}(this))})}),this.N_=new tl(n,r)}}async function rl(e){if(ll(e))for(const t of e.x_)await t(!0)}async function il(e){for(const t of e.x_)await t(!1)}function sl(e,t){const n=e;n.F_.has(t.targetId)||(n.F_.set(t.targetId,t),hl(n)?cl(n):bl(n).Zo()&&ol(n,t))}function al(e,t){const n=e,r=bl(n);n.F_.delete(t),r.Zo()&&ul(n,t),0===n.F_.size&&(r.Zo()?r.t_():ll(n)&&n.N_.set("Unknown"))}function ol(e,t){var n;e.L_.xe(t.targetId),(0<t.resumeToken.approximateByteSize()||0<t.snapshotVersion.compareTo(ai.min()))&&(n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size,t=t.withExpectedCount(n)),bl(e).h_(t)}function ul(e,t){e.L_.xe(t),bl(e).P_(t)}function cl(t){t.L_=new Yo({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),ot:e=>t.F_.get(e)||null,tt:()=>t.datastore.serializer.databaseId}),bl(t).start(),t.N_.w_()}function hl(e){return ll(e)&&!bl(e).Yo()&&0<e.F_.size}function ll(e){return 0===e.M_.size}function dl(e){e.L_=void 0}async function fl(e,t,n){if(!Ni(t))throw t;e.M_.add(1),await il(e),e.N_.set("Offline"),n=n||(()=>_h(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{Vr("RemoteStore","Retrying IndexedDB access"),await n(),e.M_.delete(1),await rl(e)})}function gl(t,n){return n().catch(e=>fl(t,e,n))}async function ml(e){const t=e,n=Il(t);let r=0<t.v_.length?t.v_[t.v_.length-1].batchId:-1;for(;ll(i=t)&&i.v_.length<10;)try{const e=await function(e,t){const n=e;return n.persistence.runTransaction("Get next mutation batch","readonly",e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t)))}(t.localStore,r);if(null===e){0===t.v_.length&&n.t_();break}r=e.batchId,function(e,t){e.v_.push(t);const n=Il(e);n.Zo()&&n.T_&&n.E_(t.mutations)}(t,e)}catch(e){await fl(t,e)}var i;pl(t)&&yl(t)}function pl(e){return ll(e)&&!Il(e).Yo()&&0<e.v_.length}function yl(e){Il(e).start()}async function vl(e,t){t&&Il(e).T_&&await async function(e,t){if(Po(n=t.code)&&n!==Gr.ABORTED){const r=e.v_.shift();Il(e).e_(),await gl(e,()=>e.remoteSyncer.rejectFailedWrite(r.batchId,t)),await ml(e)}var n}(e,t),pl(e)&&yl(e)}async function wl(e,t){const n=e;n.asyncQueue.verifyOperationInProgress(),Vr("RemoteStore","RemoteStore received new credentials");var r=ll(n);n.M_.add(3),await il(n),r&&n.N_.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.M_.delete(3),await rl(n)}async function _l(e,t){const n=e;t?(n.M_.delete(2),await rl(n)):(n.M_.add(2),await il(n),n.N_.set("Unknown"))}function bl(t){return t.B_||(t.B_=function(e,t,n){const r=e;return r.m_(),new Xh(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(t.datastore,t.asyncQueue,{ho:(async function(e){e.N_.set("Online")}).bind(null,t),Io:(async function(n){n.F_.forEach((e,t)=>{ol(n,e)})}).bind(null,t),Eo:(async function(e,t){dl(e),hl(e)?(e.N_.D_(t),cl(e)):e.N_.set("Unknown")}).bind(null,t),l_:(async function(e,t,n){if(e.N_.set("Online"),t instanceof Wo&&2===t.state&&t.cause)try{await async function(e,t){var n=t.cause;for(const r of t.targetIds)e.F_.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.F_.delete(r),e.L_.removeTarget(r))}(e,t)}catch(n){Vr("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await fl(e,n)}else if(t instanceof Qo?e.L_.Ke(t):t instanceof Ho?e.L_.He(t):e.L_.We(t),!n.isEqual(ai.min()))try{const t=await _h(e.localStore);0<=n.compareTo(t)&&await function(i,r){const e=i.L_.rt(r);return e.targetChanges.forEach((e,t)=>{if(0<e.resumeToken.approximateByteSize()){const n=i.F_.get(t);n&&i.F_.set(t,n.withResumeToken(e.resumeToken,r))}}),e.targetMismatches.forEach((e,t)=>{const n=i.F_.get(e);var r;n&&(i.F_.set(e,n.withResumeToken(Ds.EMPTY_BYTE_STRING,n.snapshotVersion)),ul(i,e),r=new Au(n.target,e,t,n.sequenceNumber),ol(i,r))}),i.remoteSyncer.applyRemoteEvent(e)}(e,n)}catch(t){Vr("RemoteStore","Failed to raise snapshot:",t),await fl(e,t)}}).bind(null,t)}),t.x_.push(async e=>{e?(t.B_.e_(),hl(t)?cl(t):t.N_.set("Unknown")):(await t.B_.stop(),dl(t))})),t.B_}function Il(t){return t.k_||(t.k_=function(e,t,n){const r=e;return r.m_(),new Zh(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(t.datastore,t.asyncQueue,{ho:()=>Promise.resolve(),Io:(async function(e){Il(e).R_()}).bind(null,t),Eo:vl.bind(null,t),A_:(async function(e){const t=Il(e);for(const n of e.v_)t.E_(n.mutations)}).bind(null,t),d_:(async function(e,t,n){const r=e.v_.shift(),i=Lo.from(r,t,n);await gl(e,()=>e.remoteSyncer.applySuccessfulWrite(i)),await ml(e)}).bind(null,t)}),t.x_.push(async e=>{e?(t.k_.e_(),await ml(t)):(await t.k_.stop(),0<t.v_.length&&(Vr("RemoteStore",`Stopping write stream with ${t.v_.length} pending writes`),t.v_=[]))})),t.k_}class El{constructor(e,t,n,r,i){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new $r,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,n,r,i){const s=Date.now()+n,a=new El(e,t,s,r,i);return a.start(n),a}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Kr(Gr.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Tl(e,t){if(Br("AsyncQueue",`${t}: ${e}`),Ni(e))return new Kr(Gr.UNAVAILABLE,`${t}: ${e}`);throw e}class Sl{constructor(n){this.comparator=n?(e,t)=>n(e,t)||li.comparator(e.key,t.key):(e,t)=>li.comparator(e.key,t.key),this.keyedMap=Ja(),this.sortedSet=new ws(this.comparator)}static emptySet(e){return new Sl(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){var t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(n){this.sortedSet.inorderTraversal((e,t)=>(n(e),!1))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){var t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof Sl))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach(e=>{t.push(e.toString())}),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(e,t){const n=new Sl;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class xl{constructor(){this.q_=new ws(li.comparator)}track(e){var t=e.doc.key,n=this.q_.get(t);!n||0!==e.type&&3===n.type?this.q_=this.q_.insert(t,e):3===e.type&&1!==n.type?this.q_=this.q_.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.q_=this.q_.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.q_=this.q_.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.q_=this.q_.remove(t):1===e.type&&2===n.type?this.q_=this.q_.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.q_=this.q_.insert(t,{type:2,doc:e.doc}):jr()}Q_(){const n=[];return this.q_.inorderTraversal((e,t)=>{n.push(t)}),n}}class Dl{constructor(e,t,n,r,i,s,a,o,u){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=s,this.syncStateChanged=a,this.excludesMetadataChanges=o,this.hasCachedResults=u}static fromInitialDocuments(e,t,n,r,i){const s=[];return t.forEach(e=>{s.push({type:0,doc:e})}),new Dl(e,t,Sl.emptySet(t),s,n,r,!0,!1,i)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&Ua(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let r=0;r<t.length;r++)if(t[r].type!==n[r].type||!t[r].doc.isEqual(n[r].doc))return!1;return!0}}class Cl{constructor(){this.K_=void 0,this.U_=[]}W_(){return this.U_.some(e=>e.G_())}}class Al{constructor(){this.queries=new Qa(e=>ja(e),Ua),this.onlineState="Unknown",this.z_=new Set}}async function Nl(e,t){const n=e;let r=3;var i=t.query;let s=n.queries.get(i);s?!s.W_()&&t.G_()&&(r=2):(s=new Cl,r=t.G_()?0:1);try{switch(r){case 0:s.K_=await n.onListen(i,!0);break;case 1:s.K_=await n.onListen(i,!1);break;case 2:await n.onFirstRemoteStoreListen(i)}}catch(e){const n=Tl(e,`Initialization of query '${za(t.query)}' failed`);return void t.onError(n)}n.queries.set(i,s),s.U_.push(t),t.j_(n.onlineState),!s.K_||t.H_(s.K_)&&Rl(n)}async function kl(e,t){const n=e,r=t.query;let i=3;const s=n.queries.get(r);if(s){const e=s.U_.indexOf(t);0<=e&&(s.U_.splice(e,1),0===s.U_.length?i=t.G_()?0:1:!s.W_()&&t.G_()&&(i=2))}switch(i){case 0:return n.queries.delete(r),n.onUnlisten(r,!0);case 1:return n.queries.delete(r),n.onUnlisten(r,!1);case 2:return n.onLastRemoteStoreUnlisten(r);default:return}}function Rl(e){e.z_.forEach(e=>{e.next()})}(_r=_r||{}).J_="default",_r.Cache="cache";class Ml{constructor(e,t,n){this.query=e,this.Y_=t,this.Z_=!1,this.X_=null,this.onlineState="Unknown",this.options=n||{}}H_(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new Dl(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Z_?this.ea(e)&&(this.Y_.next(e),t=!0):this.ta(e,this.onlineState)&&(this.na(e),t=!0),this.X_=e,t}onError(e){this.Y_.error(e)}j_(e){this.onlineState=e;let t=!1;return this.X_&&!this.Z_&&this.ta(this.X_,e)&&(this.na(this.X_),t=!0),t}ta(e,t){return!e.fromCache||(!this.G_()||(!this.options.ra||!("Offline"!==t))&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t))}ea(e){if(0<e.docChanges.length)return!0;var t=this.X_&&this.X_.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}na(e){e=Dl.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Z_=!0,this.Y_.next(e)}G_(){return this.options.source!==_r.Cache}}class Ll{constructor(e,t){this.ia=e,this.byteLength=t}sa(){return"metadata"in this.ia}}class Fl{constructor(e){this.serializer=e}hs(e){return du(this.serializer,e)}Ps(e){return e.metadata.exists?vu(this.serializer,e.document,!1):na.newNoDocument(this.hs(e.metadata.name),this.Is(e.metadata.readTime))}Is(e){return ou(e)}}class Ol{constructor(e,t,n){this.oa=e,this.localStore=t,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=Pl(e)}_a(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.ia.namedQuery)this.queries.push(e.ia.namedQuery);else if(e.ia.documentMetadata){this.documents.push({metadata:e.ia.documentMetadata}),e.ia.documentMetadata.exists||++t;const n=ui.fromString(e.ia.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.ia.document&&(this.documents[this.documents.length-1].document=e.ia.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}aa(e){const t=new Map,n=new Fl(this.serializer);for(const i of e)if(i.metadata.queries){const e=n.hs(i.metadata.name);for(const n of i.metadata.queries){var r=(t.get(n)||to()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const i=e;let s=to(),a=Ha;for(const e of n){const n=t.hs(e.metadata.name);e.document&&(s=s.add(n));const c=t.Ps(e);c.setReadTime(t.Is(e.metadata.readTime)),a=a.insert(n,c)}const o=i.ss.newChangeBuffer({trackRemovals:!0}),u=await Eh(i,(r=r,Va(La(ui.fromString(`__bundle__/docs/${r}`)))));return i.persistence.runTransaction("Apply bundle documents","readwrite",t=>Ih(t,o,a).next(e=>(o.apply(t),e)).next(e=>i.qr.removeMatchingKeysForTargetId(t,u.targetId).next(()=>i.qr.addMatchingKeys(t,s,u.targetId)).next(()=>i.localDocuments.getLocalViewOfDocuments(t,e.us,e.cs)).next(()=>e.us)))}(this.localStore,new Fl(this.serializer),this.documents,this.oa.id),t=this.aa(this.documents);for(const e of this.queries)await async function(e,n,r=to()){const i=await Eh(e,Va(Vu(n.bundledQuery))),s=e;return s.persistence.runTransaction("Save named query","readwrite",e=>{var t=ou(n.readTime);if(0<=i.snapshotVersion.compareTo(t))return s.Kr.saveNamedQuery(e,n);t=i.withResumeToken(Ds.EMPTY_BYTE_STRING,t);return s.ts=s.ts.insert(t.targetId,t),s.qr.updateTargetData(e,t).next(()=>s.qr.removeMatchingKeysForTargetId(e,i.targetId)).next(()=>s.qr.addMatchingKeys(e,r,i.targetId)).next(()=>s.Kr.saveNamedQuery(e,n))})}(this.localStore,e,t.get(e.name));return this.progress.taskState="Success",{progress:this.progress,ua:this.collectionGroups,ca:e}}}function Pl(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class Vl{constructor(e){this.key=e}}class Bl{constructor(e){this.key=e}}class ql{constructor(e,t){this.query=e,this.la=t,this.ha=null,this.hasCachedResults=!1,this.current=!1,this.Pa=to(),this.mutatedKeys=to(),this.Ia=$a(e),this.Ta=new Sl(this.Ia)}get Ea(){return this.la}da(e,t){const o=t?t.Aa:new xl,u=(t||this).Ta;let c=(t||this).mutatedKeys,h=u,l=!1;const d="F"===this.query.limitType&&u.size===this.query.limit?u.last():null,f="L"===this.query.limitType&&u.size===this.query.limit?u.first():null;if(e.inorderTraversal((e,t)=>{const n=u.get(e),r=Ga(this.query,t)?t:null,i=!!n&&this.mutatedKeys.has(n.key),s=!!r&&(r.hasLocalMutations||this.mutatedKeys.has(r.key)&&r.hasCommittedMutations);let a=!1;n&&r?n.data.isEqual(r.data)?i!==s&&(o.track({type:3,doc:r}),a=!0):this.Ra(n,r)||(o.track({type:2,doc:r}),a=!0,(d&&0<this.Ia(r,d)||f&&this.Ia(r,f)<0)&&(l=!0)):!n&&r?(o.track({type:0,doc:r}),a=!0):n&&!r&&(o.track({type:1,doc:n}),a=!0,(d||f)&&(l=!0)),a&&(c=r?(h=h.add(r),s?c.add(e):c.delete(e)):(h=h.delete(e),c.delete(e)))}),null!==this.query.limit)for(;h.size>this.query.limit;){const e="F"===this.query.limitType?h.last():h.first();h=h.delete(e.key),c=c.delete(e.key),o.track({type:1,doc:e})}return{Ta:h,Aa:o,Zi:l,mutatedKeys:c}}Ra(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n,r){var i=this.Ta;this.Ta=e.Ta,this.mutatedKeys=e.mutatedKeys;const s=e.Aa.Q_();s.sort((e,t)=>function(e,t){var n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return jr()}};return n(e)-n(t)}(e.type,t.type)||this.Ia(e.doc,t.doc)),this.Va(n),r=null!=r&&r;var a=t&&!r?this.ma():[],o=0===this.Pa.size&&this.current&&!r?1:0,u=o!==this.ha;return this.ha=o,0!==s.length||u?{snapshot:new Dl(this.query,e.Ta,i,s,e.mutatedKeys,0==o,u,!1,!!n&&0<n.resumeToken.approximateByteSize()),fa:a}:{fa:a}}j_(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Ta:this.Ta,Aa:new xl,mutatedKeys:this.mutatedKeys,Zi:!1},!1)):{fa:[]}}ga(e){return!this.la.has(e)&&!!this.Ta.has(e)&&!this.Ta.get(e).hasLocalMutations}Va(e){e&&(e.addedDocuments.forEach(e=>this.la=this.la.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.la=this.la.delete(e)),this.current=e.current)}ma(){if(!this.current)return[];const t=this.Pa;this.Pa=to(),this.Ta.forEach(e=>{this.ga(e.key)&&(this.Pa=this.Pa.add(e.key))});const n=[];return t.forEach(e=>{this.Pa.has(e)||n.push(new Bl(e))}),this.Pa.forEach(e=>{t.has(e)||n.push(new Vl(e))}),n}pa(e){this.la=e.ls,this.Pa=to();var t=this.da(e.documents);return this.applyChanges(t,!0)}ya(){return Dl.fromInitialDocuments(this.query,this.Ta,this.mutatedKeys,0===this.ha,this.hasCachedResults)}}class Ul{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class jl{constructor(e){this.key=e,this.wa=!1}}class zl{constructor(e,t,n,r,i,s){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=i,this.maxConcurrentLimboResolutions=s,this.Sa={},this.ba=new Qa(e=>ja(e),Ua),this.Da=new Map,this.Ca=new Set,this.va=new ws(li.comparator),this.Fa=new Map,this.Ma=new Xc,this.xa={},this.Oa=new Map,this.Na=Cc.Nn(),this.onlineState="Unknown",this.La=void 0}get isPrimaryClient(){return!0===this.La}}async function Gl(e,t,n,r){var i=await Eh(e.localStore,Va(t)),s=i.targetId,a=n?e.sharedClientState.addLocalQueryTarget(s):"not-current";let o;return r&&(o=await Kl(e,t,s,"current"===a,i.resumeToken)),e.isPrimaryClient&&n&&sl(e.remoteStore,i),o}async function Kl(r,e,t,n,i){r.Ba=(e,t,n)=>async function(e,t,n,r){let i=t.view.da(n);i.Zi&&(i=await Sh(e.localStore,t.query,!1).then(({documents:e})=>t.view.da(e,i)));var s=r&&r.targetChanges.get(t.targetId),a=r&&null!=r.targetMismatches.get(t.targetId),a=t.view.applyChanges(i,e.isPrimaryClient,s,a);return ed(e,t.targetId,a.fa),a.snapshot}(r,e,t,n);const s=await Sh(r.localStore,e,!0),a=new ql(e,s.ls),o=a.da(s.documents),u=$o.createSynthesizedTargetChangeForCurrentChange(t,n&&"Offline"!==r.onlineState,i),c=a.applyChanges(o,r.isPrimaryClient,u);ed(r,t,c.fa);var h=new Ul(e,t,a);return r.ba.set(e,h),r.Da.has(t)?r.Da.get(t).push(e):r.Da.set(t,[e]),c.snapshot}async function $l(e,t,n){const r=od(e);try{const e=await function(e,i){const s=e,a=si.now(),o=i.reduce((e,t)=>e.add(t.key),to());let u,c;return s.persistence.runTransaction("Locally write mutations","readwrite",n=>{let t=Ha,r=to();return s.ss.getEntries(n,o).next(e=>{t=e,t.forEach((e,t)=>{t.isValidDocument()||(r=r.add(e))})}).next(()=>s.localDocuments.getOverlayedDocuments(n,t)).next(e=>{u=e;const t=[];for(const n of i){const i=function(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),i=oo(r.transform,e||null);null!=i&&(null===n&&(n=ta.empty()),n.set(r.field,i))}return n||null}(n,u.get(n.key).overlayedDocument);null!=i&&t.push(new Do(n.key,i,function r(e){const i=[];return ys(e.fields,(e,t)=>{const n=new hi([e]);if(Js(t)){const e=r(t.mapValue).fields;if(0===e.length)i.push(n);else for(const t of e)i.push(n.child(t))}else i.push(n)}),new Ss(i)}(i.value.mapValue),wo.exists(!0)))}return s.mutationQueue.addMutationBatch(n,a,t,i)}).next(e=>{var t=(c=e).applyToLocalDocumentSet(u,r);return s.documentOverlayCache.saveOverlays(n,e.batchId,t)})}).then(()=>({batchId:c.batchId,changes:Ya(u)}))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let r=e.xa[e.currentUser.toKey()];r=r||new ws(ni),r=r.insert(t,n),e.xa[e.currentUser.toKey()]=r}(r,e.batchId,n),await nd(r,e.changes),await ml(r.remoteStore)}catch(e){const t=Tl(e,"Failed to persist write");n.reject(t)}}async function Ql(e,t){const r=e;try{const e=await bh(r.localStore,t);t.targetChanges.forEach((e,t)=>{const n=r.Fa.get(t);n&&(zr(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),0<e.addedDocuments.size?n.wa=!0:0<e.modifiedDocuments.size?zr(n.wa):0<e.removedDocuments.size&&(zr(n.wa),n.wa=!1))}),await nd(r,e,t)}catch(e){await Ei(e)}}function Hl(r,i,e){const t=r;if(t.isPrimaryClient&&0===e||!t.isPrimaryClient&&1===e){const r=[];t.ba.forEach((e,t)=>{var n=t.view.j_(i);n.snapshot&&r.push(n.snapshot)}),function(e,n){const t=e;t.onlineState=n;let r=!1;t.queries.forEach((e,t)=>{for(const e of t.U_)e.j_(n)&&(r=!0)}),r&&Rl(t)}(t.eventManager,i),r.length&&t.Sa.l_(r),t.onlineState=i,t.isPrimaryClient&&t.sharedClientState.setOnlineState(i)}}async function Wl(e,t){const n=e,r=t.batch.batchId;try{const e=await function(e,r){const i=e;return i.persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{const t=r.batch.keys(),n=i.ss.newChangeBuffer({trackRemovals:!0});return function(e,t,r,i){const s=r.batch,n=s.keys();let a=Ti.resolve();return n.forEach(n=>{a=a.next(()=>i.getEntry(t,n)).next(e=>{var t=r.docVersions.get(n);zr(null!==t),e.version.compareTo(t)<0&&(s.applyToRemoteDocument(e,r),e.isValidDocument()&&(e.setReadTime(r.commitVersion),i.addEntry(e)))})}),a.next(()=>e.mutationQueue.removeMutationBatch(t,s))}(i,e,r,n).next(()=>n.apply(e)).next(()=>i.mutationQueue.performConsistencyCheck(e)).next(()=>i.documentOverlayCache.removeOverlaysForBatchId(e,t,r.batch.batchId)).next(()=>i.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=to();for(let n=0;n<e.mutationResults.length;++n)0<e.mutationResults[n].transformResults.length&&(t=t.add(e.batch.mutations[n].key));return t}(r))).next(()=>i.localDocuments.getDocuments(e,t))})}(n.localStore,t);Yl(n,r,null),Jl(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await nd(n,e)}catch(e){await Ei(e)}}function Jl(e,t){(e.Oa.get(t)||[]).forEach(e=>{e.resolve()}),e.Oa.delete(t)}function Yl(e,t,n){const r=e;let i=r.xa[r.currentUser.toKey()];if(i){const e=i.get(t);e&&(n?e.reject(n):e.resolve(),i=i.remove(t)),r.xa[r.currentUser.toKey()]=i}}function Xl(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const r of t.Da.get(e))t.ba.delete(r),n&&t.Sa.ka(r,n);t.Da.delete(e),t.isPrimaryClient&&t.Ma.Rr(e).forEach(e=>{t.Ma.containsKey(e)||Zl(t,e)})}function Zl(e,t){e.Ca.delete(t.path.canonicalString());var n=e.va.get(t);null!==n&&(al(e.remoteStore,n),e.va=e.va.remove(t),e.Fa.delete(n),td(e))}function ed(e,t,n){for(const r of n)r instanceof Vl?(e.Ma.addReference(r.key,t),function(e,t){const n=t.key,r=n.path.canonicalString();e.va.get(n)||e.Ca.has(r)||(Vr("SyncEngine","New document in limbo: "+n),e.Ca.add(r),td(e))}(e,r)):r instanceof Bl?(Vr("SyncEngine","Document no longer in limbo: "+r.key),e.Ma.removeReference(r.key,t),e.Ma.containsKey(r.key)||Zl(e,r.key)):jr()}function td(e){for(;0<e.Ca.size&&e.va.size<e.maxConcurrentLimboResolutions;){var t=e.Ca.values().next().value;e.Ca.delete(t);var n=new li(ui.fromString(t)),t=e.Na.next();e.Fa.set(t,new jl(n)),e.va=e.va.insert(n,t),sl(e.remoteStore,new Au(Va(La(n.path)),t,"TargetPurposeLimboResolution",Pi.oe))}}async function nd(e,t,r){const i=e,s=[],a=[],o=[];i.ba.isEmpty()||(i.ba.forEach((e,n)=>{o.push(i.Ba(n,t,r).then(e=>{var t;(e||r)&&i.isPrimaryClient&&i.sharedClientState.updateQueryState(n.targetId,null!=e&&e.fromCache?"not-current":"current"),e&&(s.push(e),t=gh.Qi(n.targetId,e),a.push(t))}))}),await Promise.all(o),i.Sa.l_(s),await async function(e,t){const r=e;try{await r.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>Ti.forEach(t,t=>Ti.forEach(t.ki,e=>r.persistence.referenceDelegate.addReference(n,t.targetId,e)).next(()=>Ti.forEach(t.qi,e=>r.persistence.referenceDelegate.removeReference(n,t.targetId,e)))))}catch(e){if(!Ni(e))throw e;Vr("LocalStore","Failed to update sequence numbers: "+e)}for(const e of t){const t=e.targetId;if(!e.fromCache){const e=r.ts.get(t),n=e.snapshotVersion,i=e.withLastLimboFreeSnapshotVersion(n);r.ts=r.ts.insert(t,i)}}}(i.localStore,a))}async function rd(r,e){const i=r;if(ad(i),od(i),!0===e&&!0!==i.La){const r=i.sharedClientState.getAllActiveQueryTargets(),e=await id(i,r.toArray());i.La=!0,await _l(i.remoteStore,!0);for(const r of e)sl(i.remoteStore,r)}else if(!1===e&&!1!==i.La){const r=[];let n=Promise.resolve();i.Da.forEach((e,t)=>{i.sharedClientState.isLocalQueryTarget(t)?r.push(t):n=n.then(()=>(Xl(i,t),Th(i.localStore,t,!0))),al(i.remoteStore,t)}),await n,await id(i,r),function(e){const n=e;n.Fa.forEach((e,t)=>{al(n.remoteStore,t)}),n.Ma.Vr(),n.Fa=new Map,n.va=new ws(li.comparator)}(i),i.La=!1,await _l(i.remoteStore,!1)}}async function id(t,n){const r=t,i=[],s=[];for(const t of n){let e;const h=r.Da.get(t);if(h&&0!==h.length){e=await Eh(r.localStore,Va(h[0]));for(const t of h){const n=r.ba.get(t),h=(a=r,o=n,c=u=void 0,c=await Sh((u=a).localStore,o.query,!0),c=o.view.pa(c),u.isPrimaryClient&&ed(u,o.targetId,c.fa),await c);h.snapshot&&s.push(h.snapshot)}}else{const h=await xh(r.localStore,t);e=await Eh(r.localStore,h),await Kl(r,sd(h),t,!1,e.resumeToken)}i.push(e)}var a,o,u,c;return r.Sa.l_(s),i}function sd(e){return Ma(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function ad(e){const t=e;return t.remoteStore.remoteSyncer.applyRemoteEvent=Ql.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=(function(e,t){const n=e,r=n.Fa.get(t);if(r&&r.wa)return to().add(r.key);{let e=to();const r=n.Da.get(t);if(!r)return e;for(const t of r){const r=n.ba.get(t);e=e.unionWith(r.view.Ea)}return e}}).bind(null,t),t.remoteStore.remoteSyncer.rejectListen=(async function(e,t,n){const r=e;r.sharedClientState.updateQueryState(t,"rejected",n);const i=r.Fa.get(t),s=i&&i.key;if(s){let e=new ws(li.comparator);e=e.insert(s,na.newNoDocument(s,ai.min()));const n=to().add(s),i=new Ko(ai.min(),new Map,new ws(ni),e,n);await Ql(r,i),r.va=r.va.remove(s),r.Fa.delete(t),td(r)}else await Th(r.localStore,t,!1).then(()=>Xl(r,t,n)).catch(Ei)}).bind(null,t),t.Sa.l_=(function(e,t){const n=e;let r=!1;for(const e of t){const t=e.query,i=n.queries.get(t);if(i){for(const t of i.U_)t.H_(e)&&(r=!0);i.K_=e}}r&&Rl(n)}).bind(null,t.eventManager),t.Sa.ka=(function(e,t,n){const r=e,i=r.queries.get(t);if(i)for(const e of i.U_)e.onError(n);r.queries.delete(t)}).bind(null,t.eventManager),t}function od(e){const t=e;return t.remoteStore.remoteSyncer.applySuccessfulWrite=Wl.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=(async function(e,t,n){const r=e;try{const e=await function(e,r){const i=e;return i.persistence.runTransaction("Reject batch","readwrite-primary",t=>{let n;return i.mutationQueue.lookupMutationBatch(t,r).next(e=>(zr(null!==e),n=e.keys(),i.mutationQueue.removeMutationBatch(t,e))).next(()=>i.mutationQueue.performConsistencyCheck(t)).next(()=>i.documentOverlayCache.removeOverlaysForBatchId(t,n,r)).next(()=>i.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,n)).next(()=>i.localDocuments.getDocuments(t,n))})}(r.localStore,t);Yl(r,t,n),Jl(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await nd(r,e)}catch(n){await Ei(n)}}).bind(null,t),t}class ud{constructor(){this.synchronizeTabs=!1}async initialize(e){this.serializer=Wh(e.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(e),this.persistence=this.createPersistence(e),await this.persistence.start(),this.localStore=this.createLocalStore(e),this.gcScheduler=this.createGarbageCollectionScheduler(e,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(e,this.localStore)}createGarbageCollectionScheduler(e,t){return null}createIndexBackfillerScheduler(e,t){return null}createLocalStore(e){return vh(this.persistence,new ph,e.initialUser,this.serializer)}createPersistence(e){return new ih(ah.jr,this.serializer)}createSharedClientState(e){return new Vh}async terminate(){var e;null===(e=this.gcScheduler)||void 0===e||e.stop(),null===(e=this.indexBackfillerScheduler)||void 0===e||e.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class cd extends ud{constructor(e,t,n){super(),this.Qa=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.Qa.initialize(this,e),await od(this.Qa.syncEngine),await ml(this.Qa.remoteStore),await this.persistence.mi(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}createLocalStore(e){return vh(this.persistence,new ph,e.initialUser,this.serializer)}createGarbageCollectionScheduler(e,t){var n=this.persistence.referenceDelegate.garbageCollector;return new Fc(n,e.asyncQueue,t)}createIndexBackfillerScheduler(e,t){var n=new Oi(t,this.persistence);return new Fi(e.asyncQueue,n)}createPersistence(e){var t=fh(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?_c.withCacheSize(this.cacheSizeBytes):_c.DEFAULT;return new hh(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,Qh(),Hh(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(e){return new Vh}}class hd extends cd{constructor(e,t){super(e,t,!1),this.Qa=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);var t=this.Qa.syncEngine;this.sharedClientState instanceof Ph&&(this.sharedClientState.syncEngine={Ys:(async function(e,t,n,r){var i=e,s=await function(e,n){const r=e,i=r.mutationQueue;return r.persistence.runTransaction("Lookup mutation documents","readonly",t=>i.Cn(t,n).next(e=>e?r.localDocuments.getDocuments(t,e):Ti.resolve(null)))}(i.localStore,t);null!==s?("pending"===n?await ml(i.remoteStore):"acknowledged"===n||"rejected"===n?(Yl(i,t,r||null),Jl(i,t),i.localStore.mutationQueue.Fn(t)):jr(),await nd(i,s)):Vr("SyncEngine","Cannot apply mutation batch with id: "+t)}).bind(null,t),Zs:(async function(e,t,n,r){const i=e;if(i.La)Vr("SyncEngine","Ignoring unexpected query state notification.");else{var s=i.Da.get(t);if(s&&0<s.length)switch(n){case"current":case"not-current":{const e=await Dh(i.localStore,Ka(s[0])),r=Ko.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,Ds.EMPTY_BYTE_STRING);await nd(i,e,r);break}case"rejected":await Th(i.localStore,t,!0),Xl(i,t,r);break;default:jr()}}}).bind(null,t),Xs:(async function(e,t,n){const r=ad(e);if(r.La){for(const e of t)if(r.Da.has(e)&&r.sharedClientState.isActiveQueryTarget(e))Vr("SyncEngine","Adding an already active target "+e);else{const t=await xh(r.localStore,e),n=await Eh(r.localStore,t);await Kl(r,sd(t),n.targetId,!1,n.resumeToken),sl(r.remoteStore,n)}for(const e of n)r.Da.has(e)&&await Th(r.localStore,e,!1).then(()=>{al(r.remoteStore,e),Xl(r,e)}).catch(Ei)}}).bind(null,t),Li:(function(e){return e.localStore.persistence.Li()}).bind(null,t),Js:(async function(e,t){const n=e;return Dh(n.localStore,t).then(e=>nd(n,e))}).bind(null,t)},await this.sharedClientState.start()),await this.persistence.mi(async e=>{await rd(this.Qa.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())})}createSharedClientState(e){var t=Qh();if(!Ph.D(t))throw new Kr(Gr.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");var n=fh(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new Ph(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class ld{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>Hl(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=(async function(e,t){const n=e;if(!n.currentUser.isEqual(t)){Vr("SyncEngine","User change. New user:",t.toKey());const i=await wh(n.localStore,t);n.currentUser=t,e=n,r="'waitForPendingWrites' promise is rejected due to a user change.",e.Oa.forEach(e=>{e.forEach(e=>{e.reject(new Kr(Gr.CANCELLED,r))})}),e.Oa.clear(),n.sharedClientState.handleUserChange(t,i.removedBatchIds,i.addedBatchIds),await nd(n,i._s)}var r}).bind(null,this.syncEngine),await _l(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new Al}createDatastore(e){var t,n,r,i=Wh(e.databaseInfo.databaseId),s=(r=e.databaseInfo,new $h(r));return t=e.authCredentials,n=e.appCheckCredentials,r=s,e=i,new el(t,n,r,e)}createRemoteStore(e){return t=this.localStore,n=this.datastore,r=e.asyncQueue,i=e=>Hl(this.syncEngine,e,0),e=new(qh.D()?qh:Bh),new nl(t,n,r,i,e);var t,n,r,i}createSyncEngine(e,t){return function(e,t,n,r,i,s,a){const o=new zl(e,t,n,r,i,s);return a&&(o.La=!0),o}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}async terminate(){var e;await async function(e){const t=e;Vr("RemoteStore","RemoteStore shutting down."),t.M_.add(5),await il(t),t.O_.shutdown(),t.N_.set("Unknown")}(this.remoteStore),null===(e=this.datastore)||void 0===e||e.terminate()}}function dd(t,n=10240){let r=0;return{async read(){if(r<t.byteLength){var e={value:t.slice(r,r+n),done:!1};return r+=n,e}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}class fd{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Ka(this.observer.next,e)}error(e){this.observer.error?this.Ka(this.observer.error,e):Br("Uncaught Error in snapshot listener:",e.toString())}$a(){this.muted=!0}Ka(e,t){this.muted||setTimeout(()=>{this.muted||e(t)},0)}}class gd{constructor(e,t){this.Ua=e,this.serializer=t,this.metadata=new $r,this.buffer=new Uint8Array,this.Wa=new TextDecoder("utf-8"),this.Ga().then(e=>{e&&e.sa()?this.metadata.resolve(e.ia.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==e?void 0:e.ia)}`))},e=>this.metadata.reject(e))}close(){return this.Ua.cancel()}async getMetadata(){return this.metadata.promise}async qa(){return await this.getMetadata(),this.Ga()}async Ga(){var e=await this.za();if(null===e)return null;var t=this.Wa.decode(e),n=Number(t);isNaN(n)&&this.ja(`length string (${t}) is not valid number`);t=await this.Ha(n);return new Ll(JSON.parse(t),e.length+n)}Ja(){return this.buffer.findIndex(e=>e==="{".charCodeAt(0))}async za(){for(;this.Ja()<0&&!await this.Ya(););if(0===this.buffer.length)return null;var e=this.Ja();e<0&&this.ja("Reached the end of bundle when a length string is expected.");var t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async Ha(e){for(;this.buffer.length<e;)await this.Ya()&&this.ja("Reached the end of bundle when more is expected.");var t=this.Wa.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}ja(e){throw this.Ua.cancel(),new Error(`Invalid bundle format: ${e}`)}async Ya(){var e=await this.Ua.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class md{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),0<this.mutations.length)throw this.lastTransactionError=new Kr(Gr.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;const t=await async function(e,t){const r=e,n={documents:t.map(e=>lu(r.serializer,e))},i=await r.Mo("BatchGetDocuments",r.serializer.databaseId,ui.emptyPath(),n,t.length),s=new Map;i.forEach(e=>{const t=(n=r.serializer,"found"in(e=e)?function(e,t){zr(!!t.found),t.found.name,t.found.updateTime;var n=du(e,t.found.name),r=ou(t.found.updateTime),i=t.found.createTime?ou(t.found.createTime):ai.min(),s=new ta({mapValue:{fields:t.found.fields}});return na.newFoundDocument(n,r,i,s)}(n,e):"missing"in e?function(e,t){zr(!!t.missing),zr(!!t.readTime);var n=du(e,t.missing),r=ou(t.readTime);return na.newNoDocument(n,r)}(n,e):jr());var n;s.set(t.key.toString(),t)});const a=[];return t.forEach(e=>{var t=s.get(e.toString());zr(!!t),a.push(t)}),a}(this.datastore,e);return t.forEach(e=>this.recordVersion(e)),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastTransactionError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new ko(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;const t=this.readVersions;this.mutations.forEach(e=>{t.delete(e.key.toString())}),t.forEach((e,t)=>{var n=li.fromPath(t);this.mutations.push(new Ro(n,this.precondition(n)))}),await async function(e,t){const n=e,r={writes:t.map(e=>wu(n.serializer,e))};await n.Do("Commit",n.serializer.databaseId,ui.emptyPath(),r)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw jr();t=ai.min()}var n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new Kr(Gr.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(ai.min())?wo.exists(!1):wo.updateTime(t):wo.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(this.writtenDocs.has(e.toString())||!t)return wo.exists(!0);if(t.isEqual(ai.min()))throw new Kr(Gr.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return wo.updateTime(t)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class pd{constructor(e,t,n,r,i){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=i,this.Za=n.maxAttempts,this.Jo=new Jh(this.asyncQueue,"transaction_retry")}Xa(){--this.Za,this.eu()}eu(){this.Jo.Ko(async()=>{const t=new md(this.datastore),e=this.tu(t);e&&e.then(e=>{this.asyncQueue.enqueueAndForget(()=>t.commit().then(()=>{this.deferred.resolve(e)}).catch(e=>{this.nu(e)}))}).catch(e=>{this.nu(e)})})}tu(e){try{var t=this.updateFunction(e);return!Vi(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}nu(e){0<this.Za&&this.ru(e)?(--this.Za,this.asyncQueue.enqueueAndForget(()=>(this.eu(),Promise.resolve()))):this.deferred.reject(e)}ru(e){if("FirebaseError"!==e.name)return!1;var t=e.code;return"aborted"===t||"failed-precondition"===t||"already-exists"===t||!Po(t)}}class yd{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=Lr.UNAUTHENTICATED,this.clientId=ti.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,async e=>{Vr("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,e=>(Vr("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new Kr(Gr.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const n=new $r;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),n.resolve()}catch(e){var t=Tl(e,"Failed to shutdown persistence");n.reject(t)}}),n.promise}}async function vd(e,t){e.asyncQueue.verifyOperationInProgress(),Vr("FirestoreClient","Initializing OfflineComponentProvider");var n=e.configuration;await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await wh(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e._offlineComponents=t}async function wd(e,n){e.asyncQueue.verifyOperationInProgress();var t=await bd(e);Vr("FirestoreClient","Initializing OnlineComponentProvider"),await n.initialize(t,e.configuration),e.setCredentialChangeListener(e=>wl(n.remoteStore,e)),e.setAppCheckTokenChangeListener((e,t)=>wl(n.remoteStore,t)),e._onlineComponents=n}function _d(e){return"FirebaseError"===e.name?e.code===Gr.FAILED_PRECONDITION||e.code===Gr.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||22===e.code||20===e.code||11===e.code}async function bd(t){if(!t._offlineComponents)if(t._uninitializedComponentsProvider){Vr("FirestoreClient","Using user provided OfflineComponentProvider");try{await vd(t,t._uninitializedComponentsProvider._offline)}catch(e){var n=e;if(!_d(n))throw n;qr("Error using user provided cache. Falling back to memory cache: "+n),await vd(t,new ud)}}else Vr("FirestoreClient","Using default OfflineComponentProvider"),await vd(t,new ud);return t._offlineComponents}async function Id(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(Vr("FirestoreClient","Using user provided OnlineComponentProvider"),await wd(e,e._uninitializedComponentsProvider._online)):(Vr("FirestoreClient","Using default OnlineComponentProvider"),await wd(e,new ld))),e._onlineComponents}function Ed(e){return bd(e).then(e=>e.persistence)}function Td(e){return bd(e).then(e=>e.localStore)}function Sd(e){return Id(e).then(e=>e.remoteStore)}function xd(e){return Id(e).then(e=>e.syncEngine)}async function Dd(e){const t=await Id(e),n=t.eventManager;return n.onListen=(async function(e,t,n=!0){const r=ad(e);let i;const s=r.ba.get(t);return i=s?(r.sharedClientState.addLocalQueryTarget(s.targetId),s.view.ya()):await Gl(r,t,n,!0),i}).bind(null,t.syncEngine),n.onUnlisten=(async function(e,t,n){const r=e,i=r.ba.get(t),s=r.Da.get(i.targetId);if(1<s.length)return r.Da.set(i.targetId,s.filter(e=>!Ua(e,t))),void r.ba.delete(t);r.isPrimaryClient?(r.sharedClientState.removeLocalQueryTarget(i.targetId),r.sharedClientState.isActiveQueryTarget(i.targetId)||await Th(r.localStore,i.targetId,!1).then(()=>{r.sharedClientState.clearQueryState(i.targetId),n&&al(r.remoteStore,i.targetId),Xl(r,i.targetId)}).catch(Ei)):(Xl(r,i.targetId),await Th(r.localStore,i.targetId,!0))}).bind(null,t.syncEngine),n.onFirstRemoteStoreListen=(async function(e,t){await Gl(ad(e),t,!0,!1)}).bind(null,t.syncEngine),n.onLastRemoteStoreUnlisten=(async function(e,t){const n=e,r=n.ba.get(t),i=n.Da.get(r.targetId);n.isPrimaryClient&&1===i.length&&(n.sharedClientState.removeLocalQueryTarget(r.targetId),al(n.remoteStore,r.targetId))}).bind(null,t.syncEngine),n}function Cd(e,t,n={}){const r=new $r;return e.asyncQueue.enqueueAndForget(async()=>function(n,r,i,s,a){const e=new fd({next:e=>{r.enqueueAndForget(()=>kl(n,o));var t=e.docs.has(i);!t&&e.fromCache?a.reject(new Kr(Gr.UNAVAILABLE,"Failed to get document because the client is offline.")):t&&e.fromCache&&s&&"server"===s.source?a.reject(new Kr(Gr.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):a.resolve(e)},error:e=>a.reject(e)}),o=new Ml(La(i.path),e,{includeMetadataChanges:!0,ra:!0});return Nl(n,o)}(await Dd(e),e.asyncQueue,t,n,r)),r.promise}function Ad(e,t,n={}){const r=new $r;return e.asyncQueue.enqueueAndForget(async()=>function(t,n,e,r,i){const s=new fd({next:e=>{n.enqueueAndForget(()=>kl(t,a)),e.fromCache&&"server"===r.source?i.reject(new Kr(Gr.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):i.resolve(e)},error:e=>i.reject(e)}),a=new Ml(e,s,{includeMetadataChanges:!0,ra:!0});return Nl(t,a)}(await Dd(e),e.asyncQueue,t,n,r)),r.promise}function Nd(e,t,n,r){const i=(n=n,t=Wh(t),s="string"==typeof n?Bo().encode(n):n,n=function(e,t){if(e instanceof Uint8Array)return dd(e,t);if(e instanceof ArrayBuffer)return dd(new Uint8Array(e),t);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(s),t=t,new gd(n,t));var s;e.asyncQueue.enqueueAndForget(async()=>{!function(e,t,n){const r=e;!async function(t,n,r){try{var i=await n.getMetadata();if(await function(e,t){const n=e,r=ou(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",e=>n.Kr.getBundleMetadata(e,t.id)).then(e=>!!e&&0<=e.createTime.compareTo(r))}(t.localStore,i))return await n.close(),r._completeWith({taskState:"Success",documentsLoaded:i.totalDocuments,bytesLoaded:i.totalBytes,totalDocuments:i.totalDocuments,totalBytes:i.totalBytes}),Promise.resolve(new Set);r._updateProgress(Pl(i));const a=new Ol(i,t.localStore,n.serializer);let e=await n.qa();for(;e;){const t=await a._a(e);t&&r._updateProgress(t),e=await n.qa()}var s=await a.complete();return await nd(t,s.ca,void 0),await function(e,t){const n=e;return n.persistence.runTransaction("Save bundle","readwrite",e=>n.Kr.saveBundleMetadata(e,t))}(t.localStore,i),r._completeWith(s.progress),Promise.resolve(s.ua)}catch(t){return qr("SyncEngine",`Loading bundle failed with ${t}`),r._failWith(t),Promise.resolve(new Set)}}(r,t,n).then(e=>{r.sharedClientState.notifyBundleLoaded(e)})}(await xd(e),i,r)})}function kd(e){const t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}const Rd=new Map;function Md(e,t,n){if(!n)throw new Kr(Gr.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function Ld(e,t,n,r){if(!0===t&&!0===r)throw new Kr(Gr.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function Fd(e){if(!li.isDocumentKey(e))throw new Kr(Gr.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function Od(e){if(li.isDocumentKey(e))throw new Kr(Gr.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function Pd(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return 20<e.length&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"!=typeof e)return"function"==typeof e?"a function":jr();if(e instanceof Array)return"an array";var t=(e=e).constructor?e.constructor.name:null;return t?`a custom ${t} object`:"an object"}function Vd(e,t){if((e="_delegate"in e?e._delegate:e)instanceof t)return e;if(t.name===e.constructor.name)throw new Kr(Gr.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");var n=Pd(e);throw new Kr(Gr.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}function Bd(e,t){if(t<=0)throw new Kr(Gr.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}class qd{constructor(e){var t;if(void 0===e.host){if(void 0!==e.ssl)throw new Kr(Gr.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new Kr(Gr.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}Ld("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=kd(null!==(t=e.experimentalLongPollingOptions)&&void 0!==t?t:{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new Kr(Gr.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new Kr(Gr.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(30<e.timeoutSeconds)throw new Kr(Gr.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&(t=this.experimentalLongPollingOptions,n=e.experimentalLongPollingOptions,t.timeoutSeconds===n.timeoutSeconds)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams;var t,n}}class Ud{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new qd({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new Kr(Gr.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new Kr(Gr.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new qd(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new Hr;switch(e.type){case"firstParty":return new Xr(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new Kr(Gr.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=Rd.get(e);t&&(Vr("ComponentProvider","Removing Datastore"),Rd.delete(e),t.terminate())}(this),Promise.resolve()}}function jd(n,e,t,r={}){var i;const s=(n=Vd(n,Ud))._getSettings(),a=`${e}:${t}`;if("firestore.googleapis.com"!==s.host&&s.host!==a&&qr("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),n._setSettings(Object.assign(Object.assign({},s),{host:a,ssl:!1})),r.mockUserToken){let e,t;if("string"==typeof r.mockUserToken)e=r.mockUserToken,t=Lr.MOCK_USER;else{e=function(e,t){if(e.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');var n=t||"demo-project",r=e.iat||0,i=e.sub||e.user_id;if(!i)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");return i=Object.assign({iss:`https://securetoken.google.com/${n}`,aud:n,iat:r,exp:r+3600,auth_time:r,sub:i,user_id:i,firebase:{sign_in_provider:"custom",identities:{}}},e),[o(JSON.stringify({alg:"none",type:"JWT"})),o(JSON.stringify(i)),""].join(".")}(r.mockUserToken,null===(i=n._app)||void 0===i?void 0:i.options.projectId);const s=r.mockUserToken.sub||r.mockUserToken.user_id;if(!s)throw new Kr(Gr.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");t=new Lr(s)}n._authCredentials=new Wr(new Qr(e,t))}}class zd{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new zd(this.firestore,e,this._query)}}class Gd{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Kd(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new Gd(this.firestore,e,this._key)}}class Kd extends zd{constructor(e,t,n){super(e,t,La(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new Gd(this.firestore,null,new li(e))}withConverter(e){return new Kd(this.firestore,e,this._path)}}function $d(e,t,...n){if(e=y(e),Md("collection","path",t),e instanceof Ud){var r=ui.fromString(t,...n);return Od(r),new Kd(e,null,r)}if(!(e instanceof Gd||e instanceof Kd))throw new Kr(Gr.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");r=e._path.child(ui.fromString(t,...n));return Od(r),new Kd(e.firestore,null,r)}function Qd(e,t,...n){if(e=y(e),Md("doc","path",t=1===arguments.length?ti.newId():t),e instanceof Ud){var r=ui.fromString(t,...n);return Fd(r),new Gd(e,null,new li(r))}if(!(e instanceof Gd||e instanceof Kd))throw new Kr(Gr.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");r=e._path.child(ui.fromString(t,...n));return Fd(r),new Gd(e.firestore,e instanceof Kd?e.converter:null,new li(r))}function Hd(e,t){return e=y(e),t=y(t),(e instanceof Gd||e instanceof Kd)&&(t instanceof Gd||t instanceof Kd)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function Wd(e,t){return e=y(e),t=y(t),e instanceof zd&&t instanceof zd&&e.firestore===t.firestore&&Ua(e._query,t._query)&&e.converter===t.converter}class Jd{constructor(){this.iu=Promise.resolve(),this.su=[],this.ou=!1,this._u=[],this.au=null,this.uu=!1,this.cu=!1,this.lu=[],this.Jo=new Jh(this,"async_queue_retry"),this.hu=()=>{var e=Hh();e&&Vr("AsyncQueue","Visibility state changed to "+e.visibilityState),this.Jo.Uo()};const e=Hh();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.hu)}get isShuttingDown(){return this.ou}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.Pu(),this.Iu(e)}enterRestrictedMode(e){if(!this.ou){this.ou=!0,this.cu=e||!1;const t=Hh();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.hu)}}enqueue(e){if(this.Pu(),this.ou)return new Promise(()=>{});const t=new $r;return this.Iu(()=>this.ou&&this.cu?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.su.push(e),this.Tu()))}async Tu(){if(0!==this.su.length){try{await this.su[0](),this.su.shift(),this.Jo.reset()}catch(e){if(!Ni(e))throw e;Vr("AsyncQueue","Operation failed with retryable error: "+e)}0<this.su.length&&this.Jo.Ko(()=>this.Tu())}}Iu(e){var t=this.iu.then(()=>(this.uu=!0,e().catch(e=>{throw this.au=e,this.uu=!1,Br("INTERNAL UNHANDLED ERROR: ",function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e)),e}).then(e=>(this.uu=!1,e))));return this.iu=t}enqueueAfterDelay(e,t,n){this.Pu(),-1<this.lu.indexOf(e)&&(t=0);var r=El.createAndSchedule(this,e,t,n,e=>this.Eu(e));return this._u.push(r),r}Pu(){this.au&&jr()}verifyOperationInProgress(){}async du(){for(var e;await(e=this.iu),e!==this.iu;);}Au(e){for(const t of this._u)if(t.timerId===e)return!0;return!1}Ru(t){return this.du().then(()=>{this._u.sort((e,t)=>e.targetTimeMs-t.targetTimeMs);for(const e of this._u)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.du()})}Vu(e){this.lu.push(e)}Eu(e){var t=this._u.indexOf(e);this._u.splice(t,1)}}function Yd(e){return function(e,t){if("object"==typeof e&&null!==e){var n=e;for(const e of t)if(e in n&&"function"==typeof n[e])return 1}}(e,["next","error","complete"])}class Xd{constructor(){this._progressObserver={},this._taskCompletionResolver=new $r,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}var Zd,ef,tf,nf,rf;class sf extends Ud{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new Jd,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||of(this),this._firestoreClient.terminate()}}function af(e){return e._firestoreClient||of(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function of(e){var t,n,r,i,s,a=e._freezeSettings(),o=(n=e._databaseId,r=(null===(o=e._app)||void 0===o?void 0:o.options.appId)||"",i=e._persistenceKey,s=a,new Fs(n,r,i,s.host,s.ssl,s.experimentalForceLongPolling,s.experimentalAutoDetectLongPolling,kd(s.experimentalLongPollingOptions),s.useFetchStreams));e._firestoreClient=new yd(e._authCredentials,e._appCheckCredentials,e._queue,o),null!==(o=a.localCache)&&void 0!==o&&o._offlineComponentProvider&&null!==(t=a.localCache)&&void 0!==t&&t._onlineComponentProvider&&(e._firestoreClient._uninitializedComponentsProvider={_offlineKind:a.localCache.kind,_offline:a.localCache._offlineComponentProvider,_online:a.localCache._onlineComponentProvider})}function uf(e,t,n){const r=new $r;return e.asyncQueue.enqueue(async()=>{try{await vd(e,n),await wd(e,t),r.resolve()}catch(e){const t=e;if(!_d(t))throw t;qr("Error enabling indexeddb cache. Falling back to memory cache: "+t),r.reject(t)}}).then(()=>r.promise)}function cf(e){return function(e){const t=new $r;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t){const n=e;ll(n.remoteStore)||Vr("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(e){const t=e;return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",e=>t.mutationQueue.getHighestUnacknowledgedBatchId(e))}(n.localStore);if(-1===e)return void t.resolve();const r=n.Oa.get(e)||[];r.push(t),n.Oa.set(e,r)}catch(e){const n=Tl(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await xd(e),t)),t.promise}(af(e=Vd(e,sf)))}function hf(e){return(n=af(e=Vd(e,sf))).asyncQueue.enqueue(async()=>{const e=await Ed(n),t=await Sd(n);return e.setNetworkEnabled(!0),function(e){const t=e;return t.M_.delete(0),rl(t)}(t)});var n}function lf(e){return(n=af(e=Vd(e,sf))).asyncQueue.enqueue(async()=>{const e=await Ed(n),t=await Sd(n);return e.setNetworkEnabled(!1),async function(e){const t=e;t.M_.add(0),await il(t),t.N_.set("Offline")}(t)});var n}function df(t,e){return n=af(t=Vd(t,sf)),r=e,n.asyncQueue.enqueue(async()=>function(e,t){const n=e;return n.persistence.runTransaction("Get named query","readonly",e=>n.Kr.getNamedQuery(e,t))}(await Td(n),r)).then(e=>e?new zd(t,null,e.query):null);var n,r}function ff(e){if(e._initialized||e._terminated)throw new Kr(Gr.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class gf{constructor(e){this._byteString=e}static fromBase64String(e){try{return new gf(Ds.fromBase64String(e))}catch(e){throw new Kr(Gr.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new gf(Ds.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class mf{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new Kr(Gr.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new hi(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class pf{constructor(e){this._methodName=e}}class yf{constructor(e,t){if(!isFinite(e)||e<-90||90<e)throw new Kr(Gr.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||180<t)throw new Kr(Gr.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return ni(this._lat,e._lat)||ni(this._long,e._long)}}const vf=/^__.*__$/;class wf{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new Do(e,this.data,this.fieldMask,t,this.fieldTransforms):new xo(e,this.data,t,this.fieldTransforms)}}class _f{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new Do(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function bf(e){switch(e){case 0:case 2:case 1:return 1;case 3:case 4:return;default:throw jr()}}class If{constructor(e,t,n,r,i,s){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===i&&this.mu(),this.fieldTransforms=i||[],this.fieldMask=s||[]}get path(){return this.settings.path}get fu(){return this.settings.fu}gu(e){return new If(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}pu(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.gu({path:n,yu:!1});return r.wu(e),r}Su(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.gu({path:n,yu:!1});return r.mu(),r}bu(e){return this.gu({path:void 0,yu:!0})}Du(e){return jf(e,this.settings.methodName,this.settings.Cu||!1,this.path,this.settings.vu)}contains(t){return void 0!==this.fieldMask.find(e=>t.isPrefixOf(e))||void 0!==this.fieldTransforms.find(e=>t.isPrefixOf(e.field))}mu(){if(this.path)for(let e=0;e<this.path.length;e++)this.wu(this.path.get(e))}wu(e){if(0===e.length)throw this.Du("Document fields must not be empty");if(bf(this.fu)&&vf.test(e))throw this.Du('Document fields cannot begin and end with "__"')}}class Ef{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||Wh(e)}Fu(e,t,n,r=!1){return new If({fu:e,methodName:t,vu:n,path:hi.emptyPath(),yu:!1,Cu:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function Tf(e){var t=e._freezeSettings(),n=Wh(e._databaseId);return new Ef(e._databaseId,!!t.ignoreUndefinedProperties,n)}function Sf(e,t,n,r,i,s={}){const a=e.Fu(s.merge||s.mergeFields?2:0,t,n,i);Vf("Data must be an object, but it was:",a,r);var o=Of(r,a);let u,c;if(s.merge)u=new Ss(a.fieldMask),c=a.fieldTransforms;else if(s.mergeFields){const e=[];for(const r of s.mergeFields){const i=Bf(t,r,n);if(!a.contains(i))throw new Kr(Gr.INVALID_ARGUMENT,`Field '${i}' is specified in your field mask but missing from your input data.`);zf(e,i)||e.push(i)}u=new Ss(e),c=a.fieldTransforms.filter(e=>u.covers(e.field))}else u=null,c=a.fieldTransforms;return new wf(new ta(o),u,c)}class xf extends pf{_toFieldTransform(e){if(2!==e.fu)throw 1===e.fu?e.Du(`${this._methodName}() can only appear at the top level of your update data`):e.Du(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof xf}}function Df(e,t,n){return new If({fu:3,vu:t.settings.vu,methodName:e._methodName,yu:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class Cf extends pf{_toFieldTransform(e){return new yo(e.path,new uo)}isEqual(e){return e instanceof Cf}}class Af extends pf{constructor(e,t){super(e),this.Mu=t}_toFieldTransform(e){const t=Df(this,e,!0),n=this.Mu.map(e=>Ff(e,t)),r=new co(n);return new yo(e.path,r)}isEqual(e){return e instanceof Af&&m(this.Mu,e.Mu)}}class Nf extends pf{constructor(e,t){super(e),this.Mu=t}_toFieldTransform(e){const t=Df(this,e,!0),n=this.Mu.map(e=>Ff(e,t)),r=new lo(n);return new yo(e.path,r)}isEqual(e){return e instanceof Nf&&m(this.Mu,e.Mu)}}class kf extends pf{constructor(e,t){super(e),this.xu=t}_toFieldTransform(e){var t=new go(e.serializer,so(e.serializer,this.xu));return new yo(e.path,t)}isEqual(e){return e instanceof kf&&this.xu===e.xu}}function Rf(e,i,s,t){const a=e.Fu(1,i,s);Vf("Data must be an object, but it was:",a,t);const o=[],u=ta.empty();ys(t,(e,t)=>{var n=Uf(i,e,s);t=y(t);var r=a.Su(n);if(t instanceof xf)o.push(n);else{const e=Ff(t,r);null!=e&&(o.push(n),u.set(n,e))}});var n=new Ss(o);return new _f(u,n,a.fieldTransforms)}function Mf(e,t,n,r,i,s){const a=e.Fu(1,t,n),o=[Bf(t,r,n)],u=[i];if(s.length%2!=0)throw new Kr(Gr.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let f=0;f<s.length;f+=2)o.push(Bf(t,s[f])),u.push(s[f+1]);const c=[],h=ta.empty();for(let g=o.length-1;0<=g;--g)if(!zf(c,o[g])){const t=o[g];var l=y(l=u[g]);const r=a.Su(t);if(l instanceof xf)c.push(t);else{const e=Ff(l,r);null!=e&&(c.push(t),h.set(t,e))}}var d=new Ss(c);return new _f(h,d,a.fieldTransforms)}function Lf(e,t,n,r=!1){return Ff(n,e.Fu(r?4:3,t))}function Ff(e,t){if(Pf(e=y(e)))return Vf("Unsupported field value:",t,e),Of(e,t);if(e instanceof pf)return function(e,t){if(!bf(t.fu))throw t.Du(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.Du(`${e._methodName}() is not currently supported inside arrays`);var n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.yu&&4!==t.fu)throw t.Du("Nested arrays are not supported");return function(e,t){const n=[];let r=0;for(const i of e){let e=Ff(i,t.bu(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=y(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return so(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){var n=si.fromDate(e);return{timestampValue:su(t.serializer,n)}}if(e instanceof si){n=new si(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:su(t.serializer,n)}}if(e instanceof yf)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof gf)return{bytesValue:au(t.serializer,e._byteString)};if(e instanceof Gd){const r=t.databaseId,i=e.firestore._databaseId;if(!i.isEqual(r))throw t.Du(`Document reference is for database ${i.projectId}/${i.database} but should be for database ${r.projectId}/${r.database}`);return{referenceValue:uu(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t.Du(`Unsupported field value: ${Pd(e)}`)}(e,t)}function Of(e,r){const i={};return vs(e)?r.path&&0<r.path.length&&r.fieldMask.push(r.path):ys(e,(e,t)=>{var n=Ff(t,r.pu(e));null!=n&&(i[e]=n)}),{mapValue:{fields:i}}}function Pf(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof si||e instanceof yf||e instanceof gf||e instanceof Gd||e instanceof pf)}function Vf(e,t,n){if(!Pf(n)||("object"!=typeof(i=n)||null===i||Object.getPrototypeOf(i)!==Object.prototype&&null!==Object.getPrototypeOf(i))){var r=Pd(n);throw"an object"===r?t.Du(e+" a custom object"):t.Du(e+" "+r)}var i}function Bf(e,t,n){if((t=y(t))instanceof mf)return t._internalPath;if("string"==typeof t)return Uf(e,t);throw jf("Field path arguments must be of type string or ",e,!1,void 0,n)}const qf=new RegExp("[~\\*/\\[\\]]");function Uf(t,n,r){if(0<=n.search(qf))throw jf(`Invalid field path (${n}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,r);try{return new mf(...n.split("."))._internalPath}catch(e){throw jf(`Invalid field path (${n}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,r)}}function jf(e,t,n,r,i){var s=r&&!r.isEmpty(),a=void 0!==i;let o=`Function ${t}() called with invalid data`;n&&(o+=" (via `toFirestore()`)"),o+=". ";let u="";return(s||a)&&(u+=" (found",s&&(u+=` in field ${r}`),a&&(u+=` in document ${i}`),u+=")"),new Kr(Gr.INVALID_ARGUMENT,o+e+u)}function zf(e,t){return e.some(e=>e.isEqual(t))}class Gf{constructor(e,t,n,r,i){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=i}get id(){return this._key.path.lastSegment()}get ref(){return new Gd(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){var e=new Kf(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){var t=this._document.data.field($f("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class Kf extends Gf{data(){return super.data()}}function $f(e,t){return"string"==typeof t?Uf(e,t):(t instanceof mf?t:t._delegate)._internalPath}function Qf(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new Kr(Gr.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Hf{}class Wf extends Hf{}function Jf(e,t,...n){let r=[];t instanceof Hf&&r.push(t),r=r.concat(n),function(e){var t=e.filter(e=>e instanceof Xf).length,n=e.filter(e=>e instanceof Yf).length;if(1<t||0<t&&0<n)throw new Kr(Gr.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(const t of r)e=t._apply(e);return e}class Yf extends Wf{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new Yf(e,t,n)}_apply(e){var t=this._parse(e);return ag(e._query,t),new zd(e.firestore,e.converter,Ba(e._query,t))}_parse(e){var t=Tf(e.firestore);return function(e,t,n,r,i,s,a){let o;if(i.isKeyField()){if("array-contains"===s||"array-contains-any"===s)throw new Kr(Gr.INVALID_ARGUMENT,`Invalid Query. You can't perform '${s}' queries on documentId().`);if("in"===s||"not-in"===s){sg(a,s);const t=[];for(const n of a)t.push(ig(r,e,n));o={arrayValue:{values:t}}}else o=ig(r,e,a)}else"in"!==s&&"not-in"!==s&&"array-contains-any"!==s||sg(a,s),o=Lf(n,t,a,"in"===s||"not-in"===s);return ua.create(i,s,o)}(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value)}}class Xf extends Hf{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new Xf(e,t)}_parse(t){var e=this._queryConstraints.map(e=>e._parse(t)).filter(e=>0<e.getFilters().length);return 1===e.length?e[0]:ca.create(e,this._getOperator())}_apply(e){const t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){let n=e;for(const e of t.getFlattenedFilters())ag(n,e),n=Ba(n,e)}(e._query,t),new zd(e.firestore,e.converter,Ba(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class Zf extends Wf{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new Zf(e,t)}_apply(e){var t=function(e,t,n){if(null!==e.startAt)throw new Kr(Gr.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new Kr(Gr.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new aa(t,n)}(e._query,this._field,this._direction);return new zd(e.firestore,e.converter,(e=e._query,t=e.explicitOrderBy.concat([t]),new Ra(e.path,e.collectionGroup,t,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)))}}class eg extends Wf{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new eg(e,t,n)}_apply(e){return new zd(e.firestore,e.converter,qa(e._query,this._limit,this._limitType))}}class tg extends Wf{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new tg(e,t,n)}_apply(e){var t,n=rg(e,this.type,this._docOrFields,this._inclusive);return new zd(e.firestore,e.converter,(t=e._query,e=n,new Ra(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)))}}class ng extends Wf{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new ng(e,t,n)}_apply(e){var t,n=rg(e,this.type,this._docOrFields,this._inclusive);return new zd(e.firestore,e.converter,(t=e._query,e=n,new Ra(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)))}}function rg(e,t,n,r){if(n[0]=y(n[0]),n[0]instanceof Gf)return function(e,t,n,r,i){if(!r)throw new Kr(Gr.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const s=[];for(const n of Pa(e))if(n.field.isKeyField())s.push(Ks(t,r.key));else{const e=r.data.field(n.field);if(Rs(e))throw new Kr(Gr.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){const e=n.field.canonicalString();throw new Kr(Gr.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}s.push(e)}return new ra(s,i)}(e._query,e.firestore._databaseId,t,n[0]._document,r);var i=Tf(e.firestore);return function(e,t,n,r,i,s){const a=e.explicitOrderBy;if(i.length>a.length)throw new Kr(Gr.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const o=[];for(let u=0;u<i.length;u++){const c=i[u];if(a[u].field.isKeyField()){if("string"!=typeof c)throw new Kr(Gr.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof c}`);if(!Oa(e)&&-1!==c.indexOf("/"))throw new Kr(Gr.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${c}' contains a slash.`);const n=e.path.child(ui.fromString(c));if(!li.isDocumentKey(n))throw new Kr(Gr.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const i=new li(n);o.push(Ks(t,i))}else{const e=Lf(n,r,c);o.push(e)}}return new ra(o,s)}(e._query,e.firestore._databaseId,i,t,n,r)}function ig(e,t,n){if("string"==typeof(n=y(n))){if(""===n)throw new Kr(Gr.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Oa(t)&&-1!==n.indexOf("/"))throw new Kr(Gr.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);var r=t.path.child(ui.fromString(n));if(!li.isDocumentKey(r))throw new Kr(Gr.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return Ks(e,new li(r))}if(n instanceof Gd)return Ks(e,n._key);throw new Kr(Gr.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Pd(n)}.`)}function sg(e,t){if(!Array.isArray(e)||0===e.length)throw new Kr(Gr.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function ag(e,t){const n=function(e,t){for(const n of e)for(const e of n.getFlattenedFilters())if(0<=t.indexOf(e.op))return e.op;return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new Kr(Gr.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new Kr(Gr.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}class og{convertValue(e,t="none"){switch(Bs(e)){case 0:return null;case 1:return e.booleanValue;case 2:return Ns(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(ks(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw jr()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,n="none"){const r={};return ys(e,(e,t)=>{r[e]=this.convertValue(t,n)}),r}convertGeoPoint(e){return new yf(Ns(e.latitude),Ns(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":var n=Ms(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(Ls(e));default:return null}}convertTimestamp(e){var t=As(e);return new si(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=ui.fromString(e);zr(Cu(n));const r=new Os(n.get(1),n.get(3)),i=new li(n.popFirst(5));return r.isEqual(t)||Br(`Document ${i} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),i}}function ug(e,t,n){return e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t}class cg extends og{constructor(e){super(),this.firestore=e}convertBytes(e){return new gf(e)}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return new Gd(this.firestore,null,t)}}class hg{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class lg extends Gf{constructor(e,t,n,r,i,s){super(e,t,n,r,s),this._firestore=e,this._firestoreImpl=e,this.metadata=i}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){var t=new dg(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){var n=this._document.data.field($f("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class dg extends lg{data(e={}){return super.data(e)}}class fg{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new hg(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const t=[];return this.forEach(e=>t.push(e)),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,n){this._snapshot.docs.forEach(e=>{t.call(n,new dg(this._firestore,this._userDataWriter,e.key,e,new hg(this._snapshot.mutatedKeys.has(e.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){var t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new Kr(Gr.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(s,t){if(s._snapshot.oldDocs.isEmpty()){let n=0;return s._snapshot.docChanges.map(e=>{var t=new dg(s._firestore,s._userDataWriter,e.doc.key,e.doc,new hg(s._snapshot.mutatedKeys.has(e.doc.key),s._snapshot.fromCache),s.query.converter);return e.doc,{type:"added",doc:t,oldIndex:-1,newIndex:n++}})}{let i=s._snapshot.oldDocs;return s._snapshot.docChanges.filter(e=>t||3!==e.type).map(e=>{var t=new dg(s._firestore,s._userDataWriter,e.doc.key,e.doc,new hg(s._snapshot.mutatedKeys.has(e.doc.key),s._snapshot.fromCache),s.query.converter);let n=-1,r=-1;return 0!==e.type&&(n=i.indexOf(e.doc.key),i=i.delete(e.doc.key)),1!==e.type&&(i=i.add(e.doc),r=i.indexOf(e.doc.key)),{type:function(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return jr()}}(e.type),doc:t,oldIndex:n,newIndex:r}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function gg(e,t){return e instanceof lg&&t instanceof lg?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof fg&&t instanceof fg&&e._firestore===t._firestore&&Wd(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}class mg extends og{constructor(e){super(),this.firestore=e}convertBytes(e){return new gf(e)}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return new Gd(this.firestore,null,t)}}function pg(t){t=Vd(t,Gd);const n=Vd(t.firestore,sf),e=af(n),r=new mg(n);return function(e,t){const n=new $r;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const i=await function(e,t){const n=e;return n.persistence.runTransaction("read document","readonly",e=>n.localDocuments.getDocument(e,t))}(e,t);i.isFoundDocument()?n.resolve(i):i.isNoDocument()?n.resolve(null):n.reject(new Kr(Gr.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){var r=Tl(e,`Failed to get document '${t} from cache`);n.reject(r)}}(await Td(e),t,n)),n.promise}(e,t._key).then(e=>new lg(n,r,t._key,e,new hg(null!==e&&e.hasLocalMutations,!0),t.converter))}function yg(t){t=Vd(t,zd);const n=Vd(t.firestore,sf),e=af(n),r=new mg(n);return function(e,t){const n=new $r;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const i=await Sh(e,t,!0),s=new ql(t,i.ls),a=s.da(i.documents),o=s.applyChanges(a,!1);n.resolve(o.snapshot)}catch(e){var r=Tl(e,`Failed to execute query '${t} against cache`);n.reject(r)}}(await Td(e),t,n)),n.promise}(e,t._query).then(e=>new fg(n,r,t,e))}function vg(e,t,n){e=Vd(e,Gd);var r=Vd(e.firestore,sf),i=ug(e.converter,t,n);return Ig(r,[Sf(Tf(r),"setDoc",e._key,i,null!==e.converter,n).toMutation(e._key,wo.none())])}function wg(e,t,n,...r){e=Vd(e,Gd);var i=Vd(e.firestore,sf),s=Tf(i);let a;return a="string"==typeof(t=y(t))||t instanceof mf?Mf(s,"updateDoc",e._key,t,n,r):Rf(s,"updateDoc",e._key,t),Ig(i,[a.toMutation(e._key,wo.exists(!0))])}function _g(t,...n){var e;t=y(t);let r={includeMetadataChanges:!1,source:"default"},i=0;"object"!=typeof n[i]||Yd(n[i])||(r=n[i],i++);var s={includeMetadataChanges:r.includeMetadataChanges,source:r.source};if(Yd(n[i])){const t=n[i];n[i]=null===(e=t.next)||void 0===e?void 0:e.bind(t),n[i+1]=null===(e=t.error)||void 0===e?void 0:e.bind(t),n[i+2]=null===(e=t.complete)||void 0===e?void 0:e.bind(t)}let a,o,u;if(t instanceof Gd)o=Vd(t.firestore,sf),u=La(t._key.path),a={next:e=>{n[i]&&n[i](Eg(o,t,e))},error:n[i+1],complete:n[i+2]};else{const c=Vd(t,zd);o=Vd(c.firestore,sf),u=c._query;const h=new mg(o);a={next:e=>{n[i]&&n[i](new fg(o,h,c,e))},error:n[i+1],complete:n[i+2]},Qf(t._query)}return function(e,t,n,r){const i=new fd(r),s=new Ml(t,i,n);return e.asyncQueue.enqueueAndForget(async()=>Nl(await Dd(e),s)),()=>{i.$a(),e.asyncQueue.enqueueAndForget(async()=>kl(await Dd(e),s))}}(af(o),u,s,a)}function bg(e,t){return function(e,t){const n=new fd(t);return e.asyncQueue.enqueueAndForget(async()=>function(e,t){e.z_.add(t),t.next()}(await Dd(e),n)),()=>{n.$a(),e.asyncQueue.enqueueAndForget(async()=>function(e,t){e.z_.delete(t)}(await Dd(e),n))}}(af(e=Vd(e,sf)),Yd(t)?t:{next:t})}function Ig(e,t){return function(e,t){const n=new $r;return e.asyncQueue.enqueueAndForget(async()=>$l(await xd(e),t,n)),n.promise}(af(e),t)}function Eg(e,t,n){var r=n.docs.get(t._key),i=new mg(e);return new lg(e,i,t._key,r,new hg(n.hasPendingWrites,n.fromCache),t.converter)}const Tg={maxAttempts:5};class Sg{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=Tf(e)}set(e,t,n){this._verifyNotCommitted();const r=xg(e,this._firestore),i=ug(r.converter,t,n),s=Sf(this._dataReader,"WriteBatch.set",r._key,i,null!==r.converter,n);return this._mutations.push(s.toMutation(r._key,wo.none())),this}update(e,t,n,...r){this._verifyNotCommitted();var i=xg(e,this._firestore);let s;return s="string"==typeof(t=y(t))||t instanceof mf?Mf(this._dataReader,"WriteBatch.update",i._key,t,n,r):Rf(this._dataReader,"WriteBatch.update",i._key,t),this._mutations.push(s.toMutation(i._key,wo.exists(!0))),this}delete(e){this._verifyNotCommitted();var t=xg(e,this._firestore);return this._mutations=this._mutations.concat(new ko(t._key,wo.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,0<this._mutations.length?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new Kr(Gr.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function xg(e,t){if((e=y(e)).firestore!==t)throw new Kr(Gr.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class Dg extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=Tf(e)}get(e){const n=xg(e,this._firestore),r=new cg(this._firestore);return this._transaction.lookup([n._key]).then(e=>{if(!e||1!==e.length)return jr();const t=e[0];if(t.isFoundDocument())return new Gf(this._firestore,r,t.key,t,n.converter);if(t.isNoDocument())return new Gf(this._firestore,r,n._key,null,n.converter);throw jr()})}set(e,t,n){var r=xg(e,this._firestore),i=ug(r.converter,t,n),i=Sf(this._dataReader,"Transaction.set",r._key,i,null!==r.converter,n);return this._transaction.set(r._key,i),this}update(e,t,n,...r){var i=xg(e,this._firestore),s="string"==typeof(t=y(t))||t instanceof mf?Mf(this._dataReader,"Transaction.update",i._key,t,n,r):Rf(this._dataReader,"Transaction.update",i._key,t);return this._transaction.update(i._key,s),this}delete(e){var t=xg(e,this._firestore);return this._transaction.delete(t._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=xg(e,this._firestore),n=new mg(this._firestore);return super.get(e).then(e=>new lg(this._firestore,n,t._key,e._document,new hg(!1,!1),t.converter))}}function Cg(t,n,e){t=Vd(t,sf);var r=Object.assign(Object.assign({},Tg),e);return function(e){if(e.maxAttempts<1)throw new Kr(Gr.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(t,n,r){const i=new $r;return t.asyncQueue.enqueueAndForget(async()=>{var e=await Id(t).then(e=>e.datastore);new pd(t.asyncQueue,e,r,n,i).Xa()}),i.promise}(af(t),e=>n(new Dg(t,e)),r)}ef=!0,tf=tm.SDK_VERSION,Fr=tf,tm._registerComponent(new v("firestore",(e,{instanceIdentifier:t,options:n})=>{const r=e.getProvider("app").getImmediate(),i=new sf(new Jr(e.getProvider("auth-internal")),new ei(e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new Kr(Gr.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Os(e.options.projectId,t)}(r,t),r);return n=Object.assign({useFetchStreams:ef},n),i._setSettings(n),i},"PUBLIC").setMultipleInstances(!0)),tm.registerVersion(Mr,"4.6.1",Zd),tm.registerVersion(Mr,"4.6.1","esm2017");function Ag(e,t){if(void 0===t)return{merge:!1};if(void 0!==t.mergeFields&&void 0!==t.merge)throw new Kr("invalid-argument",`Invalid options passed to function ${e}(): You cannot `+'specify both "merge" and "mergeFields".');return t}function Ng(){if("undefined"==typeof Uint8Array)throw new Kr("unimplemented","Uint8Arrays are not available in this environment.")}function kg(){if("undefined"==typeof atob)throw new Kr("unimplemented","Blobs are unavailable in Firestore in this environment.")}class Rg{constructor(e){this._delegate=e}static fromBase64String(e){return kg(),new Rg(gf.fromBase64String(e))}static fromUint8Array(e){return Ng(),new Rg(gf.fromUint8Array(e))}toBase64(){return kg(),this._delegate.toBase64()}toUint8Array(){return Ng(),this._delegate.toUint8Array()}isEqual(e){return this._delegate.isEqual(e._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}}function Mg(e){return function(e,t){if("object"!=typeof e||null===e)return;var n=e;for(const r of t)if(r in n&&"function"==typeof n[r])return 1;return}(e,["next","error","complete"])}class Lg{enableIndexedDbPersistence(e,t){return function(e,t){ff(e=Vd(e,sf));var n=af(e);if(n._uninitializedComponentsProvider)throw new Kr(Gr.FAILED_PRECONDITION,"SDK cache is already specified.");qr("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");var r=e._freezeSettings(),i=new ld;return uf(n,i,new cd(i,r.cacheSizeBytes,null==t?void 0:t.forceOwnership))}(e._delegate,{forceOwnership:t})}enableMultiTabIndexedDbPersistence(e){return function(e){ff(e=Vd(e,sf));var t=af(e);if(t._uninitializedComponentsProvider)throw new Kr(Gr.FAILED_PRECONDITION,"SDK cache is already specified.");qr("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");var n=e._freezeSettings(),r=new ld;return uf(t,r,new hd(r,n.cacheSizeBytes))}(e._delegate)}clearIndexedDbPersistence(e){return function(e){if(e._initialized&&!e._terminated)throw new Kr(Gr.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const t=new $r;return e._queue.enqueueAndForgetEvenWhileRestricted(async()=>{try{await async function(e){if(!xi.D())return Promise.resolve();var t=e+"main";await xi.delete(t)}(fh(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}}),t.promise}(e._delegate)}}class Fg{constructor(e,t,n){this._delegate=t,this._persistenceProvider=n,this.INTERNAL={delete:()=>this.terminate()},e instanceof Os||(this._appCompat=e)}get _databaseId(){return this._delegate._databaseId}settings(e){var t=this._delegate._getSettings();e.merge||t.host===e.host||qr("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),e.merge&&delete(e=Object.assign(Object.assign({},t),e)).merge,this._delegate._setSettings(e)}useEmulator(e,t,n={}){jd(this._delegate,e,t,n)}enableNetwork(){return hf(this._delegate)}disableNetwork(){return lf(this._delegate)}enablePersistence(e){let t=!1,n=!1;return e&&(t=!!e.synchronizeTabs,n=!!e.experimentalForceOwningTab,Ld("synchronizeTabs",t,"experimentalForceOwningTab",n)),t?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,n)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return cf(this._delegate)}onSnapshotsInSync(e){return bg(this._delegate,e)}get app(){if(!this._appCompat)throw new Kr("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(e){try{return new Wg(this,$d(this._delegate,e))}catch(e){throw Ug(e,"collection()","Firestore.collection()")}}doc(e){try{return new qg(this,Qd(this._delegate,e))}catch(e){throw Ug(e,"doc()","Firestore.doc()")}}collectionGroup(e){try{return new $g(this,function(e,t){if(e=Vd(e,Ud),Md("collectionGroup","collection id",t),0<=t.indexOf("/"))throw new Kr(Gr.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new zd(e,null,(t=t,new Ra(ui.emptyPath(),t)))}(this._delegate,e))}catch(e){throw Ug(e,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(t){return Cg(this._delegate,e=>t(new Pg(this,e)))}batch(){return af(this._delegate),new Vg(new Sg(this._delegate,e=>Ig(this._delegate,e)))}loadBundle(e){return t=this._delegate,e=e,n=af(t=Vd(t,sf)),r=new Xd,Nd(n,t._databaseId,e,r),r;var t,n,r}namedQuery(e){return df(this._delegate,e).then(e=>e?new $g(this,e):null)}}class Og extends og{constructor(e){super(),this.firestore=e}convertBytes(e){return new Rg(new gf(e))}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return qg.forKey(t,this.firestore,null)}}class Pg{constructor(e,t){this._firestore=e,this._delegate=t,this._userDataWriter=new Og(e)}get(e){const t=Jg(e);return this._delegate.get(t).then(e=>new Gg(this._firestore,new lg(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,t.converter)))}set(e,t,n){var r=Jg(e);return n?(Ag("Transaction.set",n),this._delegate.set(r,t,n)):this._delegate.set(r,t),this}update(e,t,n,...r){var i=Jg(e);return 2===arguments.length?this._delegate.update(i,t):this._delegate.update(i,t,n,...r),this}delete(e){var t=Jg(e);return this._delegate.delete(t),this}}class Vg{constructor(e){this._delegate=e}set(e,t,n){var r=Jg(e);return n?(Ag("WriteBatch.set",n),this._delegate.set(r,t,n)):this._delegate.set(r,t),this}update(e,t,n,...r){var i=Jg(e);return 2===arguments.length?this._delegate.update(i,t):this._delegate.update(i,t,n,...r),this}delete(e){var t=Jg(e);return this._delegate.delete(t),this}commit(){return this._delegate.commit()}}class Bg{constructor(e,t,n){this._firestore=e,this._userDataWriter=t,this._delegate=n}fromFirestore(e,t){var n=new dg(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,null);return this._delegate.fromFirestore(new Kg(this._firestore,n),null!=t?t:{})}toFirestore(e,t){return t?this._delegate.toFirestore(e,t):this._delegate.toFirestore(e)}static getInstance(e,t){const n=Bg.INSTANCES;let r=n.get(e);r||(r=new WeakMap,n.set(e,r));let i=r.get(t);return i||(i=new Bg(e,new Og(e),t),r.set(t,i)),i}}Bg.INSTANCES=new WeakMap;class qg{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Og(e)}static forPath(e,t,n){if(e.length%2!=0)throw new Kr("invalid-argument","Invalid document reference. Document references must have an even number of segments, but "+`${e.canonicalString()} has ${e.length}`);return new qg(t,new Gd(t._delegate,n,new li(e)))}static forKey(e,t,n){return new qg(t,new Gd(t._delegate,n,e))}get id(){return this._delegate.id}get parent(){return new Wg(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(e){try{return new Wg(this.firestore,$d(this._delegate,e))}catch(e){throw Ug(e,"collection()","DocumentReference.collection()")}}isEqual(e){return(e=y(e))instanceof Gd&&Hd(this._delegate,e)}set(e,t){t=Ag("DocumentReference.set",t);try{return t?vg(this._delegate,e,t):vg(this._delegate,e)}catch(e){throw Ug(e,"setDoc()","DocumentReference.set()")}}update(e,t,...n){try{return 1===arguments.length?wg(this._delegate,e):wg(this._delegate,e,t,...n)}catch(e){throw Ug(e,"updateDoc()","DocumentReference.update()")}}delete(){return Ig(Vd((e=this._delegate).firestore,sf),[new ko(e._key,wo.none())]);var e}onSnapshot(...e){var t=jg(e),n=zg(e,e=>new Gg(this.firestore,new lg(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)));return _g(this._delegate,t,n)}get(e){let t;return t=("cache"===(null==e?void 0:e.source)?pg:"server"===(null==e?void 0:e.source)?function(t){t=Vd(t,Gd);const n=Vd(t.firestore,sf);return Cd(af(n),t._key,{source:"server"}).then(e=>Eg(n,t,e))}:function(t){t=Vd(t,Gd);const n=Vd(t.firestore,sf);return Cd(af(n),t._key).then(e=>Eg(n,t,e))})(this._delegate),t.then(e=>new Gg(this.firestore,new lg(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)))}withConverter(e){return new qg(this.firestore,e?this._delegate.withConverter(Bg.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function Ug(e,t,n){return e.message=e.message.replace(t,n),e}function jg(e){for(const t of e)if("object"==typeof t&&!Mg(t))return t;return{}}function zg(e,t){var n;let r;return r=Mg(e[0])?e[0]:Mg(e[1])?e[1]:"function"==typeof e[0]?{next:e[0],error:e[1],complete:e[2]}:{next:e[1],error:e[2],complete:e[3]},{next:e=>{r.next&&r.next(t(e))},error:null===(n=r.error)||void 0===n?void 0:n.bind(r),complete:null===(n=r.complete)||void 0===n?void 0:n.bind(r)}}class Gg{constructor(e,t){this._firestore=e,this._delegate=t}get ref(){return new qg(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(e){return this._delegate.data(e)}get(e,t){return this._delegate.get(e,t)}isEqual(e){return gg(this._delegate,e._delegate)}}class Kg extends Gg{data(e){var t=this._delegate.data(e);return this._delegate._converter||void 0!==t||jr(),t}}class $g{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Og(e)}where(e,t,n){try{return new $g(this.firestore,Jf(this._delegate,(r=n,i=t,s=$f("where",e),Yf._create(s,i,r))))}catch(e){throw Ug(e,/(orderBy|where)\(\)/,"Query.$1()")}var r,i,s}orderBy(e,t){try{return new $g(this.firestore,Jf(this._delegate,([n,r="asc"]=[e,t],i=r,s=$f("orderBy",n),Zf._create(s,i))))}catch(e){throw Ug(e,/(orderBy|where)\(\)/,"Query.$1()")}var n,r,i,s}limit(e){try{return new $g(this.firestore,Jf(this._delegate,(Bd("limit",t=e),eg._create("limit",t,"F"))))}catch(e){throw Ug(e,"limit()","Query.limit()")}var t}limitToLast(e){try{return new $g(this.firestore,Jf(this._delegate,(Bd("limitToLast",t=e),eg._create("limitToLast",t,"L"))))}catch(e){throw Ug(e,"limitToLast()","Query.limitToLast()")}var t}startAt(...e){try{return new $g(this.firestore,Jf(this._delegate,function(...e){return tg._create("startAt",e,!0)}(...e)))}catch(e){throw Ug(e,"startAt()","Query.startAt()")}}startAfter(...e){try{return new $g(this.firestore,Jf(this._delegate,function(...e){return tg._create("startAfter",e,!1)}(...e)))}catch(e){throw Ug(e,"startAfter()","Query.startAfter()")}}endBefore(...e){try{return new $g(this.firestore,Jf(this._delegate,function(...e){return ng._create("endBefore",e,!1)}(...e)))}catch(e){throw Ug(e,"endBefore()","Query.endBefore()")}}endAt(...e){try{return new $g(this.firestore,Jf(this._delegate,function(...e){return ng._create("endAt",e,!0)}(...e)))}catch(e){throw Ug(e,"endAt()","Query.endAt()")}}isEqual(e){return Wd(this._delegate,e._delegate)}get(e){let t;return t=("cache"===(null==e?void 0:e.source)?yg:"server"===(null==e?void 0:e.source)?function(t){t=Vd(t,zd);const n=Vd(t.firestore,sf),e=af(n),r=new mg(n);return Ad(e,t._query,{source:"server"}).then(e=>new fg(n,r,t,e))}:function(t){t=Vd(t,zd);const n=Vd(t.firestore,sf),e=af(n),r=new mg(n);return Qf(t._query),Ad(e,t._query).then(e=>new fg(n,r,t,e))})(this._delegate),t.then(e=>new Hg(this.firestore,new fg(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)))}onSnapshot(...e){var t=jg(e),n=zg(e,e=>new Hg(this.firestore,new fg(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)));return _g(this._delegate,t,n)}withConverter(e){return new $g(this.firestore,e?this._delegate.withConverter(Bg.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}class Qg{constructor(e,t){this._firestore=e,this._delegate=t}get type(){return this._delegate.type}get doc(){return new Kg(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}}class Hg{constructor(e,t){this._firestore=e,this._delegate=t}get query(){return new $g(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(e=>new Kg(this._firestore,e))}docChanges(e){return this._delegate.docChanges(e).map(e=>new Qg(this._firestore,e))}forEach(t,n){this._delegate.forEach(e=>{t.call(n,new Kg(this._firestore,e))})}isEqual(e){return gg(this._delegate,e._delegate)}}class Wg extends $g{constructor(e,t){super(e,t),this.firestore=e,this._delegate=t}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){var e=this._delegate.parent;return e?new qg(this.firestore,e):null}doc(e){try{return void 0===e?new qg(this.firestore,Qd(this._delegate)):new qg(this.firestore,Qd(this._delegate,e))}catch(e){throw Ug(e,"doc()","CollectionReference.doc()")}}add(e){return function(e,t){const n=Vd(e.firestore,sf),r=Qd(e),i=ug(e.converter,t);return Ig(n,[Sf(Tf(e.firestore),"addDoc",r._key,i,null!==e.converter,{}).toMutation(r._key,wo.exists(!1))]).then(()=>r)}(this._delegate,e).then(e=>new qg(this.firestore,e))}isEqual(e){return Hd(this._delegate,e._delegate)}withConverter(e){return new Wg(this.firestore,e?this._delegate.withConverter(Bg.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function Jg(e){return Vd(e,Gd)}const Yg={Firestore:Fg,GeoPoint:yf,Timestamp:si,Blob:Rg,Transaction:Pg,WriteBatch:Vg,DocumentReference:qg,DocumentSnapshot:Gg,Query:$g,QueryDocumentSnapshot:Kg,QuerySnapshot:Hg,CollectionReference:Wg,FieldPath:class Xg{constructor(...e){this._delegate=new mf(...e)}static documentId(){return new Xg(hi.keyField().canonicalString())}isEqual(e){return(e=y(e))instanceof mf&&this._delegate._internalPath.isEqual(e._internalPath)}},FieldValue:class Zg{constructor(e){this._delegate=e}static serverTimestamp(){const e=new Cf("serverTimestamp");return e._methodName="FieldValue.serverTimestamp",new Zg(e)}static delete(){const e=new xf("deleteField");return e._methodName="FieldValue.delete",new Zg(e)}static arrayUnion(...e){const t=function(...e){return new Af("arrayUnion",e)}(...e);return t._methodName="FieldValue.arrayUnion",new Zg(t)}static arrayRemove(...e){const t=function(...e){return new Nf("arrayRemove",e)}(...e);return t._methodName="FieldValue.arrayRemove",new Zg(t)}static increment(e){const t=new kf("increment",e);return t._methodName="FieldValue.increment",new Zg(t)}isEqual(e){return this._delegate.isEqual(e._delegate)}},setLogLevel:function(e){e=e,Or.setLogLevel(e)},CACHE_SIZE_UNLIMITED:-1};nf=t.default,rf=(e,t)=>new Fg(e,t,new Lg),nf.INTERNAL.registerComponent(new v("firestore-compat",e=>{var t=e.getProvider("app-compat").getImmediate(),n=e.getProvider("firestore").getImmediate();return rf(t,n)},"PUBLIC").setServiceProps(Object.assign({},Yg))),nf.registerVersion("@firebase/firestore-compat","0.3.30")}).apply(this,arguments)}catch(e){throw console.error(e),new Error("Cannot instantiate firebase-firestore-compat.js - be sure to load firebase-app.js first.")}});
//# sourceMappingURL=firebase-firestore-compat.js.map
